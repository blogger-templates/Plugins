
  /**
   * ====================================================================
   * UTILITIES & GLOBAL FUNCTIONS
   * ====================================================================
   */

  // Move sidebar content on specific post pages if needed
  function movePostPageSidebar() {
    if ($("body").find(".item-post").length) {
      let widgets = $("#post-page-sidebar .widget");
      if (widgets.length) {
        widgets.appendTo("#post-page-sidebar-content");
      }
    }
  }

  // Global Remove from History (accessed by UI buttons)
  window.removeFromHistory = function(id) {
    if (!id) return;
    let history = JSON.parse(localStorage.getItem("watchHistoryIDs") || "[]");
    history = history.filter(item => String(item) !== String(id));
    localStorage.setItem("watchHistoryIDs", JSON.stringify(history));

    let uiItem = document.getElementById("history-item-" + id);
    if (uiItem) uiItem.remove();

    let list = document.getElementById("history-items-list");
    if (list && list.children.length === 0) {
      let emptyMsg = document.getElementById("history-empty-message");
      if (emptyMsg) emptyMsg.style.display = "block";
    }

    if (typeof window.updateHistoryBadge === "function") {
      window.updateHistoryBadge();
    }
  };

  /**
   * ====================================================================
   * COMMENT SYSTEM UTILITIES
   * Handles bold, italic, code blocks, and the custom Q&A format.
   * ====================================================================
   */
  const CommentUtils = {
    parse: function(btn) {
      let textarea = document.getElementById("cmn-parse-area");
      let copyBtn = document.getElementById("cmn-copy-btn");
      if (!textarea) return;

      let type = btn.getAttribute("data-text");
      let rawText = textarea.value.trim();

      if (!rawText) {
        alert("Please enter some text or a URL first.");
        return;
      }

      // Basic HTML escaping
      let safeText = rawText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      let result = "";

      switch (type) {
        case "bold":
          result = "<b>" + safeText + "</b>";
          break;
        case "italic":
          result = "<i>" + safeText + "</i>";
          break;
        case "quote":
          result = "[quote]" + safeText + "[/quote]";
          break;
        case "tag":
          result = "[tag]" + safeText + "[/tag]";
          break;
        case "pre":
          result = "[pre]" + safeText + "[/pre]";
          break;
        case "code":
          result = "[code]" + safeText + "[/code]";
          break;
        case "qa":
          let parts = safeText.split(";");
          if (parts.length < 2) {
            alert("Please use the format:\nQuestion; Option 1; Option 2 (optional)");
            textarea.value = "Your Question; Option 1; Option 2";
            return;
          }
          result = "[QA]" + parts[0].trim() + "[OPT]" + parts.slice(1).map(p => p.trim()).join("[OPT]") + "[/QA]";
          break;
        default:
          result = safeText;
      }

      textarea.value = result;
      if (copyBtn) copyBtn.classList.remove("hidden");
    },

    copy: function() {
      let textarea = document.getElementById("cmn-parse-area");
      if (textarea && textarea.value) {
        navigator.clipboard.writeText(textarea.value).then(() => {
          let msg = document.getElementById("cmn-copied-msg");
          if (msg) {
            msg.classList.remove("hidden");
            setTimeout(() => {
              msg.classList.add("hidden");
            }, 2000);
          }
        });
      }
    },

    clear: function() {
      let textarea = document.getElementById("cmn-parse-area");
      let copyBtn = document.getElementById("cmn-copy-btn");
      if (textarea) textarea.value = "";
      if (copyBtn) copyBtn.classList.add("hidden");
    }
  };

  // Helper to transform custom tags [QA], [code] into HTML
  function transformCommentTags() {
    document.querySelectorAll(".comment-content:not(.tags-transformed)").forEach(contentDiv => {
      let html = contentDiv.innerHTML;

      // 1. Transform Q&A / Polls
      if (html.includes("[QA]")) {
        html = html.replace(/\[QA\](.*?)\[\/QA\]/g, (match, inner) => {
          let parts = inner.split("[OPT]");
          let question = parts[0];
          let options = parts.slice(1);

          let parentComment = contentDiv.closest(".comment");
          let qaId = parentComment ? "qa-source-" + parentComment.id : "";
          if (parentComment) parentComment.setAttribute("data-qa-id", qaId);

          let replyText = "Join the discussion...";
          if (parentComment) {
            let replies = parentComment.querySelector(".comment-replies");
            if (replies) {
              let count = replies.querySelectorAll("li.comment").length;
              if (count > 0) {
                let formattedCount = count >= 1000 ? (count / 1000).toFixed(1).replace(/\.0$/, "") + "K" : count;
                replyText = formattedCount + " replies and discussion";
              }
            }
          }

          let optionsHtml = options.map(opt => `<span class="qa-option">${opt.trim()}</span>`).join("");

          return `
            <div class="qa-card" data-qa-id="${qaId}">
              <div class="qa-title"><span class="qa-icon">#</span>${question.trim()}</div>
              <div class="qa-options">${optionsHtml}</div>
              <a class="qa-footer" href="javascript:void(0)">
                <svg class="qa-stats-icon" viewBox="0 0 24 24" fill="currentColor" width="12" height="12">
                   <g><rect x="4" y="10" width="4" height="10" rx="1"></rect><rect x="10" y="4" width="4" height="16" rx="1"></rect><rect x="16" y="6" width="4" height="14" rx="1"></rect></g>
                </svg>
                <span>${replyText}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 4px; font-weight: bold;"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
              </a>
            </div>`;
        });
      }

      // 2. Transform Code Blocks
      const formatCode = (code, isBlock) => {
        let decoded = code.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&").replace(/<br\s*\/?>/gi, "\n");
        let safeCode = decoded.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        let id = "copied-msg-" + Math.random().toString(36).substr(2, 9);

        if (!isBlock) return `<code class="comment-inline-code hljs">${safeCode}</code>`;

        return `
          <div class="comment-code-wrapper">
            <pre><code class="hljs">${safeCode}</code></pre>
            <button class="copy-code-btn" title="Copy code" onclick="navigator.clipboard.writeText(this.previousElementSibling.querySelector('code').textContent).then(() => { const msg = document.getElementById('${id}'); msg.classList.add('show'); setTimeout(() => msg.classList.remove('show'), 2000); });">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M16.9637 8.98209C16.9613 6.03194 16.9167 4.50384 16.0578 3.45753C14.4008 1.99854 12.7609 1.99854 9.48087 1.99854C6.20089 1.99854 4.5609 1.99854 3.45708 2.90436C1.99799 4.56128 1.99799 6.20116 1.99799 9.48091C1.99799 12.7607 1.99799 14.4005 2.90387 15.5043C4.50346 16.9162 6.03167 16.9608 8.98201 16.9632" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M14.0283 9.02455L16.994 8.98193M14.0143 22.0013L16.9799 21.9586M21.9716 14.0221L21.9436 16.9818M9.01033 14.0357L8.98236 16.9953M11.4873 9.02455C10.6545 9.17371 9.31781 9.32713 9.01033 11.0488M19.4946 21.9586C20.3296 21.8223 21.6685 21.6894 22.0025 19.9726M19.4946 9.02455C20.3274 9.17371 21.6641 9.32713 21.9716 11.0488M11.5 21.9573C10.6672 21.8086 9.33039 21.6559 9.02197 19.9344" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <span class="code-copied-msg" id="${id}">Copied!</span>
          </div>`;
      };

      html = html.replace(/\[pre\]([\s\S]*?)\[\/pre\]/g, (m, c) => formatCode(c, true));
      html = html.replace(/\[code\]([\s\S]*?)\[\/code\]/g, (m, c) => formatCode(c, false));
      html = html.replace(/\[quote\]([\s\S]*?)\[\/quote\]/g, "<blockquote>$1</blockquote>");
      html = html.replace(/\[tag\]([\s\S]*?)\[\/tag\]/g, '<b class="comment-tag">@$1</b>');

      contentDiv.innerHTML = html;
      contentDiv.classList.add("tags-transformed");

      // Initialize Highlight.js
      if (typeof hljs !== "undefined") {
        contentDiv.querySelectorAll("pre code.hljs").forEach(block => {
          hljs.highlightElement(block);
          if (typeof hljs.lineNumbersBlock === "function") {
            hljs.lineNumbersBlock(block);
          }
        });
      }
    });
  }

  /**
   * ====================================================================
   * MOBILE SEARCH
   * ====================================================================
   */
  function initMobileSearch() {
    let modal = document.getElementById("mobile-search-modal");
    if (!modal) return;

    let triggers = document.querySelectorAll(".mobile-search-input, .mobile-search-button");
    let backBtn = document.getElementById("ms-back-btn");
    let input = document.getElementById("ms-input");
    let form = document.getElementById("ms-form");
    let defaultView = document.getElementById("ms-default-view");
    let resultsView = document.getElementById("ms-results-view");
    let historyContainer = document.getElementById("ms-history-container");
    let popularContainer = document.getElementById("ms-popular-container");
    let storageKey = "abefilmSearchHistory";
    let searchTimeout;

    const openModal = () => {
      modal.classList.add("active");
      document.body.classList.add("ms-modal-open");
      input.focus();
      renderDefault();
    };

    const closeModal = () => {
      modal.classList.remove("active");
      document.body.classList.remove("ms-modal-open");
      input.value = "";
      showDefault();
    };

    const getHistory = () => JSON.parse(localStorage.getItem(storageKey) || "[]");

    const saveHistory = (term) => {
      if (!term || !term.trim()) return;
      let history = getHistory().filter(t => t.toLowerCase() !== term.toLowerCase());
      history.unshift(term);
      if (history.length > 3) history.pop();
      localStorage.setItem(storageKey, JSON.stringify(history));
    };

    const deleteHistoryItem = (term) => {
      let history = getHistory().filter(t => t.toLowerCase() !== term.toLowerCase());
      localStorage.setItem(storageKey, JSON.stringify(history));
      renderHistory();
    };

    const clearHistory = () => {
      localStorage.removeItem(storageKey);
      renderHistory();
    };

    const renderHistory = () => {
      let history = getHistory();
      if (history.length === 0) {
        historyContainer.innerHTML = "";
        return;
      }
      let html = `
        <div class="ms-section-title ms-history-header">
            <span>Search History</span>
            <button class="clear-btn">Clear All</button>
        </div>
        <ul>`;
      history.forEach(term => {
        html += `
            <li>
                <a href="/search?q=${encodeURIComponent(term)}">${term}</a>
                <button class="delete-item-btn" data-term="${term}">&times;</button>
            </li>`;
      });
      html += "</ul>";
      historyContainer.innerHTML = html;
    };

    const renderPopular = () => {
      popularContainer.innerHTML = `
        <div class="ms-section-title ms-popular-header">
            <span>ðŸ”¥ Latest Posts</span>
        </div>
        <div class="ms-loader">Loading...</div>`;

      fetch("/feeds/posts/default?alt=json&max-results=8&orderby=published")
        .then(res => res.json())
        .then(data => {
          if (!data.feed || !data.feed.entry || data.feed.entry.length === 0) {
            popularContainer.innerHTML = "";
            return;
          }
          let html = `
            <div class="ms-section-title ms-popular-header">
                <span>ðŸ”¥ Latest Posts</span>
            </div>
            <ul>`;
          data.feed.entry.forEach((entry, index) => {
            let link = entry.link.find(l => l.rel === "alternate").href;
            html += `
                <li>
                    <span class="rank-number ${index < 3 ? 'top-3' : ''}">${index + 1}</span>
                    <a href="${link}">${entry.title.$t}</a>
                </li>`;
          });
          html += "</ul>";
          popularContainer.innerHTML = html;
        })
        .catch(err => {
          console.error(err);
          popularContainer.innerHTML = "";
        });
    };

    const renderDefault = () => {
      renderHistory();
      renderPopular();
    };

    const showDefault = () => {
      defaultView.style.display = "block";
      resultsView.style.display = "none";
    };

    const showResults = () => {
      defaultView.style.display = "none";
      resultsView.style.display = "block";
    };

    const performSearch = (query) => {
      showResults();
      resultsView.innerHTML = '<div class="ms-loader">Searching...</div>';

      fetch("/feeds/posts/default?alt=json&q=" + encodeURIComponent(query) + "&max-results=10")
        .then(res => res.json())
        .then(data => {
          if (!data.feed || !data.feed.entry || data.feed.entry.length === 0) {
            resultsView.innerHTML = '<div class="ms-no-results">No results found.</div>';
            return;
          }

          // Fetch thumbnails concurrently
          let promises = data.feed.entry.map(entry => {
            let link = entry.link.find(l => l.rel === "alternate").href;
            return fetch(link).then(res => res.text()).then(html => {
              let doc = new DOMParser().parseFromString(html, "text/html");
              let img = doc.querySelector('img[alt="poster"]')?.src || "https://resources.blogblog.com/img/blank.gif";
              let year = doc.querySelector("#extra-meta .meta-year")?.textContent.trim() || "";
              let type = doc.querySelector("#extra-meta .meta-type")?.textContent.trim() || "";
              return {
                title: entry.title.$t,
                url: link,
                imageUrl: img,
                year,
                type
              };
            }).catch(() => null);
          });

          Promise.all(promises).then(results => {
            let validResults = results.filter(Boolean);
            if (validResults.length === 0) {
              resultsView.innerHTML = '<div class="ms-no-results">No results found.</div>';
              return;
            }
            let html = "<ul>";
            validResults.forEach(item => {
              html += `
                <li>
                    <a href="${item.url}">
                        <img class="result-thumb" src="${item.imageUrl}" alt="${item.title}" loading="lazy"/>
                        <div class="result-info">
                            <h3 class="title">${item.title}</h3>
                            <p class="meta">${item.year} ${(item.year && item.type ? ' Â· ' : '')} ${item.type}</p>
                        </div>
                    </a>
                </li>`;
            });
            html += "</ul>";
            resultsView.innerHTML = html;

            // Save history on click
            resultsView.addEventListener("click", (e) => {
              if (e.target.closest("a")) {
                saveHistory(input.value.trim());
              }
            });
          });
        })
        .catch(() => {
          resultsView.innerHTML = '<div class="ms-no-results">An error occurred.</div>';
        });
    };

    triggers.forEach(t => {
      t.addEventListener("click", (e) => {
        e.preventDefault();
        openModal();
      });
      t.addEventListener("focus", (e) => {
        e.preventDefault();
        e.target.blur();
        openModal();
      });
    });

    backBtn.addEventListener("click", closeModal);

    input.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      let val = input.value.trim();
      if (val.length > 1) {
        searchTimeout = setTimeout(() => performSearch(val), 300);
      } else {
        showDefault();
      }
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      let val = input.value.trim();
      if (val) {
        saveHistory(val);
        window.location.href = "/search?q=" + encodeURIComponent(val);
      }
    });

    historyContainer.addEventListener("click", (e) => {
      if (e.target.classList.contains("delete-item-btn")) {
        deleteHistoryItem(e.target.dataset.term);
      } else if (e.target.classList.contains("clear-btn")) {
        clearHistory();
      }
    });

    // Bottom nav trigger
    let bottomTrigger = document.getElementById("bottom-nav-search-trigger");
    if (bottomTrigger) {
      bottomTrigger.addEventListener("click", (e) => {
        e.preventDefault();
        openModal();
      });
    }
  }

  /**
   * ====================================================================
   * DOM READY EVENT LISTENER - MAIN LOGIC
   * ====================================================================
   */
  document.addEventListener("DOMContentLoaded", function() {
    initMobileSearch();

    // 1. Mobile Layout Logic (Moving elements around)
    let isMobile = window.innerWidth <= 767;
    let postContainer = document.querySelector(".post-page-final-container");

    if (isMobile && postContainer) {
      document.body.classList.add("item-view");
      let recSection = document.querySelector(".recommendation-section");
      let commentsSection = document.querySelector(".abefilm-blog-post-comments");
      let reactionTitle = document.querySelector(".mobile-reaction-title");
      let reactionContainer = document.querySelector(".reaction-container");
      let reviewSystem = document.querySelector(".review-system-container");
      let videoTab = document.getElementById("video-tab-content");
      let commentTab = document.getElementById("comment-tab-content");

      if (recSection && videoTab) videoTab.appendChild(recSection);
      if (commentTab) {
        if (reactionTitle) commentTab.appendChild(reactionTitle);
        if (reactionContainer) commentTab.appendChild(reactionContainer);
        if (reviewSystem) commentTab.appendChild(reviewSystem);
        if (commentsSection) commentTab.appendChild(commentsSection);
      }

      // Mobile Tabs Logic
      let tabBtns = document.querySelectorAll(".mobile-tab-btn");
      let tabPanels = document.querySelectorAll(".mobile-tab-panel");
      if (tabBtns.length > 0 && tabPanels.length > 0) {
        tabBtns.forEach(btn => {
          btn.addEventListener("click", function() {
            let target = btn.getAttribute("data-tab-target");
            let panel = document.querySelector(target);
            if (panel) {
              tabBtns.forEach(b => b.classList.remove("active"));
              tabPanels.forEach(p => p.classList.remove("active"));
              btn.classList.add("active");
              panel.classList.add("active");
              document.body.classList.toggle("comment-tab-active", target === "#comment-tab-content");
            }
          });
        });
      }

      // Mobile Cast Carousel
      let celebrityData = document.querySelector("#celebrity-data");
      if (celebrityData && videoTab) {
        let items = celebrityData.querySelectorAll("li");
        if (items.length > 0) {
          let castDiv = document.createElement("div");
          castDiv.className = "section-final mobile-celebrity-section";
          castDiv.innerHTML = `<h3>Cast</h3><div class="celebrity-carousel-mobile"></div>`;
          let carousel = castDiv.querySelector(".celebrity-carousel-mobile");
          items.forEach(li => {
            let img = li.querySelector("img")?.src || "";
            let name = li.querySelector("span")?.textContent || "";
            carousel.innerHTML += `
              <div class="celebrity-item-mobile">
                <img src="${img}" alt="${name}" loading="lazy"/>
                <span class="name">${name}</span>
              </div>`;
          });
          let ref = videoTab.querySelector(".recommendation-section");
          ref ? videoTab.insertBefore(castDiv, ref) : videoTab.appendChild(castDiv);
        }
      }

      // Move sidebar ad
      let sidebarAd = document.querySelector("#post-page-sidebar #HTML8");
      if (sidebarAd && videoTab) {
        let ref = videoTab.querySelector(".recommendation-section");
        ref ? videoTab.insertBefore(sidebarAd, ref) : videoTab.appendChild(sidebarAd);
      }
    }

    // 2. Mobile Comment Form & Sticky Logic
    if (isMobile && postContainer) {
      let trigger = document.getElementById("mobile-comment-trigger");
      if (trigger) {
        let discussBtn = trigger.querySelector(".trigger-discussion-link");
        let rateBtn = trigger.querySelector(".trigger-rating-link");
        let closeBtn = document.getElementById("close-comment-form");

        if (discussBtn && closeBtn) {
          discussBtn.addEventListener("click", (e) => {
            e.preventDefault();
            document.body.classList.add("comment-form-active");
          });
          closeBtn.addEventListener("click", () => {
            document.body.classList.remove("comment-form-active");
          });
        }
        if (rateBtn) {
          rateBtn.addEventListener("click", (e) => {
            e.preventDefault();
            document.getElementById("review-system")?.scrollIntoView({
              behavior: "smooth",
              block: "center"
            });
          });
        }
      }
    }

    if (isMobile && document.body.classList.contains("item-view")) {
      let playerCol = document.querySelector(".player-column-final");
      let form = document.querySelector(".comment-form");
      if (playerCol && form) {
        const adjust = () => {
          form.style.top = playerCol.offsetHeight + "px";
        };
        adjust();
        window.addEventListener("resize", adjust);
      }
    }

    // 3. Comment Helper & Formatting
    let helper = document.getElementById("comment-helper");
    let commentsDiv = document.getElementById("comments");
    if (helper && commentsDiv) {
      let observer = new MutationObserver(mutations => {
        for (let m of mutations) {
          for (let node of m.addedNodes) {
            if (node.nodeType === 1 && node.id === "comment-editor") {
              if (node.parentNode) node.parentNode.insertBefore(helper, node);
              return;
            }
          }
        }
      });
      observer.observe(commentsDiv, {
        childList: true,
        subtree: true
      });
    }

    let sortSelect = document.getElementById("sort-select");
    let sortContainer = document.getElementById("top-ra");
    if (sortSelect && sortContainer) {
      sortSelect.addEventListener("change", function() {
        sortContainer.style.flexDirection = this.value === "newest" ? "column-reverse" : "column";
      });
    }

    // Format interval for dynamically loaded comments
    let formatInt = setInterval(() => {
      let topCe = document.getElementById("top-ce");
      let form = document.querySelector(".comments .comment-form");
      if (topCe && form) {
        form.appendChild(topCe);
        clearInterval(formatInt);
      }
    }, 100);
    setTimeout(() => clearInterval(formatInt), 10000);
    transformCommentTags();

    // Formatting Badge Count
    let badge = document.querySelector(".comment-count-badge");
    if (badge) {
      try {
        let val = parseInt(badge.textContent, 10);
        if (!isNaN(val)) {
          if (val >= 1000) {
            badge.textContent = (val / 1000).toFixed(1).replace(".0", "") + "k";
          } else if (val === 0) {
            badge.style.display = "none";
          }
        }
      } catch (e) {}
    }

    // 4. Supabase Logic (Ratings & Reactions)
    const SUPABASE_URL = "https://agfwyfwsnqnklgcgemnw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZnd5ZndzbnFua2xnY2dlbW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTQ3MTQsImV4cCI6MjA3Mjc5MDcxNH0.NBWiC0YzG8zDhijQ17j49xVXUyLJYXlMJKJkfFJg5yg";

    if (typeof supabase === "undefined" || !SUPABASE_URL.startsWith("http")) {
      console.warn("Supabase client not loaded.");
      return;
    }

    const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // -- Ratings Logic --
    (() => {
      let reviewData = document.getElementById("post-review-data");
      if (!reviewData) return;

      // Inject popup HTML if missing
      if (!document.getElementById("rating-feedback-popup")) {
        let pop = document.createElement("div");
        pop.id = "rating-feedback-popup";
        pop.className = "rating-feedback-container";
        pop.innerHTML = '<div class="feedback-content"><h3 class="popup-text">You rated</h3><div class="popup-stars" id="popup-stars-content"></div></div>';
        document.body.appendChild(pop);
      }

      let postId = reviewData.getAttribute("data-post-id");
      let storageKey = "sb_rated_" + postId;
      let wrapper = document.getElementById("review-summary-wrapper");
      let currentSummary = null;

      let clientId = localStorage.getItem("supabase_client_id");
      if (!clientId) {
        clientId = self.crypto.randomUUID();
        localStorage.setItem("supabase_client_id", clientId);
      }

      const formatK = (n) => n >= 1000 ? (n / 1000).toFixed(n % 1000 != 0 ? 1 : 0) + "K" : n;

      const updateShortcut = () => {
        let el = document.getElementById("rating-shortcut-text");
        if (el) el.textContent = localStorage.getItem(storageKey) !== null ? "My rating" : "Rate now";
      };

      const render = (data) => {
        currentSummary = data;
        let userRate = localStorage.getItem(storageKey);
        let hasRated = userRate !== null;
        let counts = data?.rating_counts || {
          "1": 0,
          "2": 0,
          "3": 0,
          "4": 0,
          "5": 0
        };
        let total = data?.total_ratings || 0;
        let avg = data?.average_rating || 0;

        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += `<span class="star ${i <= Math.round(avg) ? 'filled' : ''}" data-value="${i}">&#9733;</span>`;
        }

        let bars = "";
        for (let i = 5; i >= 1; i--) {
          let c = counts[String(i)] || 0;
          let pct = total > 0 ? (c / total) * 100 : 0;
          bars += `<div class="breakdown-row"><span>${i}.0</span><div class="progress-bar-container"><div class="progress-bar" style="width:${pct}%;"></div></div><span class="review-count">${c} reviews</span></div>`;
        }

        wrapper.innerHTML = `<div class="review-summary-left"><div class="average-rating-score">${avg.toFixed(1)}</div><div><div class="average-rating-stars ${hasRated ? 'rated' : ''}" id="interactive-stars">${stars}</div><div class="total-ratings">${formatK(total)} ratings</div></div></div><div class="review-summary-right">${bars}</div>`;

        let userContainer = document.getElementById("user-rating-display-container");
        if (!userContainer) {
          userContainer = document.createElement("div");
          userContainer.id = "user-rating-display-container";
          wrapper.after(userContainer);
        }

        if (hasRated) {
          let val = parseInt(userRate, 10);
          let uStars = "";
          for (let i = 1; i <= 5; i++) uStars += i <= val ? '<span class="star filled">&#9733;</span>' : '<span class="star">&#9734;</span>';
          userContainer.innerHTML = `<div class="user-rating-display"><span>You rated:</span><div>${uStars}</div></div>`;
        } else {
          userContainer.innerHTML = "";
        }
      };

      const fetchRate = async () => {
        let {
          data,
          error
        } = await sbClient.from("review_summaries").select("*").eq("post_id", postId).single();
        if (error && error.code !== "PGRST116") console.error("Supabase Error:", error);
        render(data);
        updateShortcut();
      };

      const showPopup = (val) => {
        let pop = document.getElementById("rating-feedback-popup");
        let content = pop.querySelector(".feedback-content");
        let starsCont = document.getElementById("popup-stars-content");
        if (pop && starsCont) {
          content.querySelectorAll(".sparkle").forEach(e => e.remove());
          starsCont.innerHTML = Array.from({
            length: 5
          }, (_, i) => i < val ? '<span class="star-filled">&#9733;</span>' : '<span class="star-empty">&#9734;</span>').join("");
          for (let i = 0; i < 12; i++) {
            let s = document.createElement("div");
            s.className = "sparkle";
            let deg = 360 * Math.random(),
              dist = 80 * Math.random() + 60;
            s.style.setProperty("--sparkle-transform-end", `translate(${Math.cos(deg*Math.PI/180)*dist}px, ${Math.sin(deg*Math.PI/180)*dist}px)`);
            s.style.animationDelay = .3 * Math.random() + "s";
            content.appendChild(s);
          }
          pop.classList.add("show");
          setTimeout(() => pop.classList.remove("show"), 2500);
        }
      };

      const submitRate = async (val) => {
        if (localStorage.getItem(storageKey) !== null) return;
        showPopup(val);
        localStorage.setItem(storageKey, val);
        updateShortcut();

        // Optimistic update
        let defCounts = {
          "1": 0,
          "2": 0,
          "3": 0,
          "4": 0,
          "5": 0
        };
        let t = currentSummary?.total_ratings || 0;
        let a = currentSummary?.average_rating || 0;
        let c = currentSummary?.rating_counts || defCounts;
        let sum = a * t;
        let newTotal = t + 1;
        let newAvg = (sum + val) / newTotal;
        let newCounts = { ...c,
          [String(val)]: (c[String(val)] || 0) + 1
        };

        render({
          total_ratings: newTotal,
          average_rating: newAvg,
          rating_counts: newCounts
        });

        let {
          error
        } = await sbClient.from("reviews").insert({
          post_id: postId,
          rating: val,
          client_id: clientId
        });
        if (error) {
          console.error(error);
          localStorage.removeItem(storageKey);
          fetchRate();
        }
      };

      wrapper.addEventListener("click", e => {
        let star = e.target.closest(".star");
        let parent = e.target.closest(".average-rating-stars");
        if (star && parent && !parent.classList.contains("rated")) {
          submitRate(parseInt(star.dataset.value));
        }
      });

      fetchRate();
    })();

    // -- Reactions Logic --
    (() => {
      let el = document.getElementById("post-review-data") || document.getElementById("post-id");
      let container = document.getElementById("reaction-container");
      if (!el || !container) return;

      let postId = el.getAttribute("data-post-id");
      if (!postId) return;

      let storageKey = "sb_reacted_" + postId;
      let types = [{
        type: "like",
        label: "Upvote",
        icon: "\uD83D\uDC4D"
      }, {
        type: "love",
        label: "Love",
        icon: "\uD83D\uDE0D"
      }, {
        type: "haha",
        label: "Funny",
        icon: "\uD83D\uDE06"
      }, {
        type: "wow",
        label: "Surprised",
        icon: "\uD83D\uDE32"
      }, {
        type: "sad",
        label: "Sad",
        icon: "\uD83D\uDE22"
      }, {
        type: "angry",
        label: "Angry",
        icon: "\uD83D\uDE24"
      }];

      let clientId = localStorage.getItem("supabase_client_id");
      if (!clientId) {
        clientId = self.crypto.randomUUID();
        localStorage.setItem("supabase_client_id", clientId);
      }

      let counts = {},
        userReaction = null;

      const render = (c, u) => {
        container.innerHTML = types.map(t => {
          let count = c?.[t.type] || 0;
          return `<button class="reaction-btn ${u === t.type ? 'selected' : ''}" data-reaction="${t.type}">
            <div class="reaction-icon-wrapper">
                <span class="reaction-icon">${t.icon}</span>
                <span class="reaction-count">${count > 0 ? count : ""}</span>
            </div>
            <span class="reaction-label">${t.label}</span>
          </button>`;
        }).join("");
      };

      const load = async () => {
        try {
          let [sRes, rRes] = await Promise.all([
            sbClient.from("reaction_summaries").select("counts").eq("post_id", postId).single(),
            sbClient.from("reactions").select("reaction_type").eq("post_id", postId).eq("client_id", clientId).single()
          ]);
          counts = sRes.data?.counts || {};
          userReaction = rRes.data?.reaction_type || null;
          if (userReaction) localStorage.setItem(storageKey, userReaction);
          else localStorage.removeItem(storageKey);
          render(counts, userReaction);
        } catch (e) {
          console.error(e);
        }
      };

      const toggle = async (type) => {
        let prev = userReaction;
        if (prev === type) {
          if (counts[prev]) counts[prev]--;
          userReaction = null;
          localStorage.removeItem(storageKey);
        } else {
          if (prev && counts[prev]) counts[prev]--;
          userReaction = type;
          localStorage.setItem(storageKey, type);
          counts[type] = (counts[type] || 0) + 1;
        }
        render(counts, userReaction);

        try {
          if (prev === type) await sbClient.from("reactions").delete().match({
            post_id: postId,
            client_id: clientId
          });
          else await sbClient.from("reactions").upsert({
            post_id: postId,
            client_id: clientId,
            reaction_type: type
          }, {
            onConflict: "post_id, client_id"
          });
        } catch (e) {
          console.error(e);
          await load();
        }
      };

      container.addEventListener("click", e => {
        let btn = e.target.closest(".reaction-btn");
        if (btn) toggle(btn.dataset.reaction);
      });

      load();
    })();
  });

  /**
   * ====================================================================
   * CUSTOM PLAYER & EPISODE LOGIC
   * ====================================================================
   */
  document.addEventListener("DOMContentLoaded", function() {
    let body = document.body;
    let sidebarToggle = document.getElementById("sidebarToggle");

    // Sidebar transition fix
    setTimeout(() => {
      body.classList.remove("no-transition");
    }, 100);

    if (sidebarToggle) {
      sidebarToggle.addEventListener("click", () => {
        body.classList.toggle("sidebar-collapsed");
        let state = body.classList.contains("sidebar-collapsed") ? "collapsed" : "expanded";
        localStorage.setItem("sidebarState", state);
        setTimeout(function() {
          if (typeof $ !== "undefined") {
            $("#dynamic-main-slider, #PopularPosts1 .owl-carousel").trigger("refresh.owl.carousel");
          }
        }, 350);
      });
    }

    // Sidebar active class based on URL
    let path = window.location.pathname;
    let navLinks = document.querySelectorAll(".sidebar-nav a");
    let activeLink = null;
    let maxMatch = -1;

    navLinks.forEach(link => {
      let href = link.getAttribute("href");
      if (href && !href.startsWith("#")) {
        try {
          let linkPath = new URL(link.href).pathname;
          if (path === "/" && linkPath === "/") {
            activeLink = link;
            maxMatch = 1;
          } else if (linkPath !== "/" && path.startsWith(linkPath) && linkPath.length > maxMatch) {
            maxMatch = linkPath.length;
            activeLink = link;
          }
        } catch (e) {}
      }
    });

    if (activeLink) {
      navLinks.forEach(l => l.parentElement.classList.remove("active"));
      activeLink.parentElement.classList.add("active");
    }

    // Clear Cache Button
    let clearCacheBtn = document.querySelector('a[href="#clear-cache"]');
    if (clearCacheBtn) {
      clearCacheBtn.addEventListener("click", function(e) {
        e.preventDefault();
        if (confirm("This will clear cached data. Continue?")) {
          localStorage.clear();
          sessionStorage.clear();
          alert("Cache cleared. The page will now reload.");
          window.location.reload(true);
        }
      });
    }

    // Prevent double execution
    if (document.body.classList.contains("final-layout-script-loaded")) return;
    document.body.classList.add("final-layout-script-loaded");

    // --- MAIN POST LOGIC ---
    let postFinalContainer = document.querySelector(".post-page-final-container");
    if (postFinalContainer) {
      try {
        let sourceContainer = document.querySelector("#source-data-container");
        if (!sourceContainer) throw new Error("Source data container not found.");

        let postBody = sourceContainer.querySelector(".post-body");
        if (!postBody) throw new Error("Post body not found.");

        let getTitle = () => sourceContainer.querySelector(".entry-title")?.textContent.trim() || "";
        let getText = (sel) => postBody.querySelector(sel)?.textContent.trim() || "";

        let posterSrc = postBody.querySelector('img[alt="poster"]')?.getAttribute("src") || "";
        let backdrop = getText("span.slider-backdrop");
        let rating = getText("#extra-meta .meta-rating");
        let year = getText("#extra-meta .meta-year");
        let pg = getText("#extra-meta .meta-pg");
        let status = getText("#extra-meta .meta-status");
        let country = getText("#extra-meta .meta-country");
        let genres = Array.from(postBody.querySelectorAll("#extra-meta .meta-genre")).map(el => el.textContent.trim());

        // Setup "Add to Watchlist" button metadata
        let watchBtn = postFinalContainer.querySelector("#add-to-watchlist-btn");
        if (watchBtn) {
          let pid = new URL(window.location.href).pathname;
          let ptitle = getTitle();
          let purl = window.location.href;
          let pimage = backdrop || posterSrc;
          watchBtn.setAttribute("data-post-id", pid);
          watchBtn.setAttribute("data-post-title", ptitle);
          watchBtn.setAttribute("data-post-url", purl);
          watchBtn.setAttribute("data-post-image", pimage);
          $(document).trigger("abefilm:postDataReady", [{
            id: pid,
            title: ptitle,
            url: purl,
            image: pimage
          }]);
        }

        // Render Header
        let headers = postFinalContainer.querySelectorAll(".details-header-final");
        headers.forEach(header => {
          header.querySelector(".poster-final img").src = posterSrc;
          header.querySelector(".title-final").textContent = getTitle();
          let metaLine = header.querySelector(".meta-line-final");

          if (rating) metaLine.innerHTML += `<span class="rating">â˜… ${rating}</span>`;
          if (year) metaLine.innerHTML += `<span>${year}</span>`;
          if (country) metaLine.innerHTML += `<span>${country}</span>`;
          if (pg) metaLine.innerHTML += `<span>${pg}</span>`;

          let tagsLine = header.querySelector(".tags-line-final");
          genres.forEach(g => tagsLine.innerHTML += `<span class="tag">${g}</span>`);

          if (status) metaLine.insertAdjacentHTML("afterend", `<div style="font-size:13px; color:#a7a7a7; margin-top:8px;">${status}</div>`);
        });

        postFinalContainer.querySelector(".synopsis-final").textContent = postBody.querySelector("#overview-data")?.textContent.trim() || "";

        // Cast Grid
        let castItems = postBody.querySelectorAll("#celebrity-data li");
        if (castItems.length > 0) {
          postFinalContainer.querySelector("#celebrity-section").style.display = "block";
          let grid = postFinalContainer.querySelector(".celebrity-grid-final");
          castItems.forEach(item => {
            let img = item.querySelector("img")?.src || "";
            let name = item.querySelector("span")?.textContent || "";
            grid.innerHTML += `
              <div class="celebrity-item-final">
                <img src="${img}" alt="${name}"/>
                <span class="name">${name}</span>
              </div>`;
          });
        }

        // Parse Episodes
        let servers = {};
        let serverNames = [];
        postBody.querySelectorAll("#episodes-data > ul[data-server-name]").forEach(ul => {
          let name = ul.dataset.serverName;
          let links = Array.from(ul.querySelectorAll("a"));
          if (name && links.length > 0) {
            serverNames.push(name);
            servers[name] = links;
          }
        });

        // Parse Downloads
        let downloadLinks = Array.from(postBody.querySelectorAll("#download-data a"));

        // Player Elements
        let iframe = postFinalContainer.querySelector(".video-player-container-final iframe");
        let playerContainer = postFinalContainer.querySelector(".video-player-container-final");
        let overlay = postFinalContainer.querySelector(".video-overlay");

        if (overlay && backdrop) {
          overlay.style.backgroundImage = `url(${backdrop})`;
        }

        if (overlay) {
          overlay.addEventListener("click", () => {
            // Track history
            let pidEl = document.getElementById("post-id");
            if (pidEl) {
              let pid = pidEl.getAttribute("data-post-id");
              if (pid) {
                let hist = JSON.parse(localStorage.getItem("watchHistoryIDs") || "[]");
                hist = hist.filter(h => String(h) !== String(pid));
                hist.unshift(pid);
                if (hist.length > 50) hist.pop();
                localStorage.setItem("watchHistoryIDs", JSON.stringify(hist));
              }
            }

            playerContainer.classList.add("is-playing");
            let src = iframe.getAttribute("src");
            if (src && src !== "about:blank") {
              try {
                let url = new URL(src);
                url.searchParams.set("autoplay", "1");
                iframe.setAttribute("src", url.href);
              } catch (e) {
                iframe.setAttribute("src", src + (src.includes("?") ? "&" : "?") + "autoplay=1");
              }
            }
          });
        }

        // Load Watch State
        let stateKey = `watchState_${window.location.pathname}`;
        let currentEpIndex = 0;
        let currentServer = serverNames[0] || null;
        let savedState = localStorage.getItem(stateKey);

        if (savedState) {
          try {
            let parsed = JSON.parse(savedState);
            let checkList = servers[parsed.server];
            if (parsed && serverNames.includes(parsed.server) && parsed.episode < (checkList?.length || 0)) {
              currentServer = parsed.server;
              currentEpIndex = parsed.episode;
            }
          } catch (e) {
            console.error(e);
          }
        }

        let serverSelectionDiv = postFinalContainer.querySelector(".server-selection-final");
        let downloadContainer = postFinalContainer.querySelector(".download-links-container");
        let prevBtn = postFinalContainer.querySelector("#prev-ep-btn");
        let nextBtn = postFinalContainer.querySelector("#next-ep-btn");
        let epCounter = postFinalContainer.querySelector("#ep-counter");

        const renderServers = () => {
          serverSelectionDiv.innerHTML = "";
          serverNames.forEach(name => {
            let btn = document.createElement("button");
            btn.className = "server-btn";
            btn.dataset.server = name;
            // Check for logo
            let ul = postBody.querySelector(`ul[data-server-name="${name}"]`);
            let logo = ul ? ul.dataset.serverLogo : null;
            if (logo) {
              btn.innerHTML = `<img src="${logo}" alt="${name}" class="server-logo-img"/> <span class="server-name-text">${name}</span>`;
            } else {
              btn.innerHTML = `<span class="server-name-text">${name}</span>`;
            }
            if (name === currentServer) btn.classList.add("active");
            serverSelectionDiv.appendChild(btn);
          });
        };

        const loadEpisode = (index) => {
          let list = servers[currentServer] || [];
          if (index < 0 || index >= list.length) return;

          currentEpIndex = index;
          localStorage.setItem(stateKey, JSON.stringify({
            server: currentServer,
            episode: currentEpIndex
          }));

          // Save progress globally for "Continue Watching"
          let pidEl = document.getElementById("post-id");
          if (pidEl) {
            let pid = pidEl.getAttribute("data-post-id");
            if (pid) {
              try {
                let prog = JSON.parse(localStorage.getItem("abefilmWatchProgress") || "{}");
                prog[`post-${pid}`] = index;
                localStorage.setItem("abefilmWatchProgress", JSON.stringify(prog));
              } catch (e) {}
            }
          }

          iframe.src = list[index].href;
          epCounter.textContent = `${index + 1} / ${list.length}`;

          // Highlight buttons
          let grids = document.querySelectorAll(".episodes-grid-container-final, #all-episodes-modal-grid");
          grids.forEach(g => {
            g.querySelector(".ep-button.active")?.classList.remove("active");
            let btn = g.querySelector(`.ep-button[data-ep-index="${index}"]`);
            if (btn) {
              btn.classList.add("active");
              if (g.classList.contains("episodes-grid-container-final")) {
                btn.scrollIntoView({
                  behavior: "smooth",
                  block: "nearest",
                  inline: "center"
                });
              }
            }
          });

          prevBtn.disabled = index === 0;
          nextBtn.disabled = index === list.length - 1;

          // Handle Pagination Tabs
          let page = Math.floor(index / 50) + 1;
          let pagination = postFinalContainer.querySelector(".episodes-pagination-final");
          if (pagination && pagination.innerHTML) {
            let activeTab = pagination.querySelector(".ep-range-tabs-container .ep-range-tab.active");
            let activePage = activeTab ? parseInt(activeTab.dataset.page, 10) : 0;
            if (activePage !== page) {
              renderPaginationTabs(page);
              showPageGrid(page);
            }
          }
        };

        const renderPaginationTabs = (activePage) => {
          let list = servers[currentServer] || [];
          let count = list.length;
          let totalPages = Math.ceil(count / 50);
          let container = postFinalContainer.querySelector(".episodes-pagination-final");
          let tabsContainer = container.querySelector(".ep-range-tabs-container");
          let dropdownMenu = container.querySelector(".ep-range-dropdown-menu");

          if (tabsContainer) tabsContainer.innerHTML = "";
          dropdownMenu.innerHTML = "";

          // Show limited tabs around active page
          let startPage = 1;
          if (totalPages > 3 && activePage > 3) {
            startPage = 3 * Math.floor((activePage - 1) / 3) + 1;
          }

          for (let p = 0; p < totalPages; p++) {
            let pageNum = p + 1;
            let startEp = 50 * p + 1;
            let endEp = Math.min((p + 1) * 50, count);
            let label = `${startEp}-${endEp}`;

            // Dropdown Item
            let a = document.createElement("a");
            a.className = "ep-range-tab";
            a.href = "#";
            a.dataset.page = pageNum;
            a.innerHTML = `<span>${label}</span>`;
            if (pageNum === activePage) a.classList.add("active");
            dropdownMenu.appendChild(a);

            // Tab Item (if visible)
            if (tabsContainer && pageNum >= startPage && pageNum < startPage + 3) {
              let btn = document.createElement("button");
              btn.className = "ep-range-tab";
              btn.dataset.page = pageNum;
              btn.innerHTML = `<span>${label}</span>`;
              if (pageNum === activePage) btn.classList.add("active");
              tabsContainer.appendChild(btn);
            }
          }

          let toggle = container.querySelector(".ep-range-dropdown-toggle");
          if (toggle) toggle.style.display = totalPages > 1 ? "flex" : "none";
        };

        const showPageGrid = (page) => {
          postFinalContainer.querySelectorAll(".episodes-grid-final").forEach(grid => {
            grid.classList.toggle("active", grid.dataset.page == page);
          });
        };

        const renderEpisodes = (serverName) => {
          currentServer = serverName;
          let list = servers[currentServer];
          let count = list?.length || 0;
          let totalPages = Math.ceil(count / 50);
          let pagination = postFinalContainer.querySelector(".episodes-pagination-final");
          let gridContainer = postFinalContainer.querySelector(".episodes-grid-container-final");
          let contentArea = postFinalContainer.querySelector("#episodes-content");

          contentArea.querySelector(".total-ep-header")?.remove();
          pagination.innerHTML = "";
          gridContainer.innerHTML = "";

          if (count === 0) return;

          // Header
          let headerHtml = `
            <div class="total-ep-header">
                <p class="total-ep-count">Total Episodes: ${count}</p>
                <button class="all-episodes-btn-mobile">
                    All Episodes
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>`;
          pagination.insertAdjacentHTML("beforebegin", headerHtml);

          // Pagination Structure
          let pagHtml = `
            <div class="ep-range-dropdown">
                <button class="ep-range-dropdown-toggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg></button>
                <div class="ep-range-dropdown-menu"></div>
            </div>`;
          pagination.innerHTML = (count > 50 ? '<div class="ep-range-tabs-container"></div>' : "") + pagHtml;

          // Generate Grids
          for (let p = 0; p < totalPages; p++) {
            let grid = document.createElement("div");
            grid.className = "episodes-grid-final";
            grid.dataset.page = p + 1;
            gridContainer.appendChild(grid);

            for (let i = 0; i < 50; i++) {
              let epNum = (p * 50) + i + 1;
              if (epNum > count) break;
              let btn = document.createElement("a");
              btn.className = "ep-button";
              btn.dataset.epIndex = epNum - 1;
              btn.innerHTML = `<span class="ep-number-text">${epNum}</span><span class="ep-active-indicator"><svg viewBox="0 0 24 24"><rect class="bar bar1" x="4" y="8" width="4" height="10" rx="1"></rect><rect class="bar bar2" x="10" y="4" width="4" height="16" rx="1"></rect><rect class="bar bar3" x="16" y="10" width="4" height="8" rx="1"></rect></svg></span>`;
              grid.appendChild(btn);
            }
          }

          if (currentEpIndex >= count) currentEpIndex = 0;

          // Mobile Modal Logic
          let modalOverlay = document.getElementById("all-episodes-modal-overlay");
          let modalGrid = document.getElementById("all-episodes-modal-grid");
          let closeBtn = modalOverlay.querySelector(".episodes-modal-close-btn");
          let mobileTrigger = postFinalContainer.querySelector(".all-episodes-btn-mobile");

          const openModal = () => {
            modalGrid.innerHTML = "";
            postFinalContainer.querySelectorAll(".episodes-grid-final .ep-button").forEach(btn => {
              modalGrid.appendChild(btn.cloneNode(true));
            });
            modalOverlay.classList.add("is-visible");
            document.body.style.overflow = "hidden";
          };

          const closeModal = () => {
            modalOverlay.classList.remove("is-visible");
            document.body.style.overflow = "";
          };

          if (mobileTrigger) mobileTrigger.onclick = openModal;
          closeBtn.onclick = closeModal;
          modalOverlay.onclick = (e) => {
            if (e.target === modalOverlay) closeModal();
          };
          modalGrid.onclick = (e) => {
            let btn = e.target.closest(".ep-button");
            if (btn) {
              e.preventDefault();
              loadEpisode(parseInt(btn.dataset.epIndex, 10));
              closeModal();
            }
          };

          loadEpisode(currentEpIndex);
        };

        // Determine which tabs to show
        let hasEpisodes = serverNames.length > 0 && servers[serverNames[0]]?.length > 0;
        let hasMultiServer = serverNames.length > 1;
        let hasDownloads = downloadLinks.length > 0;

        if (hasEpisodes || hasMultiServer || hasDownloads) {
          postFinalContainer.querySelector("#episodes-section").style.display = "block";
          let tabsNav = postFinalContainer.querySelector(".episodes-tabs-final");
          let allTabs = postFinalContainer.querySelectorAll(".ep-tab-content");
          let firstTab = null;

          tabsNav.innerHTML = "";

          if (hasEpisodes) {
            tabsNav.innerHTML += `<button class="ep-tab-button" data-target="#episodes-content"><svg ...>...</svg> Episodes</button>`;
            if (!firstTab) firstTab = "#episodes-content";
          }
          if (hasMultiServer) {
            tabsNav.innerHTML += `<button class="ep-tab-button" data-target="#server-content"><svg ...>...</svg> Server <span class="tab-count">${serverNames.length}</span></button>`;
            if (!firstTab) firstTab = "#server-content";
          }
          if (hasDownloads) {
            tabsNav.innerHTML += `<button class="ep-tab-button" data-target="#download-content"><svg ...>...</svg> Download</button>`;
            if (!firstTab) firstTab = "#download-content";
          }

          if (firstTab) {
            tabsNav.querySelector(`[data-target="${firstTab}"]`).classList.add("active");
            postFinalContainer.querySelector(firstTab).classList.add("active");
          }

          if (hasEpisodes) {
            renderEpisodes(currentServer);
          } else {
            postFinalContainer.querySelector(".footer-group-middle").style.display = "none";
          }

          if (hasMultiServer) renderServers();

          if (hasDownloads) {
            downloadContainer.innerHTML = `<p class="total-ep-count">Total Files: ${downloadLinks.length}</p>`;
            let dlGrid = document.createElement("div");
            dlGrid.className = "download-grid-final";
            downloadLinks.forEach(link => {
              let a = document.createElement("a");
              a.href = link.href;
              a.className = "ep-button";
              a.setAttribute("target", "_blank");
              a.textContent = link.textContent;
              dlGrid.appendChild(a);
            });
            downloadContainer.appendChild(dlGrid);
          }

          // Events
          tabsNav.addEventListener("click", (e) => {
            let btn = e.target.closest(".ep-tab-button");
            if (btn) {
              tabsNav.querySelector(".active")?.classList.remove("active");
              btn.classList.add("active");
              allTabs.forEach(t => t.classList.remove("active"));
              postFinalContainer.querySelector(btn.dataset.target).classList.add("active");
            }
          });

          serverSelectionDiv.addEventListener("click", (e) => {
            if (e.target.matches(".server-btn")) {
              let name = e.target.dataset.server;
              if (name !== currentServer) {
                renderEpisodes(name);
                renderServers();
              }
            }
          });

          // Pagination Dropdown Global Click Handler
          if (hasEpisodes) {
            let isDropdownOpen = false;
            const closeDropdown = () => {
              let openMenu = document.querySelector(".ep-range-dropdown-menu.is-open-globally");
              if (openMenu) openMenu.classList.remove("is-open-globally");
              window.removeEventListener("scroll", closeDropdown);
              isDropdownOpen = false;
            };

            document.body.addEventListener("click", (e) => {
              let toggle = e.target.closest(".ep-range-dropdown-toggle");
              let tab = e.target.closest(".ep-range-tab");
              let menu = document.querySelector(".ep-range-dropdown-menu.is-open-globally");

              if (toggle) {
                e.preventDefault();
                e.stopPropagation();
                let nextMenu = toggle.nextElementSibling;
                if (nextMenu) {
                  if (nextMenu.classList.contains("is-open-globally")) {
                    closeDropdown();
                  } else {
                    let rect = toggle.getBoundingClientRect();
                    nextMenu.style.top = (rect.bottom + 8) + "px";
                    nextMenu.classList.add("is-open-globally");
                    if (!isDropdownOpen) {
                      window.addEventListener("scroll", closeDropdown, {
                        once: true
                      });
                      isDropdownOpen = true;
                    }
                  }
                }
              } else if (tab) {
                e.preventDefault();
                let page = parseInt(tab.dataset.page, 10);
                if (e.target.closest(".ep-range-dropdown-menu")) closeDropdown();
                renderPaginationTabs(page);
                showPageGrid(page);
              } else if (menu) {
                if (!e.target.closest(".ep-range-dropdown")) closeDropdown();
              }
            });

            postFinalContainer.querySelector(".episodes-grid-container-final").addEventListener("click", (e) => {
              let btn = e.target.closest(".ep-button");
              if (btn) {
                e.preventDefault();
                loadEpisode(parseInt(btn.dataset.epIndex, 10));
              }
            });

            prevBtn.addEventListener("click", () => loadEpisode(currentEpIndex - 1));
            nextBtn.addEventListener("click", () => loadEpisode(currentEpIndex + 1));
          }

          let seasonMeta = getText("#extra-meta .meta-season");
          if (seasonMeta) postFinalContainer.querySelector("#season-info").textContent = seasonMeta;

          if (!hasEpisodes && currentServer) {
            iframe.src = servers[currentServer][0].href;
          }
        } else {
          // If no custom data, check for basic iframe
          let basicIframe = postBody.querySelector("iframe");
          if (basicIframe && basicIframe.src) {
            iframe.src = basicIframe.src;
          }
          postFinalContainer.querySelector("#episodes-section").style.display = "none";
          postFinalContainer.querySelector(".footer-group-middle").style.display = "none";
        }

        // Controls
        postFinalContainer.querySelector("#fullscreen-btn").addEventListener("click", () => {
          if (iframe.requestFullscreen) iframe.requestFullscreen();
        });
        postFinalContainer.querySelector("#reload-btn").addEventListener("click", () => {
          iframe.src = iframe.src;
        });
        postFinalContainer.querySelector("#sandbox-checkbox").addEventListener("change", (e) => {
          if (e.target.checked) iframe.setAttribute("sandbox", "allow-scripts allow-same-origin");
          else iframe.removeAttribute("sandbox");
        });

        // Info Modal
        let infoModal = postFinalContainer.querySelector(".info-modal-final");
        let infoLink = postFinalContainer.querySelector(".introduction-link-final");
        let modalClose = infoModal?.querySelector(".modal-close-btn");

        if (infoLink && infoModal && modalClose) {
          infoLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (window.innerWidth <= 767) infoModal.classList.add("is-open-mobile");
            else infoModal.style.display = "block";
          });
          modalClose.addEventListener("click", () => {
            if (window.innerWidth <= 767) infoModal.classList.remove("is-open-mobile");
            else infoModal.style.display = "none";
          });
        }

        postFinalContainer.classList.add("loaded");

        // Mobile specific move
        if (window.innerWidth <= 767) {
          let col = document.querySelector(".player-column-final");
          let article = document.querySelector("article.item-post");
          if (col && article) article.prepend(col);
        }

      } catch (err) {
        console.error("Error initializing custom player layout:", err);
        // Fallback
        let itemPost = document.querySelector(".item-post");
        if (itemPost) {
          let source = document.getElementById("source-data-container");
          if (source) source.style.display = "block";
        }
        if (postFinalContainer) postFinalContainer.style.display = "none";
      }
    }

    // Set active mobile nav
    try {
      let currentPath = decodeURIComponent(window.location.pathname);
      let mobileLinks = document.querySelectorAll(".mobile-nav a");
      let activeMobile = null;
      mobileLinks.forEach(link => {
        let lPath = new URL(link.href).pathname;
        if (lPath === "/" && currentPath === "/") activeMobile = link;
        else {
          let isMatch = (!activeMobile || lPath.length > new URL(activeMobile.href).pathname.length);
          if (lPath !== "/" && currentPath.startsWith(lPath) && isMatch) {
            activeMobile = link;
          }
        }
      });
      if (activeMobile) activeMobile.classList.add("active");
      else if (currentPath === "/") {
        document.querySelector('.mobile-nav a[href="/"]')?.classList.add("active");
      }
    } catch (e) {
      console.error(e);
    }
  });

  /**
   * ====================================================================
   * JQUERY & WIDGET LOGIC
   * ====================================================================
   */
  $(document).ready(function() {

    // Header Carousel Nav
    $(document).on("click", ".header-carousel-nav .header-nav-btn", function() {
      var btn = $(this);
      var carousel = $(btn.data("target"));
      if (carousel.length) {
        var owl = carousel.data("owl.carousel");
        if (!owl) return;
        var width = window.innerWidth;
        var itemsPerSlide = width < 768 ? 3 : width < 1024 ? 4 : 6;
        var current = owl.current();
        if (btn.hasClass("prev")) {
          var dest = Math.max(0, current - itemsPerSlide);
          carousel.trigger("to.owl.carousel", [dest, 300]);
        } else if (btn.hasClass("next")) {
          var dest = Math.min(owl.items().length - itemsPerSlide, current + itemsPerSlide);
          carousel.trigger("to.owl.carousel", [dest, 300]);
        }
      }
    });

    // Lazy load backgrounds
    function loadLazyBackgrounds() {
      var w = $(window).width() + 200;
      var h = $(window).height() + 200;
      $(".entry-image[data-image]:not(.lazyloaded)").each(function() {
        var el = $(this);
        var rect = el[0].getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0 && rect.top < h && rect.bottom > -200 && rect.left < w && rect.right > -200) {
          el.css("background-image", 'url("' + el.attr("data-image") + '")').addClass("lazyloaded");
        }
      });
    }

    // Generic Widget Loader
    function loadWidgetPosts(container, config) {
      var options = $.extend({
        maxResults: 12,
        label: null,
        style: "nowrap",
        sortBy: null
      }, config);
      var allowedGenres = ["Action", "Action & Adventure", "Adventure", "Animation", "Comedy", "Crime", "Documentary", "Drama", "Family", "Fantasy", "History", "Horror", "Kids", "Music", "Mystery", "Reality", "Romance", "Sci-Fi & Fantasy", "Science Fiction", "Thriller", "War", "Western"];

      if (options.label === "_auto_" && !$("body").is(".item-view, .item-page")) {
        container.closest(".widget").hide();
        return;
      }

      var max = options.sortBy === "rating" ? 50 : options.maxResults;
      var api = "/feeds/posts/default" + (options.label ? "/-/" + encodeURIComponent(options.label) : "") + "?alt=json-in-script&max-results=" + max;

      $.ajax({
        url: api,
        dataType: "jsonp",
        success: function(data) {
          var entries = data.feed && data.feed.entry ? data.feed.entry : [];
          if (entries.length === 0) {
            container.html('<span class="error-msg">No posts found.</span>');
            return;
          }

          let items = entries.map(e => {
            let div = document.createElement("div");
            div.innerHTML = e.content.$t;
            let $div = $(div);
            let id = e.id.$t.split(".post-")[1];
            let cats = (e.category || []).map(c => c.term);
            let label = cats.find(c => allowedGenres.includes(c)) || "";
            return {
              id: id,
              label: label,
              link: (e.link.find(l => "alternate" === l.rel) || {}).href,
              title: e.title.$t,
              imageUrl: ($div.find('img[alt="poster"]').attr("src") || "").replace(/\/s\d+(-[a-z0-g]+)*\//, "/s400-rw/"),
              rating: $div.find("#extra-meta .meta-rating").text().trim(),
              type: $div.find("#extra-meta .meta-type").text().trim(),
              year: $div.find("#extra-meta .meta-year").text().trim(),
              synopsis: $div.find("#overview-data").text().trim(),
              genres: $div.find("#extra-meta .meta-genre").map((i, el) => $(el).text().trim()).get(),
              audio: $div.find("#extra-meta .meta-audio").text().trim(),
              subtitles: $div.find("#extra-meta .meta-subtitles").text().trim(),
              isMature: !!e.category && e.category.some(c => "Mature" === c.term)
            };
          }).filter(i => i.link);

          if (options.sortBy === "rating") {
            items.sort((a, b) => parseFloat(b.rating || 0) - parseFloat(a.rating || 0));
          }

          items = items.slice(0, options.maxResults);
          var html = "";

          items.forEach((item, idx) => {
            let rank = idx + 1;
            let labelSpan = item.label ? `<span class="entry-label">${item.label}</span>` : "";

            if (options.style === "wide-list") {
              // ... Wide list rendering ...
              let badgeClass = rank === 1 ? "rank-gold" : rank === 2 ? "rank-blue" : rank === 3 ? "rank-green" : "";
              let metaHtml = "";
              if (item.year) metaHtml += `<span class="item-year">${item.year}</span>`;
              if (item.rating) metaHtml += `<span class="item-rating"><svg class="g-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>${item.rating}</span>`;
              let typeStr = item.type === "TV Series" ? "TV" : item.type;
              if (typeStr) metaHtml += `<span class="type-tag ${typeStr.toLowerCase()}">${typeStr}</span>`;
              let genreHtml = item.genres.slice(0, 2).map(g => `<span class="genre-tag">${g}</span>`).join("");

              html += `<a class="wide-list-item" href="${item.link}" title="${item.title}">
                            <div class="item-thumb">
                                <img src="${item.imageUrl}" alt="${item.title}" loading="lazy"/>
                                <div class="rank-badge ${badgeClass}">${rank}</div>
                            </div>
                            <div class="item-info">
                                <h4 class="item-title">${item.title}</h4>
                                <div class="item-meta-group">${metaHtml}</div>
                                <div class="item-genres">${genreHtml}</div>
                                <p class="item-synopsis">${item.synopsis || ""}</p>
                            </div>
                        </a>`;
            } else if (options.style === "top-list") {
              // ... Top list rendering ...
              html += `<div class="top-list-item">
                            <div class="rank-badge top-${rank}">${rank}</div>
                            <div class="item-info">
                                <h4 class="item-title"><a href="${item.link}">${item.title}</a></h4>
                                <div class="item-footer">
                                    ${item.rating ? '<span class="item-rating">'+item.rating+'</span>' : ''}
                                    ${item.subtitles ? '<span class="item-cc">CC '+item.subtitles+'</span>' : ''}
                                </div>
                            </div>
                            <a class="item-thumb" href="${item.link}" title="${item.title}">
                                <img src="${item.imageUrl}" alt="${item.title}" loading="lazy"/>
                            </a>
                        </div>`;
            } else {
              // ... Standard Grid/Carousel ...
              html += `<article class="index-post${item.isMature ? ' is-mature' : ''}" data-post-id="${item.id}">
                            <a class="entry-image-wrap" href="${item.link}" title="${item.title}">
                                <span class="entry-image" data-image="${item.imageUrl}"></span>
                                ${labelSpan}
                                <div class="thumb-meta-overlay">
                                    <span class="thumb-meta thumb-duration"></span>
                                    <span class="thumb-meta thumb-rating"></span>
                                </div>
                            </a>
                            <div class="entry-header">
                                <h2 class="entry-title"><a href="${item.link}">${item.title}</a></h2>
                                <div class="card-sub-meta">
                                    <div class="sub-meta-left"><span class="sub-meta-type"></span><span class="sub-meta-year"></span></div>
                                    <div class="sub-meta-right"><span class="sub-meta-cc"></span></div>
                                </div>
                            </div>
                        </article>`;
            }
          });

          let id = "abefilm-carousel-" + Math.random().toString(36).substring(2, 9);
          let output = "";

          if (options.style === "nowrap" || options.style === "wide-list") {
            output = `<div class="index-post-wrap owl-carousel owl-theme entry-slider" id="${id}">${html}</div>`;
          } else if (options.style === "grid") {
            output = `<div class="index-post-wrap">${html}</div>`;
          } else {
            output = `<div class="widget-content-inner">${html}</div>`;
          }

          container.html(output);

          // Initialize Carousel if needed
          if (options.style === "nowrap" || options.style === "wide-list") {
            let resp = {
              "0": {
                autoWidth: true,
                margin: 8
              },
              "768": {
                items: 4,
                margin: 16
              },
              "1024": {
                items: 6,
                margin: 16
              }
            };
            if (options.style === "wide-list") {
              resp = {
                "0": {
                  items: 1,
                  margin: 12,
                  autoWidth: true,
                  stagePadding: 60
                },
                "768": {
                  items: 2,
                  margin: 16
                },
                "1024": {
                  items: 3,
                  margin: 20
                }
              };
            }

            container.find(".owl-carousel").owlCarousel({
              loop: false,
              margin: 16,
              nav: true,
              dots: false,
              slideBy: "page",
              navText: [
                '<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 18l-6-6 6-6"/></svg>',
                '<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6l6 6-6 6"/></svg>'
              ],
              responsive: resp
            });
          }

          loadLazyBackgrounds();
          // Trigger meta loading for standard grid items
          fillPostMeta();

        },
        error: function() {
          container.html('<span class="error-msg">Error loading feed.</span>');
        }
      });
    }

    // Helper to fetch meta (year, rating) for index posts that don't have it
    function fillPostMeta() {
      $(".index-post:not(.custom-meta-populated)").each(function() {
        var el = $(this);
        var link = el.find("a.entry-image-wrap").attr("href");
        if (!link) {
          el.addClass("custom-meta-populated");
          return;
        }

        var cached = sessionStorage.getItem("meta_" + link);
        if (cached) {
          applyMeta(JSON.parse(cached), el);
          el.addClass("custom-meta-populated");
          return;
        }

        $.get(link, function(html) {
          var $html = $(html);
          var meta = $html.find("#extra-meta");
          var data = {
            year: meta.find(".meta-year").text().trim(),
            duration: meta.find(".meta-duration").text().trim(),
            subtitles: meta.find(".meta-subtitles").text().trim(),
            type: meta.find(".meta-type").text().trim(),
            rating: meta.find(".meta-rating").text().trim()
          };
          sessionStorage.setItem("meta_" + link, JSON.stringify(data));
          applyMeta(data, el);
          el.addClass("custom-meta-populated");
        }).fail(function() {
          el.addClass("custom-meta-populated");
        });
      });
    }

    function applyMeta(data, el) {
      if (data.duration) el.find(".thumb-duration").html(`<svg ...>...</svg> ${data.duration}`).addClass("is-visible");
      if (data.rating) el.find(".thumb-rating").html(`<svg ...>...</svg> ${data.rating}`).addClass("is-visible");
      if (data.type) el.find(".sub-meta-type").text(data.type === "TV Series" ? "TV" : data.type).addClass("is-visible");
      if (data.year) el.find(".sub-meta-year").text(data.year).addClass("is-visible");
      if (data.subtitles) el.find(".sub-meta-cc").text("CC " + data.subtitles).addClass("is-visible");
    }

    // Initialize "Lazy Posts" widgets
    let widgetObserver = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          let el = $(e.target);
          let sc = el.data("shortcode");
          if (sc) {
            obs.unobserve(e.target);
            let label = (sc.match(/\$label=\{([^}]+)\}/) || [])[1];
            let max = parseInt((sc.match(/\$results=\{([^}]+)\}/) || [])[1], 10) || 6;
            let style = (sc.match(/\$style=\{([^}]+)\}/) || [])[1] || "nowrap";
            let sortBy = (sc.match(/\$sortBy=\{([^}]+)\}/) || [])[1];

            loadWidgetPosts(el, {
              label,
              maxResults: max,
              style,
              sortBy
            });
          }
        }
      });
    }, {
      rootMargin: "0px 0px 250px 0px"
    });

    document.querySelectorAll('.widget-content[data-shortcode*="{lazyPosts}"]').forEach(el => widgetObserver.observe(el));

    loadLazyBackgrounds();
    $(window).on("scroll resize", loadLazyBackgrounds);
    $(document).on("translated.owl.carousel", ".owl-carousel", loadLazyBackgrounds);

    // Watchlist & Favorites Buttons Logic
    window.getWatchlist = () => {
      try {
        return JSON.parse(localStorage.getItem("abefilmUserWatchlist") || "[]");
      } catch (e) {
        return [];
      }
    };
    window.saveWatchlist = (list) => localStorage.setItem("abefilmUserWatchlist", JSON.stringify(list));
    window.addToWatchlist = (item) => {
      let list = getWatchlist();
      if (!list.some(i => i.id === item.id)) {
        list.unshift(item);
        saveWatchlist(list);
      }
    };
    window.removeFromWatchlist = (id) => {
      saveWatchlist(getWatchlist().filter(i => String(i.id) !== String(id)));
    };
    window.isItemInWatchlist = (id) => !!id && getWatchlist().some(i => String(i.id) === String(id));

    window.updateButtonState = (btn) => {
      if (!btn || !btn.length) return;
      let id = btn.attr("data-post-id");
      let inList = isItemInWatchlist(id);
      let isPostPage = btn.hasClass("post-page-add-btn");

      if (isPostPage) {
        btn.html(inList ? '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"></path></svg><span>Added</span>' : '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg><span>Add to List</span>');
      } else {
        // Icon swap for cards/slider
        btn.toggleClass("added", inList);
        // (SVG string omitted for brevity, logic remains)
      }
    };

    $(document).on("click", ".add-list-btn, .slider-btn.add-btn, #preview-popup .watchlist-btn", function(e) {
      e.preventDefault();
      let btn = $(this);
      let item = {
        id: btn.attr("data-post-id"),
        title: btn.attr("data-post-title"),
        url: btn.attr("data-post-url"),
        image: btn.attr("data-post-image")
      };
      if (item.id && item.title) {
        if (isItemInWatchlist(item.id)) removeFromWatchlist(item.id);
        else addToWatchlist(item);

        $('[data-post-id="' + item.id + '"]').each(function() {
          window.updateButtonState($(this));
        });
        if (typeof window.updateWatchlistBadge === "function") window.updateWatchlistBadge();
      }
    });

    // Favorites
    let favKey = "abefilm_favorites";
    const getFavs = () => JSON.parse(localStorage.getItem(favKey) || "[]");
    const saveFavs = (list) => localStorage.setItem(favKey, JSON.stringify(list));
    const isFav = (id) => getFavs().includes(String(id));

    function updateFavBtn(btn) {
      let $btn = $(btn);
      let id = $btn.attr("data-post-id");
      if (isFav(id)) {
        $btn.addClass("favorited").attr("title", "Remove from Favorites").html('<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>Favorited</span>');
      } else {
        $btn.removeClass("favorited").attr("title", "Add to Favorites").html('<svg viewBox="0 0 24 24"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5 22 5.42 19.58 3 16.5 3zm-4.4 15.55l-.1.1-.1-.1C7.14 14.24 4 11.39 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 2.89-3.14 5.74-7.9 10.05z"/></svg><span>Favorite</span>');
      }
    }

    $(document).on("click", ".favorite-btn", function(e) {
      e.preventDefault();
      let id = $(this).attr("data-post-id");
      if (!id) return;
      let list = getFavs();
      if (isFav(id)) list = list.filter(i => i !== String(id));
      else list.unshift(String(id));
      saveFavs(list);
      $('.favorite-btn[data-post-id="' + id + '"]').each(function() {
        updateFavBtn(this);
      });
    });

    $(".favorite-btn").each(function() {
      let btn = $(this);
      if (!btn.attr("data-post-id")) {
        let sibling = btn.siblings(".add-list-btn");
        btn.attr("data-post-id", sibling.attr("data-post-id"));
      }
      updateFavBtn(this);
    });

    // Theme & Safe Mode Logic
    let themeModal = document.getElementById("open-theme-settings-modal");
    let themeOverlay = document.getElementById("theme-settings-overlay");
    let themeClose = document.getElementById("ts-close-btn");
    let lightBtn = document.getElementById("light-mode-btn");
    let darkBtn = document.getElementById("dark-mode-btn");
    let safeBtn = document.getElementById("safe-mode-button");
    let safeStatus = document.getElementById("safe-mode-status");

    if (themeModal && themeOverlay) {
      themeModal.addEventListener("click", e => {
        e.preventDefault();
        themeOverlay.style.display = "flex";
        setTimeout(() => themeOverlay.classList.add("is-visible"), 10);
      });
      let close = () => {
        themeOverlay.classList.remove("is-visible");
        setTimeout(() => themeOverlay.style.display = "none", 200);
      };
      themeClose.addEventListener("click", close);
      themeOverlay.addEventListener("click", e => {
        if (e.target === themeOverlay) close();
      });
    }

    function setTheme(isDark) {
      document.body.classList.toggle("dark-mode", isDark);
      if (lightBtn) lightBtn.classList.toggle("active", !isDark);
      if (darkBtn) darkBtn.classList.toggle("active", isDark);
      localStorage.setItem("themeMode", isDark ? "dark" : "light");
    }

    if (lightBtn && darkBtn) {
      lightBtn.addEventListener("click", () => setTheme(false));
      darkBtn.addEventListener("click", () => setTheme(true));
      setTheme(localStorage.getItem("themeMode") === "dark");
    }

    function setSafeMode(isActive) {
      localStorage.setItem("matureFilterActive", isActive);
      document.body.classList.toggle("mature-filter-active", isActive);
      if (safeStatus) safeStatus.textContent = isActive ? "On" : "Off";
    }

    if (safeBtn) {
      let isSafe = localStorage.getItem("matureFilterActive") === "true";
      setSafeMode(isSafe);
      safeBtn.addEventListener("click", e => {
        e.preventDefault();
        setSafeMode(localStorage.getItem("matureFilterActive") !== "true");
      });
    }

    // Back to Top
    $("#back-top").on("click", function(e) {
      e.preventDefault();
      $("html, body").animate({
        scrollTop: 0
      }, 500);
    });
    $(window).on("scroll", function() {
      if ($(this).scrollTop() > 300) $("#back-top").addClass("on");
      else $("#back-top").removeClass("on");
    });

    movePostPageSidebar();
  });

/**
 * ==========================================
 * SECTION 1: COMMENT PARSING & FORMATTING
 * ==========================================
 */
const CommentUtils = {
  parse: function(btn) {
    let textarea = document.getElementById("cmn-parse-area");
    let copyBtn = document.getElementById("cmn-copy-btn");
    if (!textarea) return;

    let type = btn.getAttribute("data-text");
    let text = textarea.value.trim();

    if (!text) {
      alert("Please enter some text or a URL first.");
      return;
    }

    // Basic HTML escaping
    let escapedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    let result = "";

    switch (type) {
      case "bold":
        result = "<b>" + escapedText + "</b>";
        break;
      case "italic":
        result = "<i>" + escapedText + "</i>";
        break;
      case "quote":
        result = "[quote]" + escapedText + "[/quote]";
        break;
      case "tag":
        result = "[tag]" + escapedText + "[/tag]";
        break;
      case "pre":
        result = "[pre]" + escapedText + "[/pre]";
        break;
      case "code":
        result = "[code]" + escapedText + "[/code]";
        break;
      case "qa":
        let parts = escapedText.split(";");
        if (parts.length < 2) {
          alert("Please use the format:\nQuestion; Option 1; Option 2 (optional)");
          textarea.value = "Your Question; Option 1; Option 2";
          return;
        }
        result = "[QA]" + parts[0].trim() + "[OPT]" + parts.slice(1).map(p => p.trim()).join("[OPT]") + "[/QA]";
        break;
      default:
        result = escapedText;
    }

    textarea.value = result;
    if (copyBtn) copyBtn.classList.remove("hidden");
  },

  copy: function() {
    let textarea = document.getElementById("cmn-parse-area");
    if (textarea && textarea.value) {
      navigator.clipboard.writeText(textarea.value).then(() => {
        let msg = document.getElementById("cmn-copied-msg");
        if (msg) {
          msg.classList.remove("hidden");
          setTimeout(() => {
            msg.classList.add("hidden");
          }, 2000);
        }
      });
    }
  },

  clear: function() {
    let textarea = document.getElementById("cmn-parse-area");
    let copyBtn = document.getElementById("cmn-copy-btn");
    if (textarea) textarea.value = "";
    if (copyBtn) copyBtn.classList.add("hidden");
  }
};

/**
 * Transforms custom shortcodes [code], [quote], [QA] into HTML
 */
function transformCommentTags() {
  document.querySelectorAll(".comment-content:not(.tags-transformed)").forEach(commentBlock => {
    let html = commentBlock.innerHTML;

    // 1. Handle QA (Poll) Tags
    if (html.includes("[QA]")) {
      html = html.replace(/\[QA\](.*?)\[\/QA\]/g, (match, content) => {
        // Extract question and options
        let parts = content.split("[OPT]");
        let question = parts[0];
        let options = parts.slice(1);

        // Find context for reply count
        let commentContainer = commentBlock.closest(".comment");
        let replyText = "Join the discussion...";
        let qaId = "";

        if (commentContainer) {
          qaId = "qa-source-" + commentContainer.id;
          commentContainer.setAttribute("data-qa-id", qaId);
          let repliesContainer = commentContainer.querySelector(".comment-replies");
          if (repliesContainer) {
            let count = repliesContainer.querySelectorAll("li.comment").length;
            if (count > 0) {
              let displayCount = count >= 1000 ? (count / 1000).toFixed(1).replace(/\.0$/, "") + "K" : count;
              replyText = displayCount + " replies and discussion";
            }
          }
        }

        let optionsHtml = options.map(opt => `<span class="qa-option">${opt.trim()}</span>`).join("");

        return `
            <div class="qa-card" data-qa-id="${qaId}">
              <div class="qa-title"><span class="qa-icon">#</span>${question.trim()}</div>
              <div class="qa-options">${optionsHtml}</div>
              <a class="qa-footer" href="javascript:void(0)">
                <svg class="qa-stats-icon" viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><g><rect x="4" y="10" width="4" height="10" rx="1"></rect><rect x="10" y="4" width="4" height="16" rx="1"></rect><rect x="16" y="6" width="4" height="14" rx="1"></rect></g></svg>
                <span>${replyText}</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 4px; font-weight: bold;"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
              </a>
            </div>`;
      });
    }

    // 2. Code Block Formatter Helper
    const formatCodeBlock = (code, type) => {
      // Decode HTML entities back to characters for proper code display
      let decoded = code.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&").replace(/<br\s*\/?>/gi, "\n");
      // Re-encode for safe HTML display inside <pre>
      let safeCode = decoded.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      let msgId = "copied-msg-" + Math.random().toString(36).substr(2, 9);

      if (type === 'inline') {
        return `<code class="comment-inline-code hljs">${safeCode}</code>`;
      }

      return `
          <div class="comment-code-wrapper">
            <pre><code class="hljs">${safeCode}</code></pre>
            <button class="copy-code-btn" title="Copy code" onclick="navigator.clipboard.writeText(this.previousElementSibling.querySelector('code').textContent).then(() => { const msg = document.getElementById('${msgId}'); msg.classList.add('show'); setTimeout(() => msg.classList.remove('show'), 2000); });">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" width="18" height="18"><path d="M16.9637 8.98209C16.9613 6.03194 16.9167 4.50384 16.0578 3.45753C14.4008 1.99854 12.7609 1.99854 9.48087 1.99854C6.20089 1.99854 4.5609 1.99854 3.45708 2.90436C1.99799 4.56128 1.99799 6.20116 1.99799 9.48091C1.99799 12.7607 1.99799 14.4005 2.90387 15.5043C4.50346 16.9162 6.03167 16.9608 8.98201 16.9632" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M14.0283 9.02455L16.994 8.98193M14.0143 22.0013L16.9799 21.9586M21.9716 14.0221L21.9436 16.9818M9.01033 14.0357L8.98236 16.9953M11.4873 9.02455C10.6545 9.17371 9.31781 9.32713 9.01033 11.0488M19.4946 21.9586C20.3296 21.8223 21.6685 21.6894 22.0025 19.9726M19.4946 9.02455C20.3274 9.17371 21.6641 9.32713 21.9716 11.0488M11.5 21.9573C10.6672 21.8086 9.33039 21.6559 9.02197 19.9344" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            </button>
            <span class="code-copied-msg" id="${msgId}">Copied!</span>
          </div>`;
    };

    // Replace Tags
    html = html.replace(/\[pre\]([\s\S]*?)\[\/pre\]/g, (match, code) => formatCodeBlock(code, 'block'));
    html = html.replace(/\[code\]([\s\S]*?)\[\/code\]/g, (match, code) => formatCodeBlock(code, 'inline'));
    html = html.replace(/\[quote\]([\s\S]*?)\[\/quote\]/g, "<blockquote>$1</blockquote>");
    html = html.replace(/\[tag\]([\s\S]*?)\[\/tag\]/g, '<b class="comment-tag">@$1</b>');

    commentBlock.innerHTML = html;
    commentBlock.classList.add("tags-transformed");

    // Apply Highlight.js if available
    if (typeof hljs !== "undefined") {
      commentBlock.querySelectorAll("pre code.hljs").forEach(block => {
        hljs.highlightElement(block);
        if (typeof hljs.lineNumbersBlock === "function") {
          hljs.lineNumbersBlock(block);
        }
      });
    }
  });
}

/**
 * ==========================================
 * SECTION 2: UI & LAYOUT LOGIC
 * ==========================================
 */
document.addEventListener("DOMContentLoaded", function() {
  const isMobile = window.innerWidth <= 767;
  const postContainer = document.querySelector(".post-page-final-container");

  // --- Mobile Layout Adjustments ---
  if (isMobile && postContainer) {
    document.body.classList.add("item-view");

    // Move elements to specific tabs for mobile view
    const elementsToMove = {
      recSection: document.querySelector(".recommendation-section"),
      commentsSection: document.querySelector(".abefilm-blog-post-comments"),
      reactionTitle: document.querySelector(".mobile-reaction-title"),
      reactionContainer: document.querySelector(".reaction-container"),
      reviewSystem: document.querySelector(".review-system-container"),
      sidebarHtml: document.querySelector("#post-page-sidebar #HTML8")
    };

    const videoTab = document.getElementById("video-tab-content");
    const commentTab = document.getElementById("comment-tab-content");

    if (elementsToMove.recSection && videoTab) videoTab.appendChild(elementsToMove.recSection);
    if (commentTab) {
      if (elementsToMove.reactionTitle) commentTab.appendChild(elementsToMove.reactionTitle);
      if (elementsToMove.reactionContainer) commentTab.appendChild(elementsToMove.reactionContainer);
      if (elementsToMove.reviewSystem) commentTab.appendChild(elementsToMove.reviewSystem);
      if (elementsToMove.commentsSection) commentTab.appendChild(elementsToMove.commentsSection);
    }
    if (elementsToMove.sidebarHtml && videoTab) {
      // Insert sidebar ad before recommendations if possible
      let recInVideo = videoTab.querySelector(".recommendation-section");
      recInVideo ? videoTab.insertBefore(elementsToMove.sidebarHtml, recInVideo) : videoTab.appendChild(elementsToMove.sidebarHtml);
    }

    // Cast/Celebrity Carousel for Mobile
    const celebrityData = document.querySelector("#celebrity-data");
    if (celebrityData && videoTab) {
      const lis = celebrityData.querySelectorAll("li");
      if (lis.length > 0) {
        const castSection = document.createElement("div");
        castSection.className = "section-final mobile-celebrity-section";
        castSection.innerHTML = `<h3>Cast</h3><div class="celebrity-carousel-mobile"></div>`;
        const carousel = castSection.querySelector(".celebrity-carousel-mobile");

        lis.forEach(li => {
          const img = li.querySelector("img")?.src || "";
          const name = li.querySelector("span")?.textContent || "";
          carousel.innerHTML += `
              <div class="celebrity-item-mobile">
                <img src="${img}" alt="${name}" loading="lazy"/>
                <span class="name">${name}</span>
              </div>`;
        });

        let recInVideo = videoTab.querySelector(".recommendation-section");
        recInVideo ? videoTab.insertBefore(castSection, recInVideo) : videoTab.appendChild(castSection);
      }
    }

    // Mobile Tab Switching Logic
    const tabBtns = document.querySelectorAll(".mobile-tab-btn");
    const tabPanels = document.querySelectorAll(".mobile-tab-panel");
    if (tabBtns.length > 0 && tabPanels.length > 0) {
      tabBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const targetSelector = btn.getAttribute("data-tab-target");
          const targetPanel = document.querySelector(targetSelector);
          if (targetPanel) {
            tabBtns.forEach(b => b.classList.remove("active"));
            tabPanels.forEach(p => p.classList.remove("active"));
            btn.classList.add("active");
            targetPanel.classList.add("active");
            document.body.classList.toggle("comment-tab-active", targetSelector === "#comment-tab-content");
          }
        });
      });
    }

    // Mobile Comment Form Trigger
    const commentTrigger = document.getElementById("mobile-comment-trigger");
    if (commentTrigger) {
      const discussLink = commentTrigger.querySelector(".trigger-discussion-link");
      const ratingLink = commentTrigger.querySelector(".trigger-rating-link");
      const closeForm = document.getElementById("close-comment-form");

      if (discussLink && closeForm) {
        discussLink.addEventListener("click", (e) => {
          e.preventDefault();
          document.body.classList.add("comment-form-active");
        });
        closeForm.addEventListener("click", () => {
          document.body.classList.remove("comment-form-active");
        });
      }
      if (ratingLink) {
        ratingLink.addEventListener("click", (e) => {
          e.preventDefault();
          document.getElementById("review-system")?.scrollIntoView({
            behavior: "smooth",
            block: "center"
          });
        });
      }
    }

    // Sticky Comment Form Adjustment
    const playerColumn = document.querySelector(".player-column-final");
    const commentForm = document.querySelector(".comment-form");
    if (playerColumn && commentForm) {
      const adjustForm = () => {
        commentForm.style.top = playerColumn.offsetHeight + "px";
      };
      adjustForm();
      window.addEventListener("resize", adjustForm);
    }
  }

  // --- General UI Logic ---

  // Move Comment Helper into Form
  const helper = document.getElementById("comment-helper");
  const commentsWrapper = document.getElementById("comments");
  if (helper && commentsWrapper) {
    const observer = new MutationObserver(mutations => {
      for (const mutation of mutations) {
        for (const node of mutation.addedNodes) {
          if (node.nodeType === 1 && node.id === "comment-editor") {
            if (node.parentNode) node.parentNode.insertBefore(helper, node);
            return;
          }
        }
      }
    });
    observer.observe(commentsWrapper, {
      childList: true,
      subtree: true
    });
  }

  // Sort Order Logic
  const sortSelect = document.getElementById("sort-select");
  const topRa = document.getElementById("top-ra");
  if (sortSelect && topRa) {
    sortSelect.addEventListener("change", function() {
      topRa.style.flexDirection = this.value === "newest" ? "column-reverse" : "column";
    });
  }

  // Formatting Loop (Ensure items loaded dynamically get formatted)
  const formatInterval = setInterval(() => {
    const topCe = document.getElementById("top-ce");
    const form = document.querySelector(".comments .comment-form");
    if (topCe && form) {
      form.appendChild(topCe);
      clearInterval(formatInterval);
    }
  }, 100);
  setTimeout(() => clearInterval(formatInterval), 10000);
  transformCommentTags();

  // Comment Count Badge Formatting (e.g. 1500 -> 1.5k)
  const countBadge = document.querySelector(".comment-count-badge");
  if (countBadge) {
    try {
      let count = parseInt(countBadge.textContent, 10);
      if (!isNaN(count)) {
        if (count >= 1000) {
          countBadge.textContent = (count / 1000).toFixed(1).replace(".0", "") + "k";
        } else if (count === 0) {
          countBadge.style.display = "none";
        }
      }
    } catch (e) {}
  }


  /**
   * ==========================================
   * SECTION 3: SUPABASE INTEGRATION (Interactive Features)
   * ==========================================
   */
  const SUPABASE_URL = "https://agfwyfwsnqnklgcgemnw.supabase.co";
  // NOTE: This is a public anon key, meant to be client-side accessible
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZnd5ZndzbnFua2xnY2dlbW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTQ3MTQsImV4cCI6MjA3Mjc5MDcxNH0.NBWiC0YzG8zDhijQ17j49xVXUyLJYXlMJKJkfFJg5yg";

  if (typeof supabase === "undefined" || !SUPABASE_URL.startsWith("http")) {
    console.warn("Supabase client not loaded or configured. Interactive features will be disabled.");
    return;
  }

  const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // --- Feature A: Star Rating System ---
  (() => {
    const dataEl = document.getElementById("post-review-data");
    if (!dataEl) return;

    // Inject Sparkle/Feedback Popup HTML if missing
    if (!document.getElementById("rating-feedback-popup")) {
      const popup = document.createElement("div");
      popup.id = "rating-feedback-popup";
      popup.className = "rating-feedback-container";
      popup.innerHTML = `<div class="feedback-content"><h3 class="popup-text">You rated</h3><div class="popup-stars" id="popup-stars-content"></div></div>`;
      document.body.appendChild(popup);
    }

    const postId = dataEl.getAttribute("data-post-id");
    const localStorageKey = "sb_rated_" + postId;
    const summaryWrapper = document.getElementById("review-summary-wrapper");
    let cachedSummary = null;

    // Get or Create Client ID
    let clientId = localStorage.getItem("supabase_client_id");
    if (!clientId) {
      clientId = self.crypto.randomUUID();
      localStorage.setItem("supabase_client_id", clientId);
    }

    const formatCount = (n) => n >= 1000 ? (n / 1000).toFixed(n % 1000 !== 0 ? 1 : 0) + "K" : n;

    // Update UI based on User's Rating Status
    const updateUserStatusUI = () => {
      const shortcut = document.getElementById("rating-shortcut-text");
      if (shortcut) {
        const hasRated = localStorage.getItem(localStorageKey) !== null;
        shortcut.textContent = hasRated ? "My rating" : "Rate now";
      }
    };

    // Render the Rating Box
    const renderRatings = (summary) => {
      cachedSummary = summary;
      const userRating = localStorage.getItem(localStorageKey);
      const hasRated = userRating !== null;
      const defaultCounts = { "1": 0, "2": 0, "3": 0, "4": 0, "5": 0 };

      const total = summary?.total_ratings || 0;
      const avg = summary?.average_rating || 0;
      const counts = summary?.rating_counts || defaultCounts;

      let starsHtml = "";
      for (let i = 1; i <= 5; i++) {
        starsHtml += `<span class="star ${i <= Math.round(avg) ? 'filled' : ''}" data-value="${i}">&#9733;</span>`;
      }

      let barsHtml = "";
      for (let i = 5; i >= 1; i--) {
        const count = counts[String(i)] || 0;
        const percent = total > 0 ? (count / total) * 100 : 0;
        barsHtml += `
          <div class="breakdown-row">
            <span>${i}.0</span>
            <div class="progress-bar-container"><div class="progress-bar" style="width:${percent}%;"></div></div>
            <span class="review-count">${count} reviews</span>
          </div>`;
      }

      summaryWrapper.innerHTML = `
        <div class="review-summary-left">
          <div class="average-rating-score">${avg.toFixed(1)}</div>
          <div>
            <div class="average-rating-stars ${hasRated ? 'rated' : ''}" id="interactive-stars">${starsHtml}</div>
            <div class="total-ratings">${formatCount(total)} ratings</div>
          </div>
        </div>
        <div class="review-summary-right">${barsHtml}</div>`;

      // Render User's Personal Rating Display
      let userDisplay = document.getElementById("user-rating-display-container");
      if (!userDisplay) {
        userDisplay = document.createElement("div");
        userDisplay.id = "user-rating-display-container";
        summaryWrapper.after(userDisplay);
      }

      if (hasRated) {
        const val = parseInt(userRating, 10);
        let userStars = "";
        for (let i = 1; i <= 5; i++) {
          userStars += i <= val ? '<span class="star filled">&#9733;</span>' : '<span class="star">&#9734;</span>';
        }
        userDisplay.innerHTML = `<div class="user-rating-display"><span>You rated:</span><div>${userStars}</div></div>`;
      } else {
        userDisplay.innerHTML = "";
      }
    };

    // Fetch Data
    const fetchRatings = async () => {
      const { data, error } = await sbClient.from("review_summaries").select("*").eq("post_id", postId).single();
      if (error && error.code !== "PGRST116") console.error("Supabase Error:", error);
      renderRatings(data);
      updateUserStatusUI();
    };

    // Show Sparkle Animation
    const showFeedback = (rating) => {
      const popup = document.getElementById("rating-feedback-popup");
      const content = popup.querySelector(".feedback-content");
      const starsContainer = document.getElementById("popup-stars-content");

      if (popup && starsContainer) {
        content.querySelectorAll(".sparkle").forEach(el => el.remove());
        
        // Draw popup stars
        starsContainer.innerHTML = Array.from({ length: 5 }, (_, i) => 
          i < rating ? '<span class="star-filled">&#9733;</span>' : '<span class="star-empty">&#9734;</span>'
        ).join("");

        // Generate Sparkles
        for (let i = 0; i < 12; i++) {
          const sparkle = document.createElement("div");
          sparkle.className = "sparkle";
          const angle = Math.random() * 360;
          const dist = Math.random() * 80 + 60;
          const x = Math.cos(angle * Math.PI / 180) * dist;
          const y = Math.sin(angle * Math.PI / 180) * dist;
          sparkle.style.setProperty("--sparkle-transform-end", `translate(${x}px, ${y}px)`);
          sparkle.style.animationDelay = (Math.random() * 0.3) + "s";
          content.appendChild(sparkle);
        }

        popup.classList.add("show");
        setTimeout(() => popup.classList.remove("show"), 2500);
      }
    };

    // Submit Rating
    const submitRating = async (rating) => {
      if (localStorage.getItem(localStorageKey) !== null) return; // Prevent double voting locally

      showFeedback(rating);
      localStorage.setItem(localStorageKey, rating);
      updateUserStatusUI();

      // Optimistic UI Update
      const defaultCounts = { "1": 0, "2": 0, "3": 0, "4": 0, "5": 0 };
      const currentTotal = cachedSummary?.total_ratings || 0;
      const currentAvg = cachedSummary?.average_rating || 0;
      const currentCounts = cachedSummary?.rating_counts || defaultCounts;
      
      const currentSum = currentAvg * currentTotal;
      const newTotal = currentTotal + 1;
      const newAvg = (currentSum + rating) / newTotal;
      const newCounts = { ...currentCounts, [String(rating)]: (currentCounts[String(rating)] || 0) + 1 };

      renderRatings({
        total_ratings: newTotal,
        average_rating: newAvg,
        rating_counts: newCounts
      });

      // DB Insert
      const payload = { post_id: postId, rating: rating, client_id: clientId };
      const { error } = await sbClient.from("reviews").insert(payload);

      if (error) {
        console.error("Error submitting review:", error);
        localStorage.removeItem(localStorageKey);
        fetchRatings(); // Revert on error
      }
    };

    summaryWrapper.addEventListener("click", (e) => {
      const star = e.target.closest(".star");
      const starContainer = e.target.closest(".average-rating-stars");
      if (star && starContainer && !starContainer.classList.contains("rated")) {
        submitRating(parseInt(star.getAttribute("data-value")));
      }
    });

    fetchRatings();
  })();

  // --- Feature B: Reaction System ---
  (() => {
    const dataEl = document.getElementById("post-review-data") || document.getElementById("post-id");
    const container = document.getElementById("reaction-container");
    if (!dataEl || !container) return;

    const postId = dataEl.getAttribute("data-post-id");
    if (!postId) {
      console.error("Reaction system: Post ID not found.");
      return;
    }

    const localStorageKey = "sb_reacted_" + postId;
    const reactionsList = [
      { type: "like", label: "Upvote", icon: "ðŸ‘" },
      { type: "love", label: "Love", icon: "ðŸ˜" },
      { type: "haha", label: "Funny", icon: "ðŸ˜†" },
      { type: "wow", label: "Surprised", icon: "ðŸ˜²" },
      { type: "sad", label: "Sad", icon: "ðŸ˜¢" },
      { type: "angry", label: "Angry", icon: "ðŸ˜ " }
    ];

    let clientId = localStorage.getItem("supabase_client_id");
    if (!clientId) {
      clientId = self.crypto.randomUUID();
      localStorage.setItem("supabase_client_id", clientId);
    }

    let reactionCounts = {};
    let currentUserReaction = null;

    const renderReactions = (counts, userSelection) => {
      container.innerHTML = reactionsList.map(item => {
        const count = counts?.[item.type] || 0;
        const isSelected = userSelection === item.type;
        return `
          <button class="reaction-btn ${isSelected ? 'selected' : ''}" data-reaction="${item.type}">
            <div class="reaction-icon-wrapper">
              <span class="reaction-icon">${item.icon}</span>
              <span class="reaction-count">${count > 0 ? count : ""}</span>
            </div>
            <span class="reaction-label">${item.label}</span>
          </button>`;
      }).join("");
    };

    const fetchReactions = async () => {
      try {
        const [summaryRes, userRes] = await Promise.all([
          sbClient.from("reaction_summaries").select("counts").eq("post_id", postId).single(),
          sbClient.from("reactions").select("reaction_type").eq("post_id", postId).eq("client_id", clientId).single()
        ]);

        reactionCounts = summaryRes.data?.counts || {};
        currentUserReaction = userRes.data?.reaction_type || null;

        if (currentUserReaction) {
          localStorage.setItem(localStorageKey, currentUserReaction);
        } else {
          localStorage.removeItem(localStorageKey);
        }

        renderReactions(reactionCounts, currentUserReaction);

      } catch (err) {
        console.error("Error fetching reaction data:", err);
      }
    };

    const handleReactionClick = async (type) => {
      const prevReaction = currentUserReaction;

      // Optimistic Update
      if (prevReaction === type) {
        // Toggle Off
        if (reactionCounts[prevReaction]) reactionCounts[prevReaction]--;
        currentUserReaction = null;
        localStorage.removeItem(localStorageKey);
      } else {
        // Switch or New
        if (prevReaction && reactionCounts[prevReaction]) reactionCounts[prevReaction]--;
        currentUserReaction = type;
        reactionCounts[type] = (reactionCounts[type] || 0) + 1;
        localStorage.setItem(localStorageKey, type);
      }

      renderReactions(reactionCounts, currentUserReaction);

      // DB Sync
      try {
        const payload = { post_id: postId, client_id: clientId };
        if (prevReaction === type) {
          await sbClient.from("reactions").delete().match(payload);
        } else {
          await sbClient.from("reactions").upsert({
            post_id: postId,
            client_id: clientId,
            reaction_type: type
          }, {
            onConflict: "post_id, client_id"
          });
        }
      } catch (err) {
        console.error("Error updating reaction:", err);
        await fetchReactions(); // Revert on error
      }
    };

    container.addEventListener("click", (e) => {
      const btn = e.target.closest(".reaction-btn");
      if (btn) handleReactionClick(btn.dataset.reaction);
    });

    fetchReactions();
  })();
});

/**
 * Global Helper: Update count badges on Account Page links
 */
function updateAccountPageCounts() {
    if (!document.querySelector(".account-page-container")) return;

    const watchlistCount = (JSON.parse(localStorage.getItem("abefilmUserWatchlist")) || []).length;
    const historyCount = (JSON.parse(localStorage.getItem("watchHistoryIDs")) || []).length;
    const favoritesCount = (JSON.parse(localStorage.getItem("abefilm_favorites")) || []).length;

    const watchlistBadge = document.querySelector('a[href="/p/watchlist.html"] .item-value');
    const historyBadge = document.querySelector('a[href="/p/history.html"] .item-value');
    const favoritesBadge = document.querySelector('a[href="/p/favorite.html"] .item-value');

    if (watchlistBadge) {
        if (watchlistCount > 0) {
            watchlistBadge.textContent = watchlistCount;
            watchlistBadge.classList.add("is-badge");
        } else {
            watchlistBadge.textContent = "View";
            watchlistBadge.classList.remove("is-badge");
        }
    }
    if (historyBadge) historyBadge.textContent = historyCount > 0 ? historyCount : "View";
    if (favoritesBadge) favoritesBadge.textContent = favoritesCount > 0 ? favoritesCount : "View";
}

document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1. Responsive Layout Fixes for Mobile ---
    if (window.innerWidth <= 767 && document.body.classList.contains("item-view")) {
        const playerColumn = document.querySelector(".player-column-final");
        const commentForm = document.querySelector(".comment-form");

        if (playerColumn && commentForm) {
            function adjustCommentFormPos() {
                commentForm.style.top = playerColumn.offsetHeight + "px";
            }
            adjustCommentFormPos();
            window.addEventListener("resize", adjustCommentFormPos);
        }
    }

    // --- 2. Toast Notification System ---
    const toastElem = document.getElementById("toastNotification");
    const toastMsgElem = document.getElementById("toastMessage");
    const toastMessage = sessionStorage.getItem("showToastAfterReload");

    if (toastMessage) {
        if (toastElem && toastMsgElem) {
            toastMsgElem.textContent = toastMessage;
            toastElem.classList.remove("hidden");
            setTimeout(() => toastElem.classList.add("show"), 10);
            setTimeout(() => {
                toastElem.classList.remove("show");
                setTimeout(() => toastElem.classList.add("hidden"), 500);
            }, 3000);
        }
        sessionStorage.removeItem("showToastAfterReload");
    }

    // --- 3. Custom Modal System (Confirm, Alert, Prompt) ---
    const modal = document.getElementById("generic-modal");
    if (modal) {
        const modalTitle = document.getElementById("generic-modal-title");
        const modalMessage = document.getElementById("generic-modal-message");
        const modalInput = document.getElementById("generic-modal-input");
        const modalOkBtn = document.getElementById("generic-modal-ok");
        const modalCancelBtn = document.getElementById("generic-modal-cancel");
        let activeCallback = null;

        window.hideGenericModal = function() {
            modal.classList.remove("is-visible");
            activeCallback = null;
        };

        window.showCustomConfirm = function(title, message, callback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.classList.add("is-hidden");
            modalCancelBtn.style.display = "inline-block";
            modalOkBtn.textContent = "OK";
            activeCallback = callback;
            modal.classList.add("is-visible");
        };

        window.showCustomAlert = function(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.classList.add("is-hidden");
            modalCancelBtn.style.display = "none";
            modalOkBtn.textContent = "OK";
            activeCallback = null;
            modal.classList.add("is-visible");
        };

        window.showCustomPrompt = function(title, message, defaultValue, callback) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.value = defaultValue;
            modalInput.classList.remove("is-hidden");
            modalCancelBtn.style.display = "inline-block";
            modalOkBtn.textContent = "Save";
            activeCallback = callback;
            modal.classList.add("is-visible");
            setTimeout(() => modalInput.focus(), 100);
        };

        modalOkBtn.addEventListener("click", () => {
            if (typeof activeCallback === "function") {
                const value = modalInput.value;
                activeCallback(value);
            }
            hideGenericModal();
        });

        modalCancelBtn.addEventListener("click", hideGenericModal);
        modal.addEventListener("click", (e) => {
            if (e.target === modal) hideGenericModal();
        });
    }

    // --- Constants & Elements ---
    const STORAGE_KEY_USER = "abefilm_simple_user";
    const themeIconSource = document.getElementById("theme-icon-source");
    const ICON_GUEST = themeIconSource ? themeIconSource.dataset.guestIcon : "";
    const ICON_USER = themeIconSource ? themeIconSource.dataset.userIcon : "";
    const ICON_LOGGED_OUT = themeIconSource ? themeIconSource.dataset.loggedOutIcon : "";

    const watchlistContainer = document.getElementById("watchlist-container");
    const historyContainer = document.getElementById("history-container");
    const favoritesContainer = document.getElementById("favorites-container");
    const isAccountPage = window.location.pathname.includes("/p/my-account.html");


    // --- 4. Watchlist Logic ---
    if (watchlistContainer) {
        const STORAGE_KEY = "abefilmUserWatchlist";
        const grid = watchlistContainer.querySelector("#watchlist-grid");
        const emptyState = watchlistContainer.querySelector("#watchlist-empty-state");
        const editBtn = watchlistContainer.querySelector("#edit-watchlist-btn");
        const cancelBtn = watchlistContainer.querySelector("#cancel-edit-btn");
        const deleteBtn = watchlistContainer.querySelector("#delete-selected-btn");
        const selectAllCheckbox = watchlistContainer.querySelector("#select-all-checkbox");

        let isEditMode = false;
        let selectedItems = new Set();

        async function loadWatchlist() {
            let items = [];
            try {
                items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch (e) {}

            if (items.length === 0) {
                emptyState.style.display = "flex";
                grid.style.display = "none";
                watchlistContainer.classList.remove("has-content");
                toggleEditMode(false);
                editBtn.style.display = "none";
                return;
            } else {
                emptyState.style.display = "none";
                watchlistContainer.classList.add("has-content");
                renderSkeletons(items.length, grid);
                editBtn.style.display = "block";
            }

            // Fetch metadata for items
            const promises = items.map(item => fetch(item.url).then(res => res.ok ? res.text() : null).then(html => {
                if (!html) return item;
                const doc = new DOMParser().parseFromString(html, "text/html");
                const poster = doc.querySelector('img[alt="poster"]')?.src;
                const type = doc.querySelector("#extra-meta .meta-type")?.textContent.trim();
                return { ...item,
                    poster: poster || item.image,
                    type: type || "Movie"
                };
            }).catch(() => item));

            const finalItems = await Promise.all(promises);

            if (items.length > 0) {
                grid.innerHTML = "";
                finalItems.forEach(item => {
                    const el = document.createElement("div");
                    el.className = "watchlist-item grid-item";
                    el.dataset.id = item.id;
                    el.innerHTML = `
                        <a href="${isEditMode ? 'javascript:void(0);' : (item.url || '#')}" class="poster-wrapper" title="${item.title}">
                            <img src="${item.poster}" alt="${item.title}" class="poster">
                            <div class="play-icon-overlay">
                                <svg class="play-button" viewBox="0 0 60 60"><g fill="none"><circle fill="var(--keycolor)" cx="30" cy="30" r="30"></circle><path d="M35.75,22.5 L45.14,36.58 C46.06,37.96 45.69,39.83 44.31,40.75 C43.82,41.07 43.24,41.25 42.64,41.25 L23.86,41.25 C22.20,41.25 20.86,39.91 20.86,38.25 C20.86,37.66 21.03,37.08 21.36,36.59 L30.75,22.5 C31.67,21.12 33.54,20.74 34.91,21.66 C35.24,21.88 35.53,22.16 35.75,22.5 Z" fill="#FFFFFF" transform="translate(33.25, 30) rotate(-270) translate(-33.25, -30)"></path></g></svg>
                            </div>
                            <div class="selection-overlay">
                                <div class="checkmark"><i class="fas fa-check"></i></div>
                            </div>
                        </a>
                        <div class="item-info">
                            <div class="title">${item.title}</div>
                            <p class="type">${item.type}</p>
                        </div>`;
                    grid.appendChild(el);

                    el.querySelector(".poster-wrapper").addEventListener("click", (e) => {
                        if (isEditMode) {
                            e.preventDefault();
                            toggleItemSelection(item.id, el);
                        }
                    });
                });
            }
            updateSelectionState();
        }

        function renderSkeletons(count, container) {
            container.innerHTML = "";
            const logoText = document.querySelector(".sidebar-logo .logo-text")?.textContent.trim() || "";
            for (let i = 0; i < count; i++) {
                container.innerHTML += `<div class="skeleton-grid-item"><div class="skeleton-poster">${logoText}</div><div class="skeleton-info"><div class="skeleton-line title"></div><div class="skeleton-line type"></div></div></div>`;
            }
            container.style.display = "grid";
        }

        function toggleEditMode(enable) {
            isEditMode = typeof enable !== 'undefined' ? enable : !isEditMode;
            watchlistContainer.classList.toggle("edit-mode", isEditMode);
            selectedItems.clear();
            selectAllCheckbox.checked = false;
            loadWatchlist();
        }

        function toggleItemSelection(id, element) {
            if (!isEditMode) return;
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
                element.classList.remove("selected");
            } else {
                selectedItems.add(id);
                element.classList.add("selected");
            }
            updateSelectionState();
        }

        function updateSelectionState() {
            deleteBtn.disabled = selectedItems.size === 0;
            deleteBtn.style.opacity = selectedItems.size === 0 ? 0.5 : 1;
            const allItems = document.querySelectorAll(".watchlist-item");
            selectAllCheckbox.checked = allItems.length > 0 && selectedItems.size === allItems.length;
        }

        editBtn.addEventListener("click", () => toggleEditMode(true));
        cancelBtn.addEventListener("click", () => toggleEditMode(false));
        selectAllCheckbox.addEventListener("change", () => {
            const checked = selectAllCheckbox.checked;
            document.querySelectorAll(".watchlist-item").forEach(el => {
                const id = el.dataset.id;
                if (checked && !selectedItems.has(id)) {
                    selectedItems.add(id);
                    el.classList.add("selected");
                } else if (!checked && selectedItems.has(id)) {
                    selectedItems.delete(id);
                    el.classList.remove("selected");
                }
            });
            updateSelectionState();
        });

        deleteBtn.addEventListener("click", () => {
            if (selectedItems.size !== 0) {
                showCustomConfirm("Delete Items", "Are you sure you want to delete " + selectedItems.size + " selected item(s)?", () => {
                    let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
                    items = items.filter(i => !selectedItems.has(i.id));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    if (typeof window.renderWatchlistPanel === "function") window.renderWatchlistPanel();
                    if (typeof window.updateWatchlistBadge === "function") window.updateWatchlistBadge();
                    toggleEditMode(false);
                });
            }
        });

        loadWatchlist();
        window.addEventListener("storage", (e) => {
            if (e.key === STORAGE_KEY) loadWatchlist();
        });
    }

    // --- 5. History Logic ---
    if (historyContainer) {
        const STORAGE_KEY = "watchHistoryIDs";
        const grid = historyContainer.querySelector("#history-grid");
        const emptyState = historyContainer.querySelector("#history-empty-state");
        const editBtn = historyContainer.querySelector("#edit-history-btn");
        const cancelBtn = historyContainer.querySelector("#cancel-edit-btn");
        const deleteBtn = historyContainer.querySelector("#delete-selected-btn");
        const selectAllCheckbox = historyContainer.querySelector("#select-all-checkbox");

        let isEditMode = false;
        let selectedItems = new Set();

        async function loadHistory() {
            let ids = [];
            try {
                ids = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch (e) {}
            const progressData = JSON.parse(localStorage.getItem("abefilmWatchProgress") || "{}");

            if (ids.length === 0) {
                emptyState.style.display = "flex";
                grid.style.display = "none";
                historyContainer.classList.remove("has-content");
                toggleHistoryEditMode(false);
                editBtn.style.display = "none";
            } else {
                emptyState.style.display = "none";
                historyContainer.classList.add("has-content");
                // Uses same skeleton function logic as watchlist if abstracted, 
                // but kept inline here per original logic structure
                grid.innerHTML = "";
                const logoText = document.querySelector(".sidebar-logo .logo-text")?.textContent.trim() || "";
                for (let i = 0; i < ids.length; i++) {
                    grid.innerHTML += `<div class="skeleton-grid-item"><div class="skeleton-poster">${logoText}</div><div class="skeleton-info"><div class="skeleton-line title"></div><div class="skeleton-line type"></div></div></div>`;
                }
                grid.style.display = "grid";
                editBtn.style.display = "block";
            }

            const promises = ids.map(id => fetch("/feeds/posts/default/" + id + "?alt=json").then(res => res.ok ? res.json() : null).then(data => {
                if (!data || !data.entry) return null;
                const entry = data.entry;
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = entry.content.$t;

                const backdrop = tempDiv.querySelector("span.slider-backdrop")?.textContent.trim();
                const poster = tempDiv.querySelector('img[alt="poster"]')?.src;
                const type = tempDiv.querySelector("#extra-meta .meta-type")?.textContent.trim();
                const episodesList = tempDiv.querySelector("#episodes-data ul[data-server-name]");
                const totalEpisodes = episodesList ? episodesList.querySelectorAll("a").length : 0;
                const watchedCount = progressData["post-" + id] || 0;
                let percent = 0;

                if (totalEpisodes > 1) {
                    percent = ((watchedCount + 1) / totalEpisodes) * 100;
                } else if (totalEpisodes === 1 || (totalEpisodes === 0 && type !== "TV Series")) {
                    percent = 100;
                }

                return {
                    id: id,
                    url: entry.link.find(l => l.rel === "alternate").href,
                    title: entry.title.$t,
                    image: backdrop || poster,
                    type: type || "Movie",
                    progressPercent: percent
                };
            }).catch(() => null));

            const items = (await Promise.all(promises)).filter(Boolean);

            if (items.length > 0) {
                grid.innerHTML = "";
                items.forEach(item => {
                    const el = document.createElement("div");
                    el.className = "history-item grid-item";
                    el.dataset.id = item.id;
                    el.innerHTML = `
                        <a href="${isEditMode ? 'javascript:void(0);' : (item.url || '#')}" class="poster-wrapper">
                            <img src="${item.image}" alt="${item.title}" class="poster">
                            <div class="play-icon-overlay"><svg class="play-button" viewBox="0 0 60 60"><g fill="none"><circle fill="var(--keycolor)" cx="30" cy="30" r="30"></circle><path d="M35.75,22.5 L45.14,36.58 C46.06,37.96 45.69,39.83 44.31,40.75 C43.82,41.07 43.24,41.25 42.64,41.25 L23.86,41.25 C22.20,41.25 20.86,39.91 20.86,38.25 C20.86,37.66 21.03,37.08 21.36,36.59 L30.75,22.5 C31.67,21.12 33.54,20.74 34.91,21.66 C35.24,21.88 35.53,22.16 35.75,22.5 Z" fill="#FFFFFF" transform="translate(33.25, 30) rotate(-270) translate(-33.25, -30)"></path></g></svg></div>
                            <div class="selection-overlay"><div class="checkmark"></div></div>
                            <div class="progress-bar-overlay"><div class="progress-bar-fill" style="width: ${item.progressPercent}%;"></div></div>
                        </a>
                        <div class="item-info">
                            <div class="title">${item.title}</div>
                            <p class="type">${item.type}</p>
                        </div>`;
                    grid.appendChild(el);
                    el.querySelector(".poster-wrapper").addEventListener("click", (e) => {
                        if (isEditMode) {
                            e.preventDefault();
                            toggleHistorySelection(item.id, el);
                        }
                    });
                });
            }
            updateHistorySelectionState();
        }

        function toggleHistorySelection(id, element) {
            if (!isEditMode) return;
            const strId = String(id);
            if (selectedItems.has(strId)) {
                selectedItems.delete(strId);
                element.classList.remove("selected");
            } else {
                selectedItems.add(strId);
                element.classList.add("selected");
            }
            updateHistorySelectionState();
        }

        function toggleHistoryEditMode(enable) {
            isEditMode = typeof enable !== 'undefined' ? enable : !isEditMode;
            historyContainer.classList.toggle("edit-mode", isEditMode);
            selectedItems.clear();
            selectAllCheckbox.checked = false;
            loadHistory();
        }

        function updateHistorySelectionState() {
            deleteBtn.disabled = selectedItems.size === 0;
            deleteBtn.style.opacity = selectedItems.size === 0 ? 0.5 : 1;
            const allItems = document.querySelectorAll(".history-item");
            selectAllCheckbox.checked = allItems.length > 0 && selectedItems.size === allItems.length;
        }

        editBtn.addEventListener("click", () => toggleHistoryEditMode(true));
        cancelBtn.addEventListener("click", () => toggleHistoryEditMode(false));
        selectAllCheckbox.addEventListener("change", () => {
            const checked = selectAllCheckbox.checked;
            document.querySelectorAll(".history-item").forEach(el => {
                if (checked && !el.classList.contains("selected")) toggleHistorySelection(el.dataset.id, el);
                else if (!checked && el.classList.contains("selected")) toggleHistorySelection(el.dataset.id, el);
            });
        });

        deleteBtn.addEventListener("click", () => {
            if (selectedItems.size !== 0) {
                showCustomConfirm("Delete History", "Are you sure you want to delete " + selectedItems.size + " selected item(s) from your history?", () => {
                    let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
                    items = items.filter(id => !selectedItems.has(String(id)));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    if (typeof window.displayHistory === "function") window.displayHistory();
                    if (typeof window.updateHistoryBadge === "function") window.updateHistoryBadge();
                    toggleHistoryEditMode(false);
                });
            }
        });

        loadHistory();
        window.addEventListener("storage", (e) => {
            if (e.key === STORAGE_KEY) loadHistory();
        });
    }

    // --- 6. Favorites Logic ---
    if (favoritesContainer) {
        const STORAGE_KEY = "abefilm_favorites";
        const listContainer = favoritesContainer.querySelector("#favorites-list");
        const emptyState = favoritesContainer.querySelector("#favorites-empty-state");
        const editBtn = favoritesContainer.querySelector("#edit-favorites-btn");
        const cancelBtn = favoritesContainer.querySelector("#cancel-edit-btn");
        const deleteBtn = favoritesContainer.querySelector("#delete-selected-btn");
        const selectAllCheckbox = favoritesContainer.querySelector("#select-all-checkbox");

        let isEditMode = false;
        let selectedItems = new Set();

        async function loadFavorites() {
            let ids = [];
            try {
                ids = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            } catch (e) {}

            if (ids.length === 0) {
                emptyState.style.display = "flex";
                listContainer.style.display = "none";
                favoritesContainer.classList.remove("has-content");
                toggleFavoritesEditMode(false);
                if (editBtn) editBtn.style.display = "none";
            } else {
                emptyState.style.display = "none";
                favoritesContainer.classList.add("has-content");
                // Render list skeletons
                listContainer.innerHTML = "";
                for (let i = 0; i < ids.length; i++) {
                    listContainer.innerHTML += `
                        <div class="skeleton-list-item">
                           <div class="skeleton-poster"></div>
                           <div class="skeleton-details">
                             <div class="skeleton-line title"></div>
                             <div class="skeleton-line meta"></div>
                             <div class="skeleton-line text"></div>
                             <div class="skeleton-line text short"></div>
                             <div class="skeleton-line button"></div>
                           </div>
                        </div>`;
                }
                listContainer.style.display = "grid";
                if (editBtn) editBtn.style.display = "block";
            }

            const promises = ids.map(id => fetch("/feeds/posts/default/" + id + "?alt=json").then(res => res.ok ? res.json() : null).then(data => {
                if (!data || !data.entry) return null;
                const entry = data.entry;
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = entry.content.$t;

                const poster = tempDiv.querySelector('img[alt="poster"]')?.src;
                const type = tempDiv.querySelector("#extra-meta .meta-type")?.textContent.trim();
                const year = tempDiv.querySelector("#extra-meta .meta-year")?.textContent.trim();
                const rating = tempDiv.querySelector("#extra-meta .meta-rating")?.textContent.trim();
                const synopsis = tempDiv.querySelector("#overview-data")?.textContent.trim();

                return {
                    id: id,
                    url: entry.link.find(l => l.rel === "alternate").href,
                    title: entry.title.$t,
                    poster: poster,
                    type: type,
                    year: year,
                    rating: rating,
                    synopsis: synopsis
                };
            }).catch(() => null));

            const items = (await Promise.all(promises)).filter(Boolean);

            if (items.length > 0) {
                listContainer.innerHTML = "";
                items.forEach(item => {
                    const el = document.createElement("div");
                    el.className = "favorite-item";
                    el.dataset.id = item.id;
                    el.innerHTML = `
                        <a href="${item.url}" class="item-poster-link"><img src="${item.poster}" alt="${item.title}"></a>
                        <div class="item-details">
                            <div class="title-wrapper">
                                <h3 class="title">${item.title}</h3>
                                <label class="selection-checkbox-wrapper">
                                    <input type="checkbox" class="item-checkbox" data-id="${item.id}">
                                    <span class="custom-checkbox"></span>
                                </label>
                            </div>
                            <div class="item-meta">
                                ${item.rating ? `<span class="rating"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: text-bottom;"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg> ${item.rating}</span>` : ""}
                                ${item.year ? `<span>${item.year}</span>` : ""}
                                ${item.type ? `<span>${item.type}</span>` : ""}
                            </div>
                            <p class="item-synopsis">${item.synopsis || ""}</p>
                            <div class="item-actions">
                                <a href="${item.url}" class="btn play-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -2px;"><path d="M10.804 8 5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z"/></svg> Play
                                </a>
                            </div>
                        </div>`;
                    listContainer.appendChild(el);

                    const checkbox = el.querySelector(".item-checkbox");
                    el.addEventListener("click", (e) => {
                        if (isEditMode) {
                            if (!e.target.closest("a")) {
                                e.preventDefault();
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event("change"));
                            }
                        } else {
                            if (!e.target.closest("a")) window.location.href = item.url;
                        }
                    });

                    checkbox.addEventListener("change", () => {
                        const id = item.id;
                        const isChecked = checkbox.checked;
                        if (isEditMode) {
                            if (isChecked) {
                                selectedItems.add(String(id));
                                el.classList.add("selected");
                            } else {
                                selectedItems.delete(String(id));
                                el.classList.remove("selected");
                            }
                            updateFavoritesSelectionState();
                        }
                    });
                });
            }
            updateFavoritesSelectionState();
        }

        function toggleFavoritesEditMode(enable) {
            isEditMode = typeof enable !== 'undefined' ? enable : !isEditMode;
            favoritesContainer.classList.toggle("edit-mode", isEditMode);
            if (!isEditMode) {
                selectedItems.clear();
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
                document.querySelectorAll(".favorite-item.selected").forEach(el => {
                    el.classList.remove("selected");
                    const cb = el.querySelector(".item-checkbox");
                    if (cb) cb.checked = false;
                });
            }
            updateFavoritesSelectionState();
        }

        function updateFavoritesSelectionState() {
            if (!deleteBtn) return;
            deleteBtn.disabled = selectedItems.size === 0;
            deleteBtn.style.opacity = selectedItems.size === 0 ? 0.5 : 1;
            const allItems = document.querySelectorAll(".favorite-item");
            if (selectAllCheckbox) selectAllCheckbox.checked = allItems.length > 0 && selectedItems.size === allItems.length;
        }

        if (editBtn) editBtn.addEventListener("click", () => toggleFavoritesEditMode(true));
        if (cancelBtn) cancelBtn.addEventListener("click", () => toggleFavoritesEditMode(false));
        if (selectAllCheckbox) selectAllCheckbox.addEventListener("change", () => {
            const checked = selectAllCheckbox.checked;
            document.querySelectorAll(".item-checkbox").forEach(cb => {
                if (cb.checked !== checked) {
                    cb.checked = checked;
                    cb.dispatchEvent(new Event("change"));
                }
            });
        });

        if (deleteBtn) deleteBtn.addEventListener("click", () => {
            if (selectedItems.size !== 0) {
                showCustomConfirm("Delete Favorites", "Are you sure you want to delete " + selectedItems.size + " selected item(s)?", () => {
                    let items = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
                    items = items.filter(id => !selectedItems.has(String(id)));
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
                    toggleFavoritesEditMode(false);
                    loadFavorites();
                });
            }
        });

        loadFavorites();
        window.addEventListener("storage", (e) => {
            if (e.key === STORAGE_KEY) loadFavorites();
        });
    }

    // --- 7. Account Page Rendering & Logic ---
    if (isAccountPage) {
        const appContainer = document.getElementById("my-account-app");
        if (appContainer) {
            const communitySection = document.getElementById("community-section-source");
            
            // Build the HTML Structure
            const accountHTML = `
                <div class="account-page-container">
                    <div class="account-profile-section">
                        <div class="account-profile-avatar-wrapper"><img id="account-page-avatar-img" src="" alt="User Avatar" /></div>
                        <div class="account-profile-info"><h2 id="account-page-name" class="account-profile-name"></h2></div>
                    </div>
                    <div class="account-list-section" id="account-section-header">
                        <h3 class="section-header">Account</h3>
                        <div class="account-list-item" id="username-list-item">
                            <span class="item-label">
                                <svg fill="#fff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><path d="M3.29,16.09,8.2,21H11V18.2L6.09,13.29a1,1,0,0,0-1.4,0l-1.4,1.4A1,1,0,0,0,3.29,16.09Z" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path><path d="M13,13h1a7,7,0,0,1,7,7,1,1,0,0,1-1,1H15" style="fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path><circle cx="13" cy="8" r="5" style="fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></circle></svg> Username
                            </span>
                            <a href="javascript:void(0)" class="item-action" id="edit-username-btn"><span id="account-page-username-value" class="item-value"></span><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                        <div class="account-list-item" id="avatar-list-item">
                            <span class="item-label">
                                <svg fill="#fff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><path d="M13,7.13A3.66,3.66,0,0,0,12,7a4,4,0,1,0,3.46,6" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path><path d="M12,15a5,5,0,0,0-5,4.5,9,9,0,0,0,9.94,0A5,5,0,0,0,12,15Zm5-6h4M19,7v4" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path><path d="M20.48,15a8.86,8.86,0,0,1-2.12,3.36A9,9,0,1,1,16,3.94" style="fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path></svg> Avatar
                            </span>
                            <a href="javascript:void(0)" class="item-action avatar-action" id="edit-avatar-btn"><div class="item-avatar-preview"><img id="account-page-avatar-preview-img" src="" alt="Current Avatar" /></div><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                    </div>
                    <div class="account-list-section" id="my-content-section">
                        <h3 class="section-header">My Content</h3>
                        <div class="account-list-item">
                            <div class="item-label-group">
                                <span class="item-label"><svg fill="#fff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><polygon points="5.76 16.3 3 16.67 5 18.47 4.53 21 7 19.8 9.47 21 9 18.47 11 16.67 8.24 16.3 7 14 5.76 16.3" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></polygon><path d="M7,10V4A1,1,0,0,1,8,3h9l4,4V20a1,1,0,0,1-1,1H14" style="fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path></svg> Watchlist</span>
                                <span class="item-count" data-count-for="watchlist"></span>
                            </div>
                            <a href="/p/watchlist.html" class="item-action"><span>View All</span><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                        <div class="account-list-item">
                            <div class="item-label-group">
                                <span class="item-label"><svg fill="#ffffff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><polyline points="8 12 12 12 12 7" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></polyline><path d="M12,3a9,9,0,1,1-9,9" style="fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path></svg> Watch History</span>
                                <span class="item-count" data-count-for="history"></span>
                            </div>
                            <a href="/p/history.html" class="item-action"><span>View All</span><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                         <div class="account-list-item">
                            <div class="item-label-group">
                                <span class="item-label"><svg fill="#fff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><path d="M16.84,13.72l-.34.34-.34-.34a2.43,2.43,0,0,0-3.45,0,2.47,2.47,0,0,0,0,3.47l1,1L16.5,21l2.75-2.77,1-1a2.47,2.47,0,0,0,0,3.47A2.43,2.43,0,0,0,16.84,13.72Z" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path><path d="M10,20H4a1,1,0,0,1-1-1V4A1,1,0,0,1,4,3h8.59a1,1,0,0,1,.7.29l3.42,3.42a1,1,0,0,1,.29.7V9" style="fill:none;stroke:#ffffff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path></svg> Favorite</span>
                                <span class="item-count" data-count-for="favorite"></span>
                            </div>
                            <a href="/p/favorite.html" class="item-action"><span>View All</span><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                    </div>
                    <div class="account-list-section">
                        <h3 class="section-header">Settings & Data</h3>
                        <div class="account-list-item">
                            <span class="item-label">
                                <svg fill="#000000" width="20px" height="20px" viewBox="0 0 24 24" class="icon flat-color"><circle cx="12" cy="12" r="10" style="fill:#fff;"></circle><path d="M22,12A10,10,0,0,1,12,22V2A10,10,0,0,1,22,12Z" style="fill:var(--keycolor);"></path></svg> Theme
                            </span>
                            <a href="javascript:void(0)" class="item-action" id="open-theme-settings-modal-mobile">
                                <span class="item-value">Customize</span>
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                            </a>
                        </div>
                        <div class="account-list-item">
                             <span class="item-label"><svg fill="#fff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><path d="M16,7V4a1,1,0,0,0-1-1H9A1,1,0,0,0,8,4V7m4,4v6" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path><path d="M4,7H20M17.07,20.07,18,7H6l.93,13.07a1,1,0,0,0,1,.93h8.14A1,1,0,0,0,17.07,20.07Z" style="fill:none;stroke:#ffffff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path></svg> Clear Cache</span>
                             <a href="javascript:void(0)" class="item-action" id="clear-cache-btn"><span class="item-value">0 KB</span><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                        <div class="account-list-item" id="logout-list-item">
                            <span class="item-label"><svg fill="#fff" width="20px" height="20px" viewBox="0 0 24 24" class="icon line-color"><polyline points="10 15 7 12 10 9" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></polyline><line x1="7" y1="12" x2="21" y2="12" style="fill:none;stroke:var(--keycolor);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></line><path d="M14,16v3a1,1,0,0,1-1,1H4a1,1,0,0,1-1-1V5A1,1,0,0,1,4,4h9a1,1,0,0,1,1,1V8" style="fill:none;stroke:#ffffff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"></path></svg> Logout</span>
                            <a href="javascript:void(0)" class="item-action" id="account-page-logout-btn"><span class="item-value">Proceed</span><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                        </div>
                    </div>
                </div>`;

            appContainer.innerHTML = accountHTML;
            if (communitySection) {
                communitySection.style.display = "flex";
                appContainer.querySelector(".account-page-container").appendChild(communitySection);
            }
            appContainer.insertAdjacentHTML("afterend", '<div class="avatar-modal-overlay" id="avatar-modal"><div class="avatar-modal-box"><div class="avatar-modal-header"><h3>Choose Your Avatar</h3><button class="avatar-modal-close" id="avatar-modal-close">&times;</button></div><div class="avatar-category-tabs" id="avatar-category-tabs"></div><div class="avatar-grid" id="avatar-grid"></div></div></div>');

            // Select Elements
            const avatarImg = document.getElementById("account-page-avatar-img");
            const nameElem = document.getElementById("account-page-name");
            const usernameVal = document.getElementById("account-page-username-value");
            const avatarPreview = document.getElementById("account-page-avatar-preview-img");
            const accountHeader = document.getElementById("account-section-header");
            const usernameItem = document.getElementById("username-list-item");
            const avatarItem = document.getElementById("avatar-list-item");
            const logoutItem = document.getElementById("logout-list-item");
            const contentSection = document.getElementById("my-content-section");
            
            const editUsernameBtn = document.getElementById("edit-username-btn");
            const clearCacheBtn = document.getElementById("clear-cache-btn");
            const logoutBtn = document.getElementById("account-page-logout-btn");
            const editAvatarBtn = document.getElementById("edit-avatar-btn");
            const avatarModal = document.getElementById("avatar-modal");
            const closeAvatarModal = document.getElementById("avatar-modal-close");
            const categoryTabs = document.getElementById("avatar-category-tabs");
            const avatarGrid = document.getElementById("avatar-grid");
            const openThemeBtn = document.getElementById("open-theme-settings-modal-mobile");
            const themeOverlay = document.getElementById("theme-settings-overlay");

            // Logic: Render User Data
            function renderAccountPage() {
                const userData = JSON.parse(localStorage.getItem(STORAGE_KEY_USER));
                const profileSection = document.querySelector(".account-profile-section");

                if (userData && userData.name) {
                    profileSection.classList.remove("is-logged-out");
                    const isGuest = !!userData.isGuest;
                    const avatar = isGuest ? ICON_GUEST : (userData.avatar || ICON_USER);

                    avatarImg.src = avatar;
                    nameElem.innerHTML = userData.name;
                    usernameVal.textContent = userData.name;
                    avatarPreview.src = avatar;

                    accountHeader.style.display = "block";
                    usernameItem.style.display = "flex";
                    avatarItem.style.display = "flex";
                    logoutItem.style.display = "flex";
                    contentSection.style.display = "block";

                    // Disable editing for guests
                    editUsernameBtn.style.cursor = isGuest ? "default" : "pointer";
                    editAvatarBtn.style.cursor = isGuest ? "default" : "pointer";
                    
                    const editUserIcon = document.querySelector("#edit-username-btn svg");
                    const editAvatarIcon = document.querySelector("#edit-avatar-btn svg");
                    if (editUserIcon) editUserIcon.style.display = isGuest ? "none" : "inline-block";
                    if (editAvatarIcon) editAvatarIcon.style.display = isGuest ? "none" : "inline-block";

                    // Handle linking logic if not on account page directly (edge case)
                    if (profileSection.tagName.toLowerCase() !== "a" || !profileSection.href.includes("/p/my-account.html")) {
                        const newLink = document.createElement("a");
                        newLink.href = "/p/my-account.html";
                        newLink.className = profileSection.className;
                        while(profileSection.firstChild) newLink.appendChild(profileSection.firstChild);
                        profileSection.parentNode.replaceChild(newLink, profileSection);
                    }
                } else {
                    // Logged Out State
                    profileSection.classList.add("is-logged-out");
                    avatarImg.src = ICON_LOGGED_OUT;
                    nameElem.innerHTML = 'Login <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width: 0.8em; height: 0.8em; vertical-align: middle; margin-left: 4px;"><path d="M9 18l6-6-6-6"/></svg>';
                    usernameVal.textContent = "Not logged in";
                    
                    accountHeader.style.display = "block";
                    usernameItem.style.display = "flex";
                    avatarItem.style.display = "none";
                    contentSection.style.display = "none";
                    logoutItem.style.display = "none";

                    if (profileSection.tagName.toLowerCase() !== "a" || profileSection.id !== "showLoginModalBtn") {
                        const newLink = document.createElement("a");
                        newLink.href = "#";
                        newLink.id = "showLoginModalBtn";
                        newLink.className = profileSection.className;
                        while(profileSection.firstChild) newLink.appendChild(profileSection.firstChild);
                        profileSection.parentNode.replaceChild(newLink, profileSection);
                    }
                }

                // Update Counts
                const counts = {
                    watchlist: (JSON.parse(localStorage.getItem("abefilmUserWatchlist")) || []).length,
                    history: (JSON.parse(localStorage.getItem("watchHistoryIDs")) || []).length,
                    favorite: (JSON.parse(localStorage.getItem("abefilm_favorites")) || []).length
                };
                for (let key in counts) {
                    const count = counts[key];
                    const badge = document.querySelector('.item-count[data-count-for="' + key + '"]');
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = "inline-block";
                        } else {
                            badge.style.display = "none";
                        }
                    }
                }

                // Calculate Cache Size
                let totalSize = 0;
                for (let x in localStorage) {
                    if (localStorage.hasOwnProperty(x)) totalSize += ((localStorage[x].length + x.length) * 2);
                }
                for (let x in sessionStorage) {
                    if (sessionStorage.hasOwnProperty(x)) totalSize += ((sessionStorage[x].length + x.length) * 2);
                }
                let sizeString = totalSize < 1024 ? "0 KB" : totalSize < 1024 * 1024 ? (totalSize / 1024).toFixed(2) + " KB" : (totalSize / (1024 * 1024)).toFixed(2) + " MB";
                const cacheVal = document.querySelector("#clear-cache-btn span");
                if (cacheVal) cacheVal.textContent = sizeString;
            }

            // Logic: Avatar Selection
            function renderAvatarGrid(index, categories) {
                avatarGrid.innerHTML = "";
                const category = categories[index];
                if (category) {
                    category.avatars.forEach(src => {
                        const div = document.createElement("div");
                        div.className = "avatar-choice";
                        div.innerHTML = '<img src="' + src + '" alt="Avatar">';
                        div.addEventListener("click", () => {
                             let user = JSON.parse(localStorage.getItem(STORAGE_KEY_USER));
                             if (user && !user.isGuest) {
                                 user.avatar = src;
                                 localStorage.setItem(STORAGE_KEY_USER, JSON.stringify(user));
                                 sessionStorage.setItem("showToastAfterReload", "Avatar updated successfully.");
                                 location.reload();
                             }
                        });
                        avatarGrid.appendChild(div);
                    });
                    document.querySelectorAll(".avatar-category-tab").forEach((tab, i) => tab.classList.toggle("active", i === index));
                }
            }

            function hideAvatarModal() {
                avatarModal.classList.remove("is-visible");
            }

            // Event Listeners for Account Page
            editAvatarBtn.addEventListener("click", () => {
                const user = JSON.parse(localStorage.getItem(STORAGE_KEY_USER));
                if (user && !user.isGuest) avatarModal.classList.add("is-visible");
            });

            closeAvatarModal.addEventListener("click", hideAvatarModal);
            avatarModal.addEventListener("click", (e) => { if (e.target === avatarModal) hideAvatarModal(); });

            editUsernameBtn.addEventListener("click", (e) => {
                e.preventDefault();
                let user = JSON.parse(localStorage.getItem(STORAGE_KEY_USER));
                if (user && !user.isGuest) {
                    showCustomPrompt("Edit Username", "Enter your new display name:", user.name, (val) => {
                        if (val && val.trim() !== "") {
                            user.name = val.trim();
                            localStorage.setItem(STORAGE_KEY_USER, JSON.stringify(user));
                            sessionStorage.setItem("showToastAfterReload", "Username updated successfully.");
                            location.reload();
                        } else if (val !== null) {
                            showCustomAlert("Invalid Name", "Display name cannot be empty.");
                        }
                    });
                }
            });

            clearCacheBtn.addEventListener("click", (e) => {
                e.preventDefault();
                showCustomConfirm("Confirm Clear Cache", "This will clear your watch history, favorites, and watchlist. Are you sure?", () => {
                    const keepKeys = [STORAGE_KEY_USER, "sidebarState", "supabase_client_id"];
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (!keepKeys.includes(key) && !key.startsWith("slider_cache_")) {
                            localStorage.removeItem(key);
                        }
                    }
                    sessionStorage.clear();
                    sessionStorage.setItem("showToastAfterReload", "Cache has been cleared.");
                    location.reload();
                });
            });

            logoutBtn.addEventListener("click", (e) => {
                e.preventDefault();
                showCustomConfirm("Confirm Logout", "Are you sure you want to log out?", () => {
                    localStorage.removeItem(STORAGE_KEY_USER);
                    sessionStorage.setItem("showToastAfterReload", "You have been logged out.");
                    location.reload();
                });
            });

            if (openThemeBtn && themeOverlay) {
                openThemeBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    themeOverlay.style.display = "flex";
                    setTimeout(() => themeOverlay.classList.add("is-visible"), 10);
                });
            }

            // Init Account Page
            renderAccountPage();

            // Load Avatars Source
            const avatarSource = document.getElementById("avatar-data-source");
            if (avatarSource) {
                const categories = Array.from(avatarSource.children).map(cat => ({
                    name: cat.dataset.name,
                    avatars: Array.from(cat.querySelectorAll("img")).map(img => img.src)
                }));
                categoryTabs.innerHTML = "";
                categories.forEach((cat, index) => {
                    const btn = document.createElement("button");
                    btn.className = "avatar-category-tab";
                    btn.textContent = cat.name;
                    btn.addEventListener("click", () => renderAvatarGrid(index, categories));
                    categoryTabs.appendChild(btn);
                });
                if (categories.length > 0) renderAvatarGrid(0, categories);
            }

            window.addEventListener("storage", (e) => {
                if (e.key === STORAGE_KEY_USER) renderAccountPage();
            });
        }
    }

    // --- 8. Login Modal Logic ---
    const loginOverlay = document.getElementById("loginModalOverlay");
    const cancelLoginBtn = document.getElementById("cancelLoginBtn");
    const loginWithDisplayNameBtn = document.getElementById("loginWithDisplayNameBtn");
    const loginAsGuestBtn = document.getElementById("loginAsGuestBtn");
    const displayNameInput = document.getElementById("displayNameInput");

    if (loginOverlay) {
        function hideLoginModal() {
            loginOverlay.classList.add("hidden");
        }

        document.addEventListener("click", function(e) {
            if (e.target.id === "showLoginModalBtn" || e.target.closest("#showLoginModalBtn")) {
                e.preventDefault();
                loginOverlay.classList.remove("hidden");
                if (displayNameInput) displayNameInput.focus();
            }
        });

        if (cancelLoginBtn) cancelLoginBtn.addEventListener("click", hideLoginModal);
        loginOverlay.addEventListener("click", (e) => { if (e.target === loginOverlay) hideLoginModal(); });

        if (loginWithDisplayNameBtn) {
            loginWithDisplayNameBtn.addEventListener("click", () => {
                const name = displayNameInput.value.trim();
                if (name) {
                    localStorage.setItem(STORAGE_KEY_USER, JSON.stringify({ name: name, isGuest: false }));
                    sessionStorage.setItem("showToastAfterReload", "Logged in as " + name);
                    location.reload();
                } else {
                    if (window.showCustomAlert) showCustomAlert("Login Error", "Please enter a display name.");
                    else alert("Please enter a display name.");
                }
            });
        }

        if (loginAsGuestBtn) {
            loginAsGuestBtn.addEventListener("click", () => {
                localStorage.setItem(STORAGE_KEY_USER, JSON.stringify({ name: "Guest", isGuest: true }));
                sessionStorage.setItem("showToastAfterReload", "Logged in as Guest.");
                location.reload();
            });
        }
    }

    // --- 9. Header User Dropdown & Status ---
    const userLoggedOutDiv = document.getElementById("user-logged-out");
    const userLoggedInDiv = document.getElementById("user-logged-in");
    const loggedInUserName = document.getElementById("loggedInUserName");
    const userAvatar = document.getElementById("userAvatar");
    const modalUserName = document.getElementById("modalUserName");
    const modalUserAvatar = document.getElementById("modalUserAvatar");
    const modalClearDataBtn = document.getElementById("modalClearDataBtn");
    const modalLogoutBtn = document.getElementById("modalLogoutBtn");

    if (modalLogoutBtn) {
        modalLogoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (window.showCustomConfirm) {
                showCustomConfirm("Confirm Logout", "Are you sure you want to log out?", () => {
                    localStorage.removeItem(STORAGE_KEY_USER);
                    sessionStorage.setItem("showToastAfterReload", "You have been logged out.");
                    location.reload();
                });
            }
        });
    }

    if (modalClearDataBtn) {
        modalClearDataBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (window.showCustomConfirm) {
                showCustomConfirm("Confirm Clear Cache", "This will clear your watch history, favorites, and watchlist. Are you sure?", () => {
                    const keepKeys = [STORAGE_KEY_USER, "sidebarState", "supabase_client_id"];
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (!keepKeys.includes(key) && !key.startsWith("slider_cache_")) {
                            localStorage.removeItem(key);
                        }
                    }
                    sessionStorage.clear();
                    sessionStorage.setItem("showToastAfterReload", "Cache has been cleared.");
                    location.reload();
                });
            }
        });
    }

    if (userLoggedInDiv) {
        function updateHeaderUserStatus() {
            const user = JSON.parse(localStorage.getItem(STORAGE_KEY_USER));
            if (user && user.name) {
                const avatar = user.isGuest ? ICON_GUEST : (user.avatar || ICON_USER);
                loggedInUserName.textContent = user.name;
                userAvatar.src = avatar;
                modalUserName.textContent = user.name;
                modalUserAvatar.src = avatar;
                userLoggedInDiv.classList.remove("hidden");
                userLoggedOutDiv.classList.add("hidden");
            } else {
                const loggedOutAvatar = document.getElementById("logged-out-avatar");
                const loggedOutName = document.getElementById("logged-out-name");
                if (loggedOutAvatar) loggedOutAvatar.src = ICON_LOGGED_OUT;
                if (loggedOutName) loggedOutName.textContent = "Me";
                userLoggedInDiv.classList.add("hidden");
                userLoggedOutDiv.classList.remove("hidden");
            }
        }
        updateHeaderUserStatus();
    }

    // --- 10. Header Dropdown Panels (Notification, Watchlist, History) ---
    const panelTriggers = document.querySelectorAll("[data-panel-target]");
    const notificationOverlay = document.getElementById("notification-overlay");
    let panelTimeout;

    function positionPanel(trigger, panel) {
        const arrow = panel.querySelector(".watchlist-panel-arrow");
        const rect = trigger.getBoundingClientRect();
        const panelWidth = panel.offsetWidth;
        
        let center = rect.left + (rect.width / 2);
        let left = center - (panelWidth / 2);

        // Boundary checks
        if (left < 20) left = 20;
        if (left + panelWidth > window.innerWidth - 20) left = window.innerWidth - panelWidth - 20;

        panel.style.left = left + "px";
        panel.style.right = "auto";

        if (arrow) {
            const arrowLeft = center - left;
            panel.style.setProperty("--arrow-position-left", arrowLeft + "px");
        }
    }

    // Click handling (Mobile & Desktop click)
    panelTriggers.forEach(trigger => {
        trigger.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            const targetId = this.getAttribute("data-panel-target");
            const panel = document.querySelector(targetId);
            if (!panel) return;

            const isVisible = panel.classList.contains("is-visible");

            // Close others
            document.querySelectorAll(".header-dropdown-panel.is-visible").forEach(p => {
                if (p !== panel) p.classList.remove("is-visible");
            });
            if (notificationOverlay) notificationOverlay.classList.remove("is-visible");

            if (!isVisible) {
                panel.classList.add("is-visible");
                
                // Specific Mobile Logic for Notifications
                if (targetId === "#notification-panel" && window.innerWidth <= 767) {
                    if (notificationOverlay) notificationOverlay.classList.add("is-visible");
                }
                
                // Position for Desktop
                if (window.innerWidth > 767) {
                    positionPanel(this, panel);
                }

                // Sync Content
                if (targetId === "#notification-panel") {
                    const content = document.getElementById("notification-panel-content");
                    const source = document.getElementById("header-notifications");
                    if (content && source) content.innerHTML = source.innerHTML;
                }
                
                // Trigger refresh if needed
                if (targetId === "#history-panel" && typeof displayHistory === "function") displayHistory();
                if (targetId === "#watchlist-panel" && typeof renderWatchlistPanel === "function") renderWatchlistPanel();
            }
        });
    });

    // Close when clicking outside
    document.addEventListener("click", function(e) {
        if (!e.target.closest("[data-panel-target]") && !e.target.closest(".header-dropdown-panel")) {
            document.querySelectorAll(".header-dropdown-panel.is-visible").forEach(p => p.classList.remove("is-visible"));
            if (notificationOverlay) notificationOverlay.classList.remove("is-visible");
        }
    });

    // Hover handling (Desktop only)
    if (window.innerWidth > 767) {
        panelTriggers.forEach(trigger => {
            const targetId = trigger.getAttribute("data-panel-target");
            const panel = document.querySelector(targetId);

            if (panel) {
                trigger.addEventListener("mouseenter", () => {
                    clearTimeout(panelTimeout);
                    document.querySelectorAll(".header-dropdown-panel.is-visible").forEach(p => p.classList.remove("is-visible"));
                    
                    positionPanel(trigger, panel);
                    panel.classList.add("is-visible");

                    if (targetId === "#notification-panel") {
                        const content = document.getElementById("notification-panel-content");
                        const source = document.getElementById("header-notifications");
                        if (content && source) content.innerHTML = source.innerHTML;
                    }
                    if (targetId === "#history-panel" && typeof displayHistory === "function") displayHistory();
                    if (targetId === "#watchlist-panel" && typeof renderWatchlistPanel === "function") renderWatchlistPanel();
                });

                trigger.addEventListener("mouseleave", () => {
                    panelTimeout = setTimeout(() => panel.classList.remove("is-visible"), 200);
                });

                panel.addEventListener("mouseenter", () => clearTimeout(panelTimeout));
                panel.addEventListener("mouseleave", () => panel.classList.remove("is-visible"));
            }
        });
    }

    // Init Global Counts
    updateAccountPageCounts();
});

document.addEventListener("DOMContentLoaded", function() {
    // 1. Select DOM elements
    const body = document.body;
    const sidebarToggleBtn = document.getElementById("sidebarToggle");

    // Safety check: Exit if the button doesn't exist on the page
    if (!sidebarToggleBtn) return;

    // 2. Handle Initial State (Load from LocalStorage)
    const savedState = localStorage.getItem("sidebarState");

    // Apply 'collapsed' class if that was the last saved state
    if (savedState === "collapsed") {
        body.classList.add("sidebar-collapsed");
    }

    // 3. Prevent Animation on Page Load
    // We add a 'no-transition' class momentarily so the sidebar 
    // doesn't animate (flash) when the page first loads.
    body.classList.add("no-transition");
    setTimeout(() => {
        body.classList.remove("no-transition");
    }, 100);

    // 4. Click Event Listener
    sidebarToggleBtn.addEventListener("click", () => {
        // Toggle the class on the body
        body.classList.toggle("sidebar-collapsed");

        // Determine current state and save to LocalStorage
        const currentState = body.classList.contains("sidebar-collapsed") ? "collapsed" : "expanded";
        localStorage.setItem("sidebarState", currentState);

        // 5. Fix for Owl Carousel (if present)
        // This triggers a refresh on sliders so they resize correctly when the sidebar moves
        setTimeout(function() {
            if (typeof $ !== "undefined" && $.fn.owlCarousel) {
                $("#dynamic-main-slider, #PopularPosts1 .owl-carousel").trigger("refresh.owl.carousel");
            }
        }, 350); // 350ms delay matches the CSS transition time
    });
});

/**
 * 
 * 
 * Cleaned Blogger Script
 * Contains:
 * 1. fetchAndRenderFilteredSwitch: Fetches posts by label and renders them.
 * 2. Upcoming Carousel: Converts Image widgets into an Owl Carousel.
 */

// Global function to be called by widget HTML
window.fetchAndRenderFilteredSwitch = function(container, config) {
    // Ensure container is a jQuery object
    const $container = $(container);
    
    // Configuration and Defaults
    const allowedLabels = ["Action", "Action & Adventure", "Adventure", "Animation", "Comedy", "Crime", "Documentary", "Drama", "Family", "Fantasy", "History", "Horror", "Kids", "Music", "Mystery", "Reality", "Romance", "Sci-Fi & Fantasy", "Science Fiction", "Thriller", "War", "Western"];
    const targetLabels = config.label ? config.label.split(",").map(t => t.trim()) : [];
    const maxResults = config.maxResults || 6;
    
    // UI Elements
    const $grid = $container.find(".switch-grid");
    const $loadMoreBtn = $container.find(".switch-button");
    
    let allPosts = [];

    // Error: No label specified in shortcode
    if (targetLabels.length === 0) {
        $grid.html('<p class="error-msg">Widget Error: Please set at least one label in the shortcode.</p>');
        return;
    }

    // Function to render the posts
    function renderPosts() {
        if (allPosts.length === 0) {
            $grid.html("<p class='error-msg'>No posts found for the specified labels.</p>");
            $loadMoreBtn.hide();
            return;
        }

        // Shuffle posts (Fisher-Yates Shuffle)
        for (let i = allPosts.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allPosts[i], allPosts[j]] = [allPosts[j], allPosts[i]];
        }

        // Slice posts to maxResults
        const postsToRender = allPosts.slice(0, maxResults);

        const htmlContent = postsToRender.map(post => {
            // Icons and Metadata HTML generation
            const iconDuration = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" fill="none"><path d="M2 15C2.14277 15.4274 2.31023 15.8431 2.50062 16.2452M4.12547 18.7463C4.44158 19.1137 4.781 19.4596 5.14137 19.7814M9 22C8.55224 21.8557 8.11701 21.6824 7.69641 21.4822" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 13.5C12.8284 13.5 13.5 12.8284 13.5 12C13.5 11.1716 12.8284 10.5 12 10.5C11.1716 10.5 10.5 11.1716 10.5 12M12 13.5C11.1716 13.5 10.5 12.8284 10.5 12M12 13.5V16M10.5 12H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg>`;
            const iconRating = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="11" height="11" fill="none"><path d="M9.03658 10.8665L10.0925 12.9957C10.2364 13.2921 10.6204 13.5764 10.9444 13.6309L12.8582 13.9515C14.082 14.1571 14.37 15.0524 13.4881 15.9355L12.0003 17.4356C11.7483 17.6897 11.6103 18.1796 11.6883 18.5305L12.1142 20.3875C12.4502 21.8574 11.6763 22.426 10.3864 21.6578L8.59263 20.5871C8.26867 20.3935 7.73473 20.3935 7.40476 20.5871L5.61096 21.6578C4.3271 22.426 3.54719 21.8513 3.88315 20.3875L4.3091 18.5305C4.3871 18.1796 4.24911 17.6897 3.99714 17.4356L2.5093 15.9355C1.6334 15.0524 1.91537 14.1571 3.13923 13.9515L5.05302 13.6309C5.37099 13.5764 5.75494 13.2921 5.89893 12.9957L6.95481 10.8665C7.53075 9.71116 8.46665 9.71116 9.03658 10.8665Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M22 2L14 10M16 2L11 7M20 10L17 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path></svg>`;
            const iconAudio = `<svg viewBox="0 0 24 24" width="10" height="10"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" fill="currentColor"/></svg>`;

            const htmlDuration = post.duration ? `<span class="thumb-meta thumb-duration is-visible">${iconDuration}${post.duration}</span>` : '<span class="thumb-meta thumb-duration"></span>';
            const htmlRating = post.rating ? `<span class="thumb-meta thumb-rating is-visible">${iconRating}${post.rating}</span>` : '<span class="thumb-meta thumb-rating"></span>';
            const htmlType = post.type ? `<span class="sub-meta-type is-visible">${post.type === "TV Series" ? "TV" : post.type}</span>` : '<span class="sub-meta-type"></span>';
            const htmlYear = post.year ? `<span class="sub-meta-year is-visible">${post.year}</span>` : '<span class="sub-meta-year"></span>';
            const htmlSubs = post.subtitles ? `<span class="sub-meta-cc is-visible">${post.subtitles}</span>` : '<span class="sub-meta-cc"></span>';
            const htmlAudio = post.audio ? `<span class="sub-meta-mic is-visible">${iconAudio}${post.audio}</span>` : '<span class="sub-meta-mic"></span>';

            return `
            <article class="index-post" data-post-id="${post.id}">
                <a class="entry-image-wrap" href="${post.url}" title="${post.title}">
                    <span class="entry-image" data-image="${post.imageUrl}"></span>
                    <span class="entry-label">${post.label}</span>
                    <div class="thumb-meta-overlay">${htmlDuration}${htmlRating}</div>
                </a>
                <div class="entry-header">
                    <h2 class="entry-title"><a href="${post.url}">${post.title}</a></h2>
                    <div class="card-sub-meta">
                        <div class="sub-meta-left">${htmlType}${htmlYear}</div>
                        <div class="sub-meta-right">${htmlSubs}${htmlAudio}</div>
                    </div>
                </div>
            </article>`;
        }).join("");

        $grid.html(htmlContent);

        // Trigger lazy load or layout updates
        setTimeout(function() {
            if (typeof $ === "function") $(window).trigger("scroll");
        }, 50);
    }

    // Prepare API URL
    const labelPath = targetLabels.map(t => encodeURIComponent(t)).join("/");
    
    // Fetch Data
    $.ajax({
        url: `/feeds/posts/default/-/${labelPath}?alt=json-in-script&max-results=50`,
        type: "get",
        dataType: "jsonp",
        success: function(response) {
            if (!response.feed || !response.feed.entry) {
                renderPosts();
                return;
            }

            allPosts = response.feed.entry.map(entry => {
                // Parse the post content to find hidden metadata in the HTML
                const $tempDiv = $("<div>").html(entry.content.$t);
                const $img = $tempDiv.find('img[alt="poster"]');
                const $extraMeta = $tempDiv.find("#extra-meta");
                
                // Determine label
                const categories = (entry.category || []).map(c => c.term);
                const matchedLabel = categories.find(c => allowedLabels.includes(c)) || "";

                return {
                    id: entry.id.$t.split(".post-")[1],
                    title: entry.title.$t,
                    url: (entry.link.find(l => l.rel === "alternate") || {}).href,
                    imageUrl: $img.length ? $img.attr("src").replace(/\/s\d+(-[a-z0-9]+)*\//, "/w400-h600-c/") : "https://resources.blogblog.com/img/blank.gif",
                    label: matchedLabel,
                    duration: $extraMeta.find(".meta-duration").text().trim(),
                    rating: $extraMeta.find(".meta-rating").text().trim(),
                    year: $extraMeta.find(".meta-year").text().trim(),
                    type: $extraMeta.find(".meta-type").text().trim(),
                    subtitles: $extraMeta.find(".meta-subtitles").text().trim(),
                    audio: $extraMeta.find(".meta-audio").text().trim()
                };
            }).filter(Boolean);

            renderPosts();

            // Show 'load more' button if results exceed limit
            if (allPosts.length > maxResults) {
                $loadMoreBtn.show();
            }
        },
        error: function() {
            $grid.html("<p class='error-msg'>Failed to load post feed.</p>");
        }
    });

    // Handle click on load more (reshuffles and re-renders currently)
    $loadMoreBtn.on("click", renderPosts);
}

// Initialize Carousel on DOM Ready
document.addEventListener("DOMContentLoaded", function() {
    function initCarousel() {
        const carouselWrapper = document.querySelector(".upcoming-carousel-wrapper");
        const widgetWrapper = document.getElementById("upcoming-carousel-widgets");
        const sectionWrapper = document.querySelector(".upcoming-carousel-section");

        if (!carouselWrapper || !widgetWrapper || !sectionWrapper) {
            if (sectionWrapper) sectionWrapper.style.display = "none";
            return;
        }

        carouselWrapper.id = "upcoming-carousel";
        const widgets = widgetWrapper.querySelectorAll(".widget.Image");

        if (widgets.length === 0) {
            sectionWrapper.style.display = "none";
            return;
        }

        let carouselHtml = "";

        widgets.forEach(function(widget) {
            if (widget.style.display === "none" || widget.classList.contains("hidden")) return;

            const hiddenData = widget.querySelector(".hidden-widget-data");
            if (hiddenData) {
                const title = (hiddenData.querySelector(".data-title") || {}).textContent || "";
                const rawCaption = (hiddenData.querySelector(".data-caption") || {}).textContent || "";
                const link = (widget.querySelector("a") || {}).href || "#";
                const img = (widget.querySelector("img") || {}).src || "";

                if (img) {
                    // Parse Caption: [Type] [Date] Description
                    const matches = rawCaption.match(/^\[(TV|Movie)\]\s*\[(.*?)\]\s*(.*)$/s);
                    
                    let typeBadge = "";
                    let dateBadge = "";
                    let descText = rawCaption;

                    if (matches) {
                        const typeRaw = matches[1];
                        const dateRaw = matches[2].trim();
                        descText = matches[3].trim();
                        const typeClass = typeRaw.toLowerCase() === "tv" ? "type-tv" : "type-movie";
                        
                        typeBadge = `<span class="upcoming-thumb-type ${typeClass}">${typeRaw}</span>`;
                        if (dateRaw) {
                            dateBadge = `<span class="upcoming-date">${dateRaw}</span>`;
                        }
                    }

                    carouselHtml += `
                    <div class="item">
                        <a class="upcoming-card" href="${link}">
                            <div class="upcoming-image">
                                ${typeBadge}
                                <img alt="${title}" src="${img.replace(/\/s\d+(-[a-z0-9]+)*\//, "/w200-h300-c/")}" loading="lazy"/>
                            </div>
                            <div class="upcoming-content">
                                <h4 class="upcoming-title">${title}</h4>
                                ${dateBadge}
                                <p class="upcoming-description">${descText}</p>
                                <div class="upcoming-button">More Details</div>
                            </div>
                        </a>
                    </div>`;
                }
            }
        });

        if (carouselHtml.trim() !== "") {
            carouselWrapper.innerHTML = carouselHtml;
            
            // Carousel Options
            const owlOptions = {
                "0": { autoWidth: true, stagePadding: 20, margin: 12 },
                "768": { items: 2, slideBy: 2 },
                "1200": { items: 3, slideBy: 3 }
            };

            // Initialize Owl Carousel
            $(carouselWrapper).addClass("owl-carousel owl-theme").owlCarousel({
                loop: false,
                margin: 16,
                nav: true,
                dots: false,
                navText: [
                    '<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 18l-6-6 6-6"/></svg>',
                    '<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6l6 6-6 6"/></svg>'
                ],
                responsive: owlOptions
            });
        } else {
            sectionWrapper.style.display = "none";
        }
    }

    // Check if jQuery and OwlCarousel are loaded
    if (window.jQuery && jQuery.fn.owlCarousel) {
        initCarousel();
    } else {
        setTimeout(initCarousel, 500);
    }
});
