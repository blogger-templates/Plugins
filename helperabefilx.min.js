
// ===============================================================
// PART 1: UTILITIES & GLOBAL SETUP
// ===============================================================

// Move sidebar on post pages to the correct container
function movePostPageSidebar() {
    if ($("body").find(".item-post").length) {
        let e = $("#post-page-sidebar .widget");
        e.length && e.appendTo("#post-page-sidebar-content")
    }
}

// Mobile Search Functionality
function initMobileSearch() {
    let e = document.getElementById("mobile-search-modal");
    if (!e) return;
    let t = document.querySelectorAll(".mobile-search-input, .mobile-search-button"),
        a = document.getElementById("ms-back-btn"),
        n = document.getElementById("ms-input"),
        i = document.getElementById("ms-form"),
        l = document.getElementById("ms-default-view"),
        r = document.getElementById("ms-results-view"),
        s = document.getElementById("ms-history-container"),
        o = document.getElementById("ms-popular-container"),
        d = "abefilmSearchHistory",
        c, _ = () => {
            e.classList.add("active"), document.body.classList.add("ms-modal-open"), n.focus(), y()
        },
        u = () => {
            e.classList.remove("active"), document.body.classList.remove("ms-modal-open"), n.value = "", b()
        },
        p = () => JSON.parse(localStorage.getItem(d) || "[]"),
        m = e => {
            if (!e || !e.trim()) return;
            let t = p().filter(t => t.toLowerCase() !== e.toLowerCase());
            t.unshift(e), t.length > 3 && t.pop(), localStorage.setItem(d, JSON.stringify(t))
        },
        g = e => {
            let t = p().filter(t => t.toLowerCase() !== e.toLowerCase());
            localStorage.setItem(d, JSON.stringify(t)), f()
        },
        h = () => {
            localStorage.removeItem(d), f()
        },
        f = () => {
            let e = p();
            if (0 === e.length) {
                s.innerHTML = "";
                return
            }
            let t = '\n<div class="ms-section-title ms-history-header">\n<span>Search History</span>\n<button class="clear-btn">Clear All</button>\n</div>\n<ul>';
            e.forEach(e => {
                t += '\n<li>\n<a href="/search?q=' + encodeURIComponent(e) + '">' + e + '</a>\n<button class="delete-item-btn" data-term="' + e + '">&times;</button>\n</li>'
            }), t += "</ul>", s.innerHTML = t
        },
        v = () => {
            o.innerHTML = '\n<div class="ms-section-title ms-popular-header">\n<span>ðŸ”¥ Latest Posts</span>\n</div>\n<div class="ms-loader">Loading...</div>', fetch("/feeds/posts/default?alt=json&max-results=8&orderby=published").then(e => e.json()).then(e => {
                if (!e.feed || !e.feed.entry || 0 === e.feed.entry.length) {
                    o.innerHTML = "";
                    return
                }
                let t = '\n<div class="ms-section-title ms-popular-header">\n<span>ðŸ”¥ Latest Posts</span>\n</div>\n<ul>';
                e.feed.entry.forEach((e, a) => {
                    let n = e.link.find(e => "alternate" === e.rel).href;
                    t += '\n<li>\n<span class="rank-number ' + (a < 3 ? "top-3" : "") + '">' + (a + 1) + '</span>\n<a href="' + n + '">' + e.title.$t + "</a>\n</li>"
                }), t += "</ul>", o.innerHTML = t
            }).catch(e => {
                console.error("Error fetching popular posts:", e), o.innerHTML = ""
            })
        },
        y = () => {
            f(), v()
        },
        b = () => {
            l.style.display = "block", r.style.display = "none"
        };
    window.renderDefaultView = y;
    let w = () => {
            l.style.display = "none", r.style.display = "block"
        },
        C = e => {
            w(), r.innerHTML = '<div class="ms-loader">Searching...</div>', fetch("/feeds/posts/default?alt=json&q=" + encodeURIComponent(e) + "&max-results=10").then(e => e.json()).then(e => {
                if (!e.feed || !e.feed.entry || 0 === e.feed.entry.length) {
                    r.innerHTML = '<div class="ms-no-results">No results found.</div>';
                    return
                }
                let t = e.feed.entry.map(e => {
                    let t = e.link.find(e => "alternate" === e.rel).href;
                    return fetch(t).then(e => e.text()).then(a => {
                        let n = new DOMParser,
                            i = n.parseFromString(a, "text/html"),
                            l = i.querySelector('img[alt="poster"]')?.src || "https://resources.blogblog.com/img/blank.gif",
                            r = i.querySelector("#extra-meta .meta-year")?.textContent.trim() || "",
                            s = i.querySelector("#extra-meta .meta-type")?.textContent.trim() || "",
                            o = {};
                        return o.title = e.title.$t, o.url = t, o.imageUrl = l, o.year = r, o.type = s, o
                    }).catch(() => null)
                });
                Promise.all(t).then(e => {
                    let t = e.filter(Boolean);
                    if (0 === t.length) {
                        r.innerHTML = '<div class="ms-no-results">No results found.</div>';
                        return
                    }
                    let a = "<ul>";
                    t.forEach(e => {
                        a += '\n<li>\n<a href="' + e.url + '">\n<img class="result-thumb" src="' + e.imageUrl + '" alt="' + e.title + '" loading="lazy"/>\n<div class="result-info">\n<h3 class="title">' + e.title + '</h3>\n<p class="meta">' + e.year + (e.year && e.type ? " Â· " : "") + e.type + "</p>\n</div>\n</a>\n</li>"
                    }), a += "</ul>", r.innerHTML = a, r.addEventListener("click", e => {
                        let t = e.target.closest("a");
                        if (t) {
                            e.preventDefault();
                            let a = n.value.trim();
                            m(a), window.location.href = t.href
                        }
                    })
                })
            }).catch(e => {
                r.innerHTML = '<div class="ms-no-results">An error occurred.</div>'
            })
        };
    t.forEach(e => {
        e.addEventListener("click", e => {
            e.preventDefault(), _()
        }), e.addEventListener("focus", e => {
            e.preventDefault(), e.target.blur(), _()
        })
    }), a.addEventListener("click", u), n.addEventListener("input", () => {
        clearTimeout(c);
        let e = n.value.trim();
        e.length > 1 ? c = setTimeout(() => {
            C(e)
        }, 300) : b()
    }), i.addEventListener("submit", e => {
        e.preventDefault();
        let t = n.value.trim();
        t && (m(t), window.location.href = "/search?q=" + encodeURIComponent(t))
    }), s.addEventListener("click", e => {
        e.target.classList.contains("delete-item-btn") && g(e.target.dataset.term), e.target.classList.contains("clear-btn") && h()
    });
    let k = document.getElementById("bottom-nav-search-trigger");
    k && k.addEventListener("click", e => {
        e.preventDefault(), _()
    })
}

// Remove from history Helper
window.removeFromHistory = function(e) {
    if (!e) return;
    let t = JSON.parse(localStorage.getItem("watchHistoryIDs") || "[]");
    t = t.filter(t => String(t) !== String(e)), localStorage.setItem("watchHistoryIDs", JSON.stringify(t));
    let a = document.getElementById("history-item-" + e);
    a && a.remove();
    let n = document.getElementById("history-items-list");
    if (n && 0 === n.children.length) {
        let i = document.getElementById("history-empty-message");
        i && (i.style.display = "block")
    }
    "function" == typeof window.updateHistoryBadge && window.updateHistoryBadge()
};

// ===============================================================
// PART 2: MAIN EXECUTION (DOM Ready)
// ===============================================================
document.addEventListener("DOMContentLoaded", function() {
    
    // Sidebar Toggle
    let body = document.body,
        sidebarToggle = document.getElementById("sidebarToggle");
    setTimeout(() => {
        body.classList.remove("no-transition")
    }, 100);
    sidebarToggle && sidebarToggle.addEventListener("click", () => {
        body.classList.toggle("sidebar-collapsed");
        let e = body.classList.contains("sidebar-collapsed") ? "collapsed" : "expanded";
        localStorage.setItem("sidebarState", e), setTimeout(function() {
            $("#dynamic-main-slider, #PopularPosts1 .owl-carousel").trigger("refresh.owl.carousel")
        }, 350)
    });

    // Check Sidebar State on Load
    if ("collapsed" === localStorage.getItem("sidebarState")) {
        document.body.classList.add("sidebar-collapsed");
    }

    // Set Active Menu Item
    let currentPath = window.location.pathname,
        menuLinks = document.querySelectorAll(".sidebar-nav a"),
        activeLink = null,
        maxMatch = -1;
    menuLinks.forEach(e => {
        let t = e.getAttribute("href");
        if (!(t && t.startsWith("#"))) try {
            let a = new URL(e.href).pathname;
            "/" === a && "/" === currentPath ? (activeLink = e, maxMatch = 1) : "/" !== a && currentPath.startsWith(a) && a.length > maxMatch && (maxMatch = a.length, activeLink = e)
        } catch (i) {}
    }), activeLink && (menuLinks.forEach(e => e.parentElement.classList.remove("active")), activeLink.parentElement.classList.add("active"));

    // Clear Cache Button
    let clearCacheBtn = document.querySelector('a[href="#clear-cache"]');
    if (clearCacheBtn && clearCacheBtn.addEventListener("click", function(e) {
            e.preventDefault(), confirm("This will clear cached data. Continue?") && (localStorage.clear(), sessionStorage.clear(), alert("Cache cleared. The page will now reload."), window.location.reload(!0))
        }), document.body.classList.contains("final-layout-script-loaded")) return;
    document.body.classList.add("final-layout-script-loaded");

    // ===========================================================
    // PART 3: VIDEO PLAYER & EPISODE LOGIC
    // ===========================================================
    
    
    let postContainer = document.querySelector(".post-page-final-container");
    if (postContainer) {
        try {
            var d, c;
            let _ = document.querySelector("#source-data-container");
            if (!_) throw Error("Source data container (#source-data-container) not found.");
            let u = _.querySelector(".post-body");
            if (!u) throw Error("Source data element (.post-body) not found inside hidden container.");
            let p = () => _.querySelector(".entry-title")?.textContent.trim() || "",
                m = e => u.querySelector(e)?.textContent.trim() || "",
                g = u.querySelector(d = 'img[alt="poster"]')?.getAttribute("src") || "",
                h = m("span.slider-backdrop"),
                f = m("#extra-meta .meta-rating"),
                v = m("#extra-meta .meta-year"),
                y = m("#extra-meta .meta-pg"),
                b = m("#extra-meta .meta-status"),
                w = m("#extra-meta .meta-country"),
                C = Array.from(u.querySelectorAll("#extra-meta .meta-genre")).map(e => e.textContent.trim()),
                k = postContainer.querySelector("#add-to-watchlist-btn");
            if (k) {
                let L = new URL(window.location.href).pathname,
                    x = p(),
                    E = window.location.href,
                    M = h || g;
                k.setAttribute("data-post-id", L), k.setAttribute("data-post-title", x), k.setAttribute("data-post-url", E), k.setAttribute("data-post-image", M), $(document).trigger("abefilm:postDataReady", [{
                    id: L,
                    title: x,
                    url: E,
                    image: M
                }])
            }
            let S = postContainer.querySelectorAll(".details-header-final");
            S.forEach(e => {
                e.querySelector(".poster-final img").src = g, e.querySelector(".title-final").textContent = p();
                let t = e.querySelector(".meta-line-final");
                f && (t.innerHTML += `<span class="rating"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.0183 9.43335L15.5462 10.498C15.6182 10.6462 15.8102 10.7883 15.9722 10.8155L16.9291 10.9758C17.541 11.0787 17.685 11.5263 17.244 11.9678L16.5001 12.7179C16.3741 12.8449 16.3051 13.0899 16.3441 13.2653L16.5571 14.1938C16.7251 14.9288 16.3381 15.2131 15.6932 14.829L14.7963 14.2937C14.6343 14.1969 14.3674 14.1969 14.2024 14.2937L13.3055 14.829C12.6636 15.2131 12.2736 14.9258 12.4416 14.1938L12.6546 13.2653C12.6935 13.0899 12.6246 12.8449 12.4986 12.7179L11.7547 11.9678C11.3167 11.5263 11.4577 11.0787 12.0696 10.9758L13.0265 10.8155C13.1855 10.7883 13.3775 10.6462 13.4495 10.498L13.9774 9.43335C14.2654 8.85568 14.7333 8.85568 15.0183 9.43335Z" /><path d="M8 17L8 20.5" /><path d="M8 3.5V7" /><path d="M22 8.87895C21.9331 7.33687 21.7456 6.33298 21.2203 5.53884C20.9181 5.08196 20.5428 4.68459 20.1112 4.36468C18.9447 3.5 17.299 3.5 14.0078 3.5H9.99305C6.70178 3.5 5.05614 3.5 3.88962 4.36468C3.45805 4.68459 3.08267 5.08196 2.78047 5.53884C2.25526 6.33289 2.06776 7.33665 2.00083 8.87843C1.98938 9.14208 2.21648 9.34375 2.46531 9.34375C3.85109 9.34375 4.97449 10.533 4.97449 12C4.97449 13.467 3.85109 14.6562 2.46531 14.6562C2.21648 14.6562 1.98938 14.8579 2.00083 15.1216C2.06776 16.6634 2.25526 17.6671 2.78047 18.4612C3.08267 18.918 3.45805 19.3154 3.88962 19.6353C5.05614 20.5 6.70178 20.5 9.99306 20.5H14.0078C17.299 20.5 18.9447 20.5 20.1112 19.6353C20.5428 19.3154 20.9181 18.918 21.2203 18.4612C21.7456 17.667 21.9331 16.6631 22 15.1211V8.87895Z" stroke="grey" stroke-width="1.5" stroke-linejoin="round" /></svg> ${f}</span>`), v && (t.innerHTML += `<span>${v}</span>`), w && (t.innerHTML += `<span>${w}</span>`), y && (t.innerHTML += `<span>${y}</span>`);
                let a = e.querySelector(".tags-line-final");
                C.forEach(e => a.innerHTML += `<span class="tag">${e}</span>`), b && t.insertAdjacentHTML("afterend", `<div style="font-size:13px; color:#a7a7a7; margin-top:8px;">${b}</div>`)
            }), postContainer.querySelector(".synopsis-final").textContent = u.querySelector("#overview-data")?.textContent.trim() || "";
            let A = u.querySelectorAll("#celebrity-data li");
            if (A.length > 0) {
                let q = postContainer.querySelector("#celebrity-section"),
                    I = postContainer.querySelector(".celebrity-grid-final");
                q.style.display = "block", A.forEach(e => {
                    let t = e.querySelector("img")?.src || "",
                        a = e.querySelector("span")?.textContent || "";
                    I.innerHTML += `<div class="celebrity-item-final"> <img src="${t}" alt="${a}"/> <span class="name">${a}</span> </div>`
                })
            }
            let B = {},
                H = [];
            u.querySelectorAll("#episodes-data > ul[data-server-name]").forEach(e => {
                let t = e.dataset.serverName,
                    a = Array.from(e.querySelectorAll("a"));
                t && a.length > 0 && (H.push(t), B[t] = a)
            });
            let T = Array.from(u.querySelectorAll("#download-data a")),
                j = postContainer.querySelector(".video-player-container-final iframe"),
                P = postContainer.querySelector(".video-player-container-final"),
                D = postContainer.querySelector(".video-overlay");
            D && h && (D.style.backgroundImage = `url(${h})`), D && D.addEventListener("click", () => {
                let e = document.getElementById("post-id");
                if (e) {
                    let t = e.getAttribute("data-post-id");
                    t && function e(t) {
                        if (!t) return;
                        let a = JSON.parse(localStorage.getItem("watchHistoryIDs") || "[]");
                        (a = a.filter(e => String(e) !== String(t))).unshift(t), a.length > 50 && a.pop(), localStorage.setItem("watchHistoryIDs", JSON.stringify(a))
                    }(t)
                }
                P.classList.add("is-playing");
                let a = j.getAttribute("src");
                if (a && "about:blank" !== a) try {
                    let n = new URL(a);
                    n.searchParams.set("autoplay", "1"), j.setAttribute("src", n.href)
                } catch (i) {
                    j.setAttribute("src", a + (a.includes("?") ? "&" : "?") + "autoplay=1")
                }
            });
            let W = `watchState_${window.location.pathname}`,
                F = 0,
                z = H[0] || null,
                V = localStorage.getItem(W);
            if (V) try {
                let R = JSON.parse(V),
                    N = B[R.server],
                    U = N?.length || 0;
                R && H.includes(R.server) && R.episode < U && (z = R.server, F = R.episode)
            } catch (O) {
                console.error("Could not parse saved watch state.", O)
            }
            let Z = postContainer.querySelector(".server-selection-final"),
                K = postContainer.querySelector(".download-links-container"),
                G = postContainer.querySelector("#reload-btn"),
                X = postContainer.querySelector("#fullscreen-btn"),
                Q = postContainer.querySelector("#sandbox-checkbox"),
                Y = postContainer.querySelector("#prev-ep-btn"),
                J = postContainer.querySelector("#next-ep-btn"),
                ee = postContainer.querySelector("#ep-counter"),
                et = postContainer.querySelector("#season-info");

            function ea(e) {
                z = e;
                let t = B[z],
                    a = t?.length || 0,
                    n = Math.ceil(a / 50),
                    i = postContainer.querySelector(".episodes-pagination-final"),
                    l = postContainer.querySelector(".episodes-grid-container-final"),
                    r = postContainer.querySelector("#episodes-content");
                if (r.querySelector(".total-ep-header")?.remove(), i.innerHTML = "", l.innerHTML = "", 0 === a) return;
                let s = ` <div class="total-ep-header"> <p class="total-ep-count">Total Episodes: ${a}</p> <button class="all-episodes-btn-mobile"> All Episodes <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/> </svg> </button> </div>`;
                i.insertAdjacentHTML("beforebegin", s);
                let d = ` <div class="ep-range-dropdown"> <button class="ep-range-dropdown-toggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg></button> <div class="ep-range-dropdown-menu"></div> </div>`;
                i.innerHTML = (a > 50 ? '<div class="ep-range-tabs-container"></div>' : "") + d;
                for (let c = 0; c < n; c++) {
                    let _ = document.createElement("div");
                    _.className = "episodes-grid-final", _.dataset.page = c + 1, l.appendChild(_);
                    for (let u = 0; u < 50; u++) {
                        let p = 50 * c + u + 1;
                        if (p > a) break;
                        let m = document.createElement("a");
                        m.className = "ep-button", m.dataset.epIndex = p - 1, m.innerHTML = `<span class="ep-number-text">${p}</span> <span class="ep-active-indicator"><svg viewBox="0 0 24 24"><rect class="bar bar1" x="4" y="8" width="4" height="10" rx="1"></rect><rect class="bar bar2" x="10" y="4" width="4" height="16" rx="1"></rect><rect class="bar bar3" x="16" y="10" width="4" height="8" rx="1"></rect></svg></span>`, _.appendChild(m)
                    }
                }
                F >= a && (F = 0);
                let g = document.getElementById("all-episodes-modal-overlay"),
                    h = document.getElementById("all-episodes-modal-grid"),
                    f = g.querySelector(".episodes-modal-close-btn"),
                    v = () => {
                        h.innerHTML = "";
                        let e = postContainer.querySelectorAll(".episodes-grid-final .ep-button");
                        e.forEach(e => {
                            h.appendChild(e.cloneNode(!0))
                        }), g.classList.add("is-visible"), document.body.style.overflow = "hidden"
                    },
                    y = () => {
                        g.classList.remove("is-visible"), document.body.style.overflow = ""
                    },
                    b = postContainer.querySelector(".all-episodes-btn-mobile");
                b && (b.onclick = v), f.onclick = y, g.onclick = e => {
                    e.target === g && y()
                }, h.onclick = e => {
                    let t = e.target.closest(".ep-button");
                    if (t) {
                        e.preventDefault();
                        let a = parseInt(t.dataset.epIndex, 10);
                        ei(a), y()
                    }
                }, ei(F)
            }

            function en() {
                Z.innerHTML = "", H.forEach(e => {
                    let t = document.createElement("button");
                    t.className = "server-btn", t.dataset.server = e;
                    let a = u.querySelector(`ul[data-server-name="${e}"]`),
                        n = a ? a.dataset.serverLogo : null,
                        i = "";
                    i = n ? `<img src="${n}" alt="${e}" class="server-logo-img"/> <span class="server-name-text">${e}</span>` : `<span class="server-name-text">${e}</span>`, t.innerHTML = i, e === z && t.classList.add("active"), Z.appendChild(t)
                })
            }

            function ei(e) {
                let t = B[z]?.length || 0;
                if (e < 0 || e >= t) return;
                F = e;
                let a = {
                    server: z,
                    episode: F
                };
                localStorage.setItem(W, JSON.stringify(a));
                let n = document.getElementById("post-id");
                if (n) {
                    let i = n.getAttribute("data-post-id");
                    if (i) try {
                        let l = JSON.parse(localStorage.getItem("abefilmWatchProgress") || "{}");
                        l[`post-${i}`] = e, localStorage.setItem("abefilmWatchProgress", JSON.stringify(l))
                    } catch (r) {
                        console.error("Could not save watch progress", r)
                    }
                }
                j.src = B[z][e].href, ee.textContent = `${e+1} / ${t}`;
                let s = document.querySelectorAll(".episodes-grid-container-final, #all-episodes-modal-grid");
                s.forEach(t => {
                    t.querySelector(".ep-button.active")?.classList.remove("active");
                    let a = t.querySelector(`.ep-button[data-ep-index="${e}"]`);
                    a && (a.classList.add("active"), t.classList.contains("episodes-grid-container-final") && a.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest",
                        inline: "center"
                    }))
                }), Y.disabled = 0 === e, J.disabled = e === t - 1;
                let d = Math.floor(e / 50) + 1,
                    c = postContainer.querySelector(".episodes-pagination-final");
                if (c && c.innerHTML) {
                    let _ = c.querySelector(".ep-range-tabs-container .ep-range-tab.active"),
                        u = _ && parseInt(_.dataset.page, 10) === d;
                    u || (el(d), er(d))
                }
            }

            function el(e) {
                let t = B[z]?.length || 0,
                    a = Math.ceil(t / 50),
                    n = postContainer.querySelector(".episodes-pagination-final"),
                    i = n.querySelector(".ep-range-tabs-container"),
                    l = n.querySelector(".ep-range-dropdown-menu");
                i && (i.innerHTML = ""), l.innerHTML = "";
                let r = 1;
                a > 3 && e > 3 && (r = 3 * Math.floor((e - 1) / 3) + 1);
                for (let s = 0; s < a; s++) {
                    let d = s + 1,
                        c = 50 * s + 1,
                        _ = Math.min((s + 1) * 50, t),
                        u = `${c}-${_}`,
                        p = document.createElement("a");
                    if (p.className = "ep-range-tab", p.href = "#", p.dataset.page = d, p.innerHTML = `<span>${u}</span>`, d === e && p.classList.add("active"), l.appendChild(p), i && d >= r && d < r + 3) {
                        let m = document.createElement("button");
                        m.className = "ep-range-tab", m.dataset.page = d, m.innerHTML = `<span>${u}</span>`, d === e && m.classList.add("active"), i.appendChild(m)
                    }
                }
                let g = n.querySelector(".ep-range-dropdown-toggle");
                g && (g.style.display = a > 1 ? "flex" : "none")
            }

            function er(e) {
                postContainer.querySelectorAll(".episodes-grid-final").forEach(t => {
                    t.classList.toggle("active", t.dataset.page == e)
                })
            }
            let es = H.length > 0 && B[H[0]]?.length > 0,
                eo = H.length > 1,
                ed = T.length > 0;
            if (es || eo || ed) {
                let ec = postContainer.querySelector("#episodes-section");
                ec.style.display = "block";
                let e_ = postContainer.querySelector(".episodes-tabs-final"),
                    e1 = postContainer.querySelectorAll(".ep-tab-content"),
                    e0 = null;
                if (e_.innerHTML = "", es && (e_.innerHTML += `<button class="ep-tab-button" data-target="#episodes-content"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2 14C2 10.2288 2 8.34315 3.17157 7.17157C4.34315 6 6.22876 6 10 6H14C17.7712 6 19.6569 6 20.8284 7.17157C22 8.34315 22 10.2288 22 14C22 17.7712 22 19.6569 20.8284 20.8284C19.6569 22 17.7712 22 14 22H10C6.22876 22 4.34315 22 3.17157 20.8284C2 19.6569 2 17.7712 2 14Z" ></path> <path d="M9 3L12 6L16 2" ></path> </svg>Episodes </button>`, e0 || (e0 = "#episodes-content")), eo && (e_.innerHTML += `<button class="ep-tab-button" data-target="#server-content"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M19 4H5C4.06812 4 3.60218 4 3.23463 4.15224C2.74458 4.35523 2.35523 4.74458 2.15224 5.23463C2 5.60218 2 6.06812 2 7C2 7.93188 2 8.39782 2.15224 8.76537C2.35523 9.25542 2.74458 9.64477 3.23463 9.84776C3.60218 10 4.06812 10 5 10H19C19.9319 10 20.3978 10 20.7654 9.84776C21.2554 9.64477 21.6448 9.25542 21.8478 8.76537C22 8.39782 22 7.93188 22 7C22 6.06812 22 5.60218 21.8478 5.23463C21.6448 4.74458 21.2554 4.35523 20.7654 4.15224C20.3978 4 19.9319 4 19 4Z" ></path> <path d="M19 14H5C4.06812 14 3.60218 14 3.23463 14.1522C2.74458 14.3552 2.35523 14.7446 2.15224 15.2346C2 15.6022 2 16.0681 2 17C2 17.9319 2 18.3978 2.15224 18.7654C2.35523 19.2554 2.74458 19.6448 3.23463 19.8478C3.60218 20 4.06812 20 5 20H19C19.9319 20 20.3978 20 20.7654 19.8478C21.2554 19.6448 21.6448 19.2554 21.8478 18.7654C22 18.3978 22 17.9319 22 17C22 16.0681 22 15.6022 21.8478 15.2346C21.6448 14.7446 21.2554 14.3552 20.7654 14.1522C20.3978 14 19.9319 14 19 14Z" ></path> <path d="M6 17H6.01" ></path> <path d="M10 17H10.01" ></path> <path d="M6 7H6.01" ></path> <path d="M10 7H10.01" ></path> </svg>Server<span class="tab-count">${H.length}</span> </button>`, e0 || (e0 = "#server-content")), ed && (e_.innerHTML += `<button class="ep-tab-button" data-target="#download-content"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"> <path d="M2.99969 17.0002C2.99969 17.9302 2.99969 18.3952 3.10192 18.7767C3.37932 19.8119 4.18796 20.6206 5.22324 20.898C5.60474 21.0002 6.06972 21.0002 6.99969 21.0002L16.9997 21.0002C17.9297 21.0002 18.3947 21.0002 18.7762 20.898C19.8114 20.6206 20.6201 19.8119 20.8975 18.7767C20.9997 18.3952 20.9997 17.9302 20.9997 17.0002" ></path> <path d="M16.4998 11.5002C16.4998 11.5002 13.1856 16.0002 11.9997 16.0002C10.8139 16.0002 7.49976 11.5002 7.49976 11.5002M11.9997 15.0002V3.00016" ></path> </svg>Download </button>`, e0 || (e0 = "#download-content")), e0 && (e_.querySelector(`[data-target="${e0}"]`).classList.add("active"), postContainer.querySelector(e0).classList.add("active")), es ? ea(z) : postContainer.querySelector(".footer-group-middle").style.display = "none", eo && en(), ed && function e() {
                    K.innerHTML = "";
                    let t = T.length;
                    if (0 === t) return;
                    K.innerHTML = `<p class="total-ep-count">Total Files: ${t}</p>`;
                    let a = document.createElement("div");
                    a.className = "download-grid-final", T.forEach(e => {
                        let t = document.createElement("a");
                        t.href = e.href, t.className = "ep-button", t.setAttribute("target", "_blank"), t.textContent = e.textContent, a.appendChild(t)
                    }), K.appendChild(a)
                }(), e_.addEventListener("click", e => {
                    let t = e.target.closest(".ep-tab-button");
                    if (t) {
                        e_.querySelector(".active")?.classList.remove("active"), t.classList.add("active"), e1.forEach(e => e.classList.remove("active"));
                        let a = t.dataset.target;
                        postContainer.querySelector(a).classList.add("active")
                    }
                }), Z.addEventListener("click", e => {
                    if (e.target.matches(".server-btn")) {
                        let t = e.target.dataset.server;
                        t !== z && (ea(t), en())
                    }
                }), es) {
                    let eu = !1;

                    function ep() {
                        let e = document.querySelector(".ep-range-dropdown-menu.is-open-globally");
                        e && e.classList.remove("is-open-globally"), window.removeEventListener("scroll", e$), eu = !1
                    }

                    function e$() {
                        ep()
                    }
                    document.body.addEventListener("click", function(e) {
                        let t = e.target.closest(".ep-range-dropdown-toggle"),
                            a = e.target.closest(".ep-range-tab"),
                            n = document.querySelector(".ep-range-dropdown-menu.is-open-globally");
                        if (t) {
                            e.preventDefault(), e.stopPropagation();
                            let i = t.nextElementSibling;
                            i && i.classList.contains("is-open-globally") ? ep() : i && function e(t, a) {
                                let n = t.getBoundingClientRect(),
                                    i = n.bottom + 8;
                                a.style.top = `${i}px`, a.classList.add("is-open-globally"), eu || (window.addEventListener("scroll", e$, {
                                    once: !0
                                }), eu = !0)
                            }(t, i)
                        } else if (a) {
                            e.preventDefault();
                            let l = parseInt(a.dataset.page, 10);
                            e.target.closest(".ep-range-dropdown-menu") && ep(), el(l), er(l)
                        } else n && (e.target.closest(".ep-range-dropdown") || ep())
                    }), postContainer.querySelector(".episodes-grid-container-final").addEventListener("click", e => {
                        let t = e.target.closest(".ep-button");
                        t && (e.preventDefault(), ei(parseInt(t.dataset.epIndex, 10)))
                    }), Y.addEventListener("click", () => ei(F - 1)), J.addEventListener("click", () => ei(F + 1))
                }
                let em = postContainer.querySelector("#comment-btn");
                em && em.addEventListener("click", () => {
                    let e = document.querySelector("#comments");
                    e && e.scrollIntoView({
                        behavior: "smooth"
                    })
                }), G.addEventListener("click", () => {
                    j.src = j.src
                }), X.addEventListener("click", () => {
                    j.requestFullscreen && j.requestFullscreen()
                }), Q.addEventListener("change", () => {
                    Q.checked ? j.setAttribute("sandbox", "allow-scripts allow-same-origin") : j.removeAttribute("sandbox")
                });
                let eg = m("#extra-meta .meta-season");
                eg && (et.textContent = eg), !es && z && (j.src = B[z][0].href)
            } else {
                let eh = u.querySelector("iframe");
                eh && eh.src && (j.src = eh.src), postContainer.querySelector("#episodes-section").style.display = "none", postContainer.querySelector(".footer-group-middle").style.display = "none"
            }
            let e2 = postContainer.querySelector(".info-modal-final"),
                e4 = postContainer.querySelector(".introduction-link-final"),
                ef = e2?.querySelector(".modal-close-btn");
            if (e4 && e2 && ef) {
                let e3 = e => {
                        e.preventDefault(), window.innerWidth <= 767 ? e2.classList.add("is-open-mobile") : e2.style.display = "block"
                    },
                    e5 = () => {
                        window.innerWidth <= 767 ? e2.classList.remove("is-open-mobile") : e2.style.display = "none"
                    };
                e4.addEventListener("click", e3), ef.addEventListener("click", e5)
            }
            if (postContainer.classList.add("loaded"), window.innerWidth <= 767) {
                let ev = document.querySelector(".player-column-final"),
                    e6 = document.querySelector("article.item-post");
                ev && e6 && e6.prepend(ev)
            }
        } catch (ey) {
            console.error("Error initializing custom player layout:", ey);
            let e7 = document.querySelector(".item-post");
            if (e7) {
                let eb = document.getElementById("source-data-container");
                eb && (eb.style.display = "block")
            }
            postContainer && (postContainer.style.display = "none")
        }
        try {
            let ew = decodeURIComponent(window.location.pathname),
                eC = document.querySelectorAll(".mobile-nav a"),
                ek = null;
            eC.forEach(function(e) {
                let t = new URL(e.href).pathname;
                if ("/" === t && "/" === ew) ek = e;
                else {
                    let a = !ek || t.length > new URL(ek.href).pathname.length;
                    "/" !== t && ew.startsWith(t) && a && (ek = e)
                }
            }), ek ? ek.classList.add("active") : "/" === ew && document.querySelector('.mobile-nav a[href="/"]')?.classList.add("active")
        } catch (eL) {
            console.error("Error setting active mobile link:", eL)
        }
    }
});

// ===============================================================
// PART 4: JQUERY-DEPENDENT UI LOGIC
// ===============================================================
$(document).ready(function() {
    
    // Header Carousel Nav
    if ($(document).on("click", ".header-carousel-nav .header-nav-btn", function() {
            var e = $(this),
                t = $(e.data("target"));
            if (t.length) {
                var a = t.data("owl.carousel");
                if (!a) return;
                var n, i = window.innerWidth;
                n = i < 768 ? 3 : i < 1024 ? 4 : 6;
                var l = a.current();
                if (e.hasClass("prev")) {
                    var r = Math.max(0, l - n);
                    t.trigger("to.owl.carousel", [r, 300])
                } else if (e.hasClass("next")) {
                    var r = Math.min(a.items().length - n, l + n);
                    t.trigger("to.owl.carousel", [r, 300])
                }
            }
        }), window.innerWidth > 1023 && $("body").hasClass("item-view")) {
        let e = document.body,
            t = new MutationObserver((e, t) => {
                let a = $("#comments"),
                    n = $(".recommendation-section"),
                    i = $(".most-popular-sidebar"),
                    l = $(".post-page-final-container");
                if (a.length && n.length && i.length && l.length && !l.hasClass("layout-processed")) {
                    t.disconnect(), l.addClass("layout-processed"), a.detach(), n.detach(), i.detach();
                    let r = $('<div class="post-footer-container"></div>'),
                        s = $('<div class="post-footer-main-content"></div>');
                    s.append(a), s.append(n), r.append(s), r.append(i), l.after(r), $("#video-tab-content .post-footer-container, #comment-tab-content .post-footer-container").remove()
                }
            });
        t.observe(e, {
            childList: !0,
            subtree: !0
        })
    }

    // Lazy Load Backgrounds
    function n() {
        var e = $(window).width() + 200,
            t = $(window).height() + 200;
        $(".entry-image[data-image]:not(.lazyloaded)").each(function() {
            var a = $(this),
                n = a[0].getBoundingClientRect();
            n.width > 0 && n.height > 0 && n.top < t && n.bottom > -200 && n.left < e && n.right > -200 && a.css("background-image", 'url("' + a.attr("data-image") + '")').addClass("lazyloaded")
        })
    }

    // --- MAIN DYNAMIC SLIDER LOGIC ---
    // Replaced malicious obfuscated code with standard fetch logic
    (function initMainSlider() {
        let slider = $("#dynamic-main-slider");
        if (!slider.length) return;

        let label = null,
            path = window.location.pathname;
        if (path.startsWith("/search/label/")) {
            label = decodeURIComponent(path.split("/search/label/")[1].replace(/\/$/, ""));
        } else if (path !== "/") {
            // Hide slider if not homepage or label page
            slider.closest(".content-slider").hide();
            return;
        }

        let feedUrl = label ?
            "/feeds/posts/default/-/" + encodeURIComponent(label) + "?alt=json-in-script&max-results=5" :
            "/feeds/posts/default?alt=json-in-script&max-results=5";

        $.ajax({
            url: feedUrl,
            type: "get",
            dataType: "jsonp",
            success: function(data) {
                if (!data.feed || !data.feed.entry || data.feed.entry.length === 0) {
                    slider.closest(".content-slider").hide();
                    return;
                }

                let entries = data.feed.entry;
                let slidesHtml = "";

                // Process each slide
                let processPromises = entries.map((entry, index) => {
                    let link = entry.link.find(l => l.rel === "alternate").href;
                    return $.get(link).then(html => {
                        let doc = $(html);
                        let title = entry.title.$t;
                        let backdrop = doc.find("span.slider-backdrop").text().trim() || doc.find('img[alt="poster"]').attr("src");
                        if (backdrop) backdrop = backdrop.replace(/\/s\d+(-[a-z0-9]+)*\//, "/w1280-h720-c/");
                        
                        // Metadata
                        let meta = {
                            rating: doc.find(".meta-rating").text().trim(),
                            year: doc.find(".meta-year").text().trim(),
                            quality: "HD", 
                            genres: doc.find(".meta-genre").map((i, el) => $(el).text().trim()).get(),
                            desc: doc.find(".post-body p").first().text().trim().substring(0, 150) + "..."
                        };

                        let itemHtml = `
                        <div class="slider-item">
                            <div class="slider-background-image" style="background-image: url('${backdrop}')"></div>
                            <div class="slider-shadow-overlay"></div>
                            <div class="slider-info-container">
                                <h2 class="slider-title-main">${title}</h2>
                                <div class="slider-meta-line">
                                    ${meta.rating ? `<span class="meta-item star">â˜… ${meta.rating}</span>` : ""}
                                    ${meta.year ? `<span class="meta-item">${meta.year}</span>` : ""}
                                    <span class="meta-item quality">HD</span>
                                </div>
                                <div class="slider-meta-line genres">
                                    ${meta.genres.map(g => `<span class="genre-tag">${g}</span>`).join("")}
                                </div>
                                <p class="slider-caption">${meta.desc}</p>
                                <div class="slider-buttons">
                                    <a href="${link}" class="slider-btn play-btn">
                                        <svg viewBox="0 0 60 60" style="width:40px; height:40px;"><circle cx="30" cy="30" r="30" fill="#fff"/><path d="M35 30l-10-6v12l10-6z" fill="#000"/></svg>
                                        Watch Now
                                    </a>
                                </div>
                            </div>
                        </div>`;
                        return itemHtml;
                    });
                });

                $.when.apply($, processPromises).done(function() {
                    let results = Array.prototype.slice.call(arguments);
                    slider.html(results.join(""));
                    
                    slider.owlCarousel({
                        items: 1,
                        loop: true,
                        autoplay: true,
                        autoplayTimeout: 5000,
                        nav: true,
                        dots: true,
                        navText: ['<', '>']
                    });
                });
            },
            error: function() {
                slider.closest(".content-slider").hide();
            }
        });
    })();

    // Initialize Images
    n();
    $(window).on("scroll resize", n);
    movePostPageSidebar();
    initMobileSearch();

    // Favorite Button Logic
    let favKey = "abefilm_favorites";
    let getFavs = () => JSON.parse(localStorage.getItem(favKey) || "[]");
    let saveFavs = e => localStorage.setItem(favKey, JSON.stringify(e));
    let isFav = e => getFavs().includes(String(e));

    function updateFavBtn(e) {
        let t = $(e),
            a = t.attr("data-post-id");
        if (isFav(a)) {
            t.addClass("favorited").attr("title", "Remove from Favorites");
            t.html('<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>Favorited</span>');
        } else {
            t.removeClass("favorited").attr("title", "Add to Favorites");
            t.html('<svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>Favorite</span>');
        }
    }

    $(document).on("click", ".favorite-btn", function(e) {
        e.preventDefault();
        let t = $(this).attr("data-post-id");
        if (!t) return;
        let a = getFavs();
        isFav(t) ? a = a.filter(e => e !== String(t)) : a.unshift(String(t));
        saveFavs(a);
        $('.favorite-btn[data-post-id="' + t + '"]').each(function() {
            updateFavBtn(this)
        });
    });

    // Share Button
    let shareBtn = document.getElementById("dynamic-share-btn");
    if (shareBtn) {
        shareBtn.addEventListener("click", async e => {
            e.preventDefault();
            let a = document.title,
                n = window.location.href;
            if (navigator.share) try {
                await navigator.share({
                    title: a,
                    text: a,
                    url: n
                })
            } catch (i) {
                console.error("Error sharing:", i)
            } else {
                alert("Share URL: " + n);
            }
        });
    }

    // Trailer Modal
    let trailerBtn = document.getElementById("trailer-btn"),
        trailerModal = document.getElementById("trailer-modal");
    if (trailerBtn && trailerModal) {
        let iframe = trailerModal.querySelector("iframe"),
            close = trailerModal.querySelector(".trailer-modal-close"),
            open = () => {
                let e = document.getElementById("source-data-container");
                if (!e) {
                    alert("Trailer data not found.");
                    return
                }
                let n = e.querySelector("#trailer-data");
                if (!n || !n.textContent.trim()) {
                    alert("Trailer not available.");
                    return
                }
                let i = n.textContent.trim();
                i += (i.includes("?") ? "&" : "?") + "autoplay=1", iframe.setAttribute("src", i), trailerModal.classList.add("is-visible")
            },
            closeModal = () => {
                trailerModal.classList.remove("is-visible"), iframe.setAttribute("src", "")
            };
        trailerBtn.addEventListener("click", e => {
            e.preventDefault(), open()
        }), close.addEventListener("click", closeModal), trailerModal.addEventListener("click", e => {
            e.target === trailerModal && closeModal()
        })
    }

    // Theme Settings (Dark Mode / Colors)
    let themeModalBtn = document.getElementById("open-theme-settings-modal"),
        themeOverlay = document.getElementById("theme-settings-overlay"),
        themeClose = document.getElementById("ts-close-btn"),
        lightBtn = document.getElementById("light-mode-btn"),
        darkBtn = document.getElementById("dark-mode-btn");

    if (themeModalBtn && themeOverlay) {
        themeModalBtn.addEventListener("click", e => {
            e.preventDefault(), themeOverlay.style.display = "flex", setTimeout(() => themeOverlay.classList.add("is-visible"), 10)
        });
        let closeTheme = () => {
            themeOverlay.classList.remove("is-visible"), setTimeout(() => themeOverlay.style.display = "none", 200)
        };
        themeClose.addEventListener("click", closeTheme), themeOverlay.addEventListener("click", e => {
            e.target === themeOverlay && closeTheme()
        })
    }

    function setTheme(isDark) {
        document.body.classList.toggle("dark-mode", isDark);
        if(lightBtn) lightBtn.classList.toggle("active", !isDark);
        if(darkBtn) darkBtn.classList.toggle("active", isDark);
        localStorage.setItem("themeMode", isDark ? "dark" : "light");
    }

    if (lightBtn && darkBtn) {
        lightBtn.addEventListener("click", () => setTheme(false));
        darkBtn.addEventListener("click", () => setTheme(true));
        setTheme("dark" === localStorage.getItem("themeMode"));
    }

    // Initialize widgets if WidgetManager exists
    if (typeof _WidgetManager !== "undefined" && _WidgetManager.init) {
        _WidgetManager.init();
    }
});


// ==========================================
// PART 1: Comment Tools & Parsing
// ==========================================
const _cmn = {
    parse: function(e) {
        let t = document.getElementById("cmn-parse-area"),
            n = document.getElementById("cmn-copy-btn");
        if (!t) return;
        let r = e.getAttribute("data-text"),
            a = t.value.trim();
        if (!a) {
            alert("Please enter some text or a URL first.");
            return
        }
        let i = a.replace(/</g, "&lt;").replace(/>/g, "&gt;"),
            l = "";
        switch (r) {
            case "bold": l = "<b>" + i + "</b>"; break;
            case "italic": l = "<i>" + i + "</i>"; break;
            case "quote": l = "[quote]" + i + "[/quote]"; break;
            case "tag": l = "[tag]" + i + "[/tag]"; break;
            case "pre": l = "[pre]" + i + "[/pre]"; break;
            case "code": l = "[code]" + i + "[/code]"; break;
            case "qa":
                let o = i.split(";");
                if (o.length < 2) {
                    alert("Please use the format:\nQuestion; Option 1; Option 2 (optional)");
                    t.value = "Your Question; Option 1; Option 2";
                    return
                }
                l = "[QA]" + o[0].trim() + "[OPT]" + o.slice(1).map(e => e.trim()).join("[OPT]") + "[/QA]";
                break;
            default: l = i
        }
        t.value = l, n && n.classList.remove("hidden")
    },
    copy: function() {
        let e = document.getElementById("cmn-parse-area");
        e && e.value && navigator.clipboard.writeText(e.value).then(() => {
            let e = document.getElementById("cmn-copied-msg");
            e && (e.classList.remove("hidden"), setTimeout(() => {
                e.classList.add("hidden")
            }, 2e3))
        })
    },
    clear: function() {
        let e = document.getElementById("cmn-parse-area"),
            t = document.getElementById("cmn-copy-btn");
        e && (e.value = ""), t && t.classList.add("hidden")
    }
};

function transformCommentTags() {
    document.querySelectorAll(".comment-content:not(.tags-transformed)").forEach(e => {
        let t = e.innerHTML;
        // Transform QA Tags
        if (t.includes("[QA]")) {
            t = t.replace(/\[QA\](.*?)\[OPT\](.*?)\[\/QA\]/g, (t, n, r) => {
                let a = e.closest(".comment"),
                    i = "Join the discussion...",
                    l = "";
                if (a) {
                    l = "qa-source-" + a.id, a.setAttribute("data-qa-id", l);
                    let o = a.querySelector(".comment-replies");
                    if (o) {
                        let s = o.querySelectorAll("li.comment").length;
                        if (s > 0) {
                            let c = s;
                            s >= 1e3 && (c = (s / 1e3).toFixed(1).replace(/\.0$/, "") + "K"), i = c + " replies and discussion"
                        }
                    }
                }
                let d = r.split("[OPT]").map(e => '<span class="qa-option">' + e.trim() + "</span>").join("");
                return '<div class="qa-card" data-qa-id="' + l + '">\n<div class="qa-title">\n<span class="qa-icon">#</span>\n' + n.trim() + '\n</div>\n<div class="qa-options">' + d + '</div>\n<a class="qa-footer" href="javascript:void(0)">\n<svg class="qa-stats-icon" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g><rect x="4" y="10" width="4" height="10" rx="1"></rect><rect x="10" y="4" width="4" height="16" rx="1"></rect><rect x="16" y="6" width="4" height="14" rx="1"></rect></g></svg>\n<span>' + i + '</span>\n<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 4px; font-weight: bold;"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>\n</a>\n</div>'
            })
        }
        
        // Transform Code Blocks and Quotes
        let n = (e, t) => {
            let n = t.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");
            n = n.replace(/<br\s*\/?>/gi, "\n");
            let r = n.replace(/</g, "&lt;").replace(/>/g, "&gt;"),
                a = "copied-msg-" + Math.random().toString(36).substr(2, 9);
            return '\n<div class="comment-code-wrapper">\n<pre><code class="hljs">' + r + '</code></pre>\n<button class="copy-code-btn" title="Copy code" onclick="navigator.clipboard.writeText(this.previousElementSibling.querySelector(\'code\').textContent).then(() => { const msg = document.getElementById(\'' + a + '\'); msg.classList.add(\'show\'); setTimeout(() => msg.classList.remove(\'show\'), 2000); });">\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M16.9637 8.98209C16.9613 6.03194 16.9167 4.50384 16.0578 3.45753C14.4008 1.99854 12.7609 1.99854 9.48087 1.99854C6.20089 1.99854 4.5609 1.99854 3.45708 2.90436C1.99799 4.56128 1.99799 6.20116 1.99799 9.48091C1.99799 12.7607 1.99799 14.4005 2.90387 15.5043C4.50346 16.9162 6.03167 16.9608 8.98201 16.9632" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M14.0283 9.02455L16.994 8.98193M14.0143 22.0013L16.9799 21.9586M21.9716 14.0221L21.9436 16.9818M9.01033 14.0357L8.98236 16.9953M11.4873 9.02455C10.6545 9.17371 9.31781 9.32713 9.01033 11.0488M19.4946 21.9586C20.3296 21.8223 21.6685 21.6894 22.0025 19.9726M19.4946 9.02455C20.3274 9.17371 21.6641 9.32713 21.9716 11.0488M11.5 21.9573C10.6672 21.8086 9.33039 21.6559 9.02197 19.9344" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>\n</button>\n<span class="code-copied-msg" id="' + a + '">Copied!</span>\n</div>'
        };
        t = (t = (t = (t = t.replace(/\[pre\]([\s\S]*?)\[\/pre\]/g, n)).replace(/\[code\]([\s\S]*?)\[\/code\]/g, '<code class="comment-inline-code hljs">$1</code>')).replace(/\[quote\]([\s\S]*?)\[\/quote\]/g, "<blockquote>$1</blockquote>")).replace(/\[tag\]([\s\S]*?)\[\/tag\]/g, '<b class="comment-tag">@$1</b>'), e.innerHTML = t, e.classList.add("tags-transformed"), "undefined" != typeof hljs && e.querySelectorAll("pre code.hljs").forEach(e => {
            hljs.highlightElement(e), "function" == typeof hljs.lineNumbersBlock && hljs.lineNumbersBlock(e)
        })
    })
}

// ==========================================
// PART 2: UI Logic (Mobile, Carousel, etc)
// ==========================================
document.addEventListener("DOMContentLoaded", function() {
    let isMobile = window.innerWidth <= 767,
        postContainer = document.querySelector(".post-page-final-container");
        
    // Mobile View Restructuring
    if (isMobile && postContainer) {
        document.body.classList.add("item-view");
        let recSec = document.querySelector(".recommendation-section"),
            comments = document.querySelector(".abefilm-blog-post-comments"),
            mobTitle = document.querySelector(".mobile-reaction-title"),
            reactCont = document.querySelector(".reaction-container"),
            reviewCont = document.querySelector(".review-system-container"),
            vidTab = document.getElementById("video-tab-content"),
            comTab = document.getElementById("comment-tab-content");
            
        if (recSec && vidTab) vidTab.appendChild(recSec);
        if (comTab) {
            if (mobTitle) comTab.appendChild(mobTitle);
            if (reactCont) comTab.appendChild(reactCont);
            if (reviewCont) comTab.appendChild(reviewCont);
            if (comments) comTab.appendChild(comments);
        }
        
        let tabBtns = document.querySelectorAll(".mobile-tab-btn"),
            tabPanels = document.querySelectorAll(".mobile-tab-panel");
        if (tabBtns.length > 0 && tabPanels.length > 0) {
            tabBtns.forEach(function(btn) {
                btn.addEventListener("click", function() {
                    let targetId = btn.getAttribute("data-tab-target"),
                        target = document.querySelector(targetId);
                    if (target) {
                        tabBtns.forEach(b => b.classList.remove("active"));
                        tabPanels.forEach(p => p.classList.remove("active"));
                        btn.classList.add("active");
                        target.classList.add("active");
                        document.body.classList.toggle("comment-tab-active", "#comment-tab-content" === targetId)
                    }
                })
            })
        }
    }

    // Mobile Comment Form Trigger
    if (isMobile && postContainer) {
        let trigger = document.getElementById("mobile-comment-trigger");
        if (trigger) {
            let discLink = trigger.querySelector(".trigger-discussion-link"),
                rateLink = trigger.querySelector(".trigger-rating-link"),
                closeBtn = document.getElementById("close-comment-form");
            if (discLink && closeBtn) {
                discLink.addEventListener("click", e => {
                    e.preventDefault();
                    document.body.classList.add("comment-form-active")
                });
                closeBtn.addEventListener("click", () => {
                    document.body.classList.remove("comment-form-active")
                })
            }
            if (rateLink) rateLink.addEventListener("click", e => {
                e.preventDefault();
                document.getElementById("review-system")?.scrollIntoView({
                    behavior: "smooth",
                    block: "center"
                })
            })
        }
    }

    // Resize Comment Form on Mobile
    if (isMobile && document.body.classList.contains("item-view")) {
        let pCol = document.querySelector(".player-column-final"),
            cForm = document.querySelector(".comment-form");
        if (pCol && cForm) {
            function adjustHeight() {
                cForm.style.top = pCol.offsetHeight + "px"
            }
            adjustHeight();
            window.addEventListener("resize", adjustHeight)
        }
    }

    // Comment Helper (BBCode Tools)
    let cHelper = document.getElementById("comment-helper"),
        cContainer = document.getElementById("comments");
    if (cHelper && cContainer) {
        let observer = new MutationObserver(list => {
            for (let mutation of list)
                for (let node of mutation.addedNodes)
                    if (1 === node.nodeType && "comment-editor" === node.id) {
                        node.parentNode && node.parentNode.insertBefore(cHelper, node);
                        return
                    }
        });
        observer.observe(cContainer, { childList: true, subtree: true })
    }

    // Sort Comments Logic
    let sortSel = document.getElementById("sort-select"),
        topRa = document.getElementById("top-ra");
    if (sortSel && topRa) sortSel.addEventListener("change", function() {
        topRa.style.flexDirection = "newest" === this.value ? "column-reverse" : "column"
    });

    // Move Comment Form Interval
    let cInt = setInterval(function() {
        let tCe = document.getElementById("top-ce"),
            cForm = document.querySelector(".comments .comment-form");
        if (tCe && cForm) {
            cForm.appendChild(tCe);
            clearInterval(cInt)
        }
    }, 100);
    setTimeout(() => { clearInterval(cInt) }, 1e4);

    transformCommentTags();

    // Cast / Celebrity Data
    if (isMobile && postContainer) {
        let celebData = document.querySelector("#celebrity-data"),
            vidTab = document.getElementById("video-tab-content");
        if (celebData && vidTab) {
            let items = celebData.querySelectorAll("li");
            if (items.length > 0) {
                let div = document.createElement("div");
                div.className = "section-final mobile-celebrity-section";
                div.innerHTML = '<h3>Cast</h3>';
                let carousel = document.createElement("div");
                carousel.className = "celebrity-carousel-mobile";
                items.forEach(item => {
                    let img = item.querySelector("img")?.src || "",
                        name = item.querySelector("span")?.textContent || "";
                    carousel.innerHTML += `<div class="celebrity-item-mobile"><img src="${img}" alt="${name}" loading="lazy"/><span class="name">${name}</span></div>`
                });
                div.appendChild(carousel);
                let rec = vidTab.querySelector(".recommendation-section");
                rec ? vidTab.insertBefore(div, rec) : vidTab.appendChild(div)
            }
        }
    }

    // ==========================================
    // PART 3: Supabase Interactive Features
    // ==========================================
    
    

    let sbUrl = "https://agfwyfwsnqnklgcgemnw.supabase.co";
    if ("undefined" == typeof supabase || !sbUrl.startsWith("http")) {
        console.warn("Supabase client not loaded or configured. Interactive features will be disabled.");
        return
    }
    
    // Initialize Supabase
    let sbClient = supabase.createClient(sbUrl, "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZnd5ZndzbnFua2xnY2dlbW53Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTQ3MTQsImV4cCI6MjA3Mjc5MDcxNH0.NBWiC0YzG8zDhijQ17j49xVXUyLJYXlMJKJkfFJg5yg");

    // --- Rating System ---
    (() => {
        let reviewData = document.getElementById("post-review-data");
        if (!reviewData) return;

        // Create Feedback Popup
        if (!document.getElementById("rating-feedback-popup")) {
            let popup = document.createElement("div");
            popup.id = "rating-feedback-popup";
            popup.className = "rating-feedback-container";
            popup.innerHTML = '<div class="feedback-content"><h3 class="popup-text">You rated</h3><div class="popup-stars" id="popup-stars-content"></div></div>';
            document.body.appendChild(popup);
        }

        let postId = reviewData.getAttribute("data-post-id"),
            storageKey = "sb_rated_" + postId,
            summaryWrapper = document.getElementById("review-summary-wrapper"),
            currentSummary = null,
            clientId = localStorage.getItem("supabase_client_id");

        if (!clientId) {
            clientId = self.crypto.randomUUID();
            localStorage.setItem("supabase_client_id", clientId);
        }

        let formatNum = e => e >= 1e3 ? (e / 1e3).toFixed(e % 1e3 != 0 ? 1 : 0) + "K" : e;

        let updateShortcutText = () => {
            let txt = document.getElementById("rating-shortcut-text");
            if (txt) {
                let rated = null !== localStorage.getItem(storageKey);
                txt.textContent = rated ? "My rating" : "Rate now"
            }
        };

        let renderStars = summary => {
            currentSummary = summary;
            let userRated = localStorage.getItem(storageKey),
                hasRated = null !== userRated,
                counts = {};
            counts["1"] = 0; counts["2"] = 0; counts["3"] = 0; counts["4"] = 0; counts["5"] = 0;
            
            let total = summary?.total_ratings || 0,
                avg = summary?.average_rating || 0,
                dist = summary?.rating_counts || counts,
                starsHtml = "",
                barsHtml = "";

            for (let i = 1; i <= 5; i++) starsHtml += `<span class="star ${i <= Math.round(avg) ? "filled" : ""}" data-value="${i}">&#9733;</span>`;
            
            for (let i = 5; i >= 1; i--) {
                let percent = total > 0 ? (dist[String(i)] || 0) / total * 100 : 0;
                barsHtml += `<div class="breakdown-row"><span>${i}.0</span><div class="progress-bar-container"><div class="progress-bar" style="width:${percent}%;"></div></div><span class="review-count">${dist[String(i)] || 0} reviews</span></div>`;
            }

            summaryWrapper.innerHTML = `<div class="review-summary-left"><div class="average-rating-score">${avg.toFixed(1)}</div><div><div class="average-rating-stars ${hasRated ? "rated" : ""}" id="interactive-stars">${starsHtml}</div><div class="total-ratings">${formatNum(total)} ratings</div></div></div><div class="review-summary-right">${barsHtml}</div>`;
            
            let userDisplay = document.getElementById("user-rating-display-container");
            if (!userDisplay) {
                userDisplay = document.createElement("div");
                userDisplay.id = "user-rating-display-container";
                summaryWrapper.after(userDisplay);
            }

            if (hasRated) {
                let val = parseInt(userRated, 10),
                    uStars = "";
                for (let i = 1; i <= 5; i++) uStars += i <= val ? '<span class="star filled">&#9733;</span>' : '<span class="star">&#9734;</span>';
                userDisplay.innerHTML = `<div class="user-rating-display"><span>You rated:</span><div>${uStars}</div></div>`;
            } else {
                userDisplay.innerHTML = "";
            }
        };

        let fetchRatings = async () => {
            let { data, error } = await sbClient.from("review_summaries").select("*").eq("post_id", postId).single();
            if (error && "PGRST116" !== error.code) console.error("Supabase Error:", error);
            renderStars(data);
            updateShortcutText();
        };

        let showSparkles = val => {
            let popup = document.getElementById("rating-feedback-popup"),
                content = popup.querySelector(".feedback-content"),
                starCont = document.getElementById("popup-stars-content");
            if (popup && starCont) {
                content.querySelectorAll(".sparkle").forEach(e => e.remove());
                starCont.innerHTML = Array.from({ length: 5 }, (t, n) => n < val ? '<span class="star-filled">&#9733;</span>' : '<span class="star-empty">&#9734;</span>').join("");
                
                // Add Sparkle animation
                for (let i = 0; i < 12; i++) {
                    let sp = document.createElement("div");
                    sp.className = "sparkle";
                    let deg = 360 * Math.random(),
                        dist = 80 * Math.random() + 60,
                        x = Math.cos(deg * Math.PI / 180) * dist,
                        y = Math.sin(deg * Math.PI / 180) * dist;
                    sp.style.setProperty("--sparkle-transform-end", `translate(${x}px, ${y}px)`);
                    sp.style.animationDelay = .3 * Math.random() + "s";
                    content.appendChild(sp);
                }
                popup.classList.add("show");
                setTimeout(() => popup.classList.remove("show"), 2500);
            }
        };

        let submitRating = async val => {
            if (null !== localStorage.getItem(storageKey)) return;
            showSparkles(val);
            localStorage.setItem(storageKey, val);
            updateShortcutText();

            // Optimistic Update
            let dummyCounts = {};
            dummyCounts["1"]=0; dummyCounts["2"]=0; dummyCounts["3"]=0; dummyCounts["4"]=0; dummyCounts["5"]=0;
            
            let total = currentSummary?.total_ratings || 0,
                currAvg = currentSummary?.average_rating || 0,
                currCounts = currentSummary?.rating_counts || dummyCounts;
                
            let newTotal = total + 1;
            let newAvg = ((currAvg * total) + val) / newTotal;
            let newCounts = { ...currCounts, [String(val)]: (currCounts[String(val)] || 0) + 1 };
            
            renderStars({
                total_ratings: newTotal,
                average_rating: newAvg,
                rating_counts: newCounts
            });

            let payload = { post_id: postId, rating: val, client_id: clientId };
            let { error } = await sbClient.from("reviews").insert(payload);
            
            if (error) {
                console.error("Error submitting review:", error);
                localStorage.removeItem(storageKey); // Rollback
                fetchRatings();
            }
        };

        summaryWrapper.addEventListener("click", e => {
            let star = e.target.closest(".star"),
                parent = e.target.closest(".average-rating-stars");
            if (star && parent && !parent.classList.contains("rated")) {
                submitRating(parseInt(star.getAttribute("data-value")));
            }
        });

        fetchRatings();
    })();

    // --- Reaction System ---
    (() => {
        let rData = document.getElementById("post-review-data") || document.getElementById("post-id"),
            rContainer = document.getElementById("reaction-container");

        if (!rData || !rContainer) return;

        let postId = rData.getAttribute("data-post-id");
        if (!postId) {
            console.error("Reaction system: Post ID not found.");
            return;
        }

        let storageKey = "sb_reacted_" + postId,
            reactionTypes = [
                { type: "like", label: "Upvote", icon: "ðŸ‘" },
                { type: "love", label: "Love", icon: "ðŸ˜" },
                { type: "haha", label: "Funny", icon: "ðŸ˜†" },
                { type: "wow", label: "Surprised", icon: "ðŸ˜²" },
                { type: "sad", label: "Sad", icon: "ðŸ˜¢" },
                { type: "angry", label: "Angry", icon: "ðŸ˜ " }
            ],
            clientId = localStorage.getItem("supabase_client_id");

        if (!clientId) {
            clientId = self.crypto.randomUUID();
            localStorage.setItem("supabase_client_id", clientId);
        }

        let currentCounts = {}, 
            userReaction = null;

        let renderReactions = (counts, userSelection) => {
            rContainer.innerHTML = reactionTypes.map(rt => {
                let count = counts?.[rt.type] || 0;
                return `<button class="reaction-btn ${userSelection === rt.type ? "selected" : ""}" data-reaction="${rt.type}">
                    <div class="reaction-icon-wrapper">
                        <span class="reaction-icon">${rt.icon}</span>
                        <span class="reaction-count">${count > 0 ? count : ""}</span>
                    </div>
                    <span class="reaction-label">${rt.label}</span>
                </button>`
            }).join("");
        };

        let fetchReactions = async () => {
            try {
                let [summaryRes, userRes] = await Promise.all([
                    sbClient.from("reaction_summaries").select("counts").eq("post_id", postId).single(),
                    sbClient.from("reactions").select("reaction_type").eq("post_id", postId).eq("client_id", clientId).single()
                ]);
                currentCounts = summaryRes.data?.counts || {};
                userReaction = userRes.data?.reaction_type || null;

                if (userReaction) localStorage.setItem(storageKey, userReaction);
                else localStorage.removeItem(storageKey);

                renderReactions(currentCounts, userReaction);
            } catch (err) {
                console.error("Error fetching reaction data:", err);
            }
        };

        let toggleReaction = async type => {
            let prevReaction = userReaction;

            // Optimistic UI Update
            if (prevReaction === type) {
                // Remove reaction
                if (currentCounts[prevReaction]) currentCounts[prevReaction]--;
                userReaction = null;
                localStorage.removeItem(storageKey);
            } else {
                // Switch or Add reaction
                if (prevReaction && currentCounts[prevReaction]) currentCounts[prevReaction]--;
                userReaction = type;
                currentCounts[type] = (currentCounts[type] || 0) + 1;
                localStorage.setItem(storageKey, type);
            }
            renderReactions(currentCounts, userReaction);

            try {
                if (prevReaction === type) {
                    await sbClient.from("reactions").delete().match({ post_id: postId, client_id: clientId });
                } else {
                    await sbClient.from("reactions").upsert({
                        post_id: postId,
                        client_id: clientId,
                        reaction_type: type
                    }, { onConflict: "post_id, client_id" });
                }
            } catch (err) {
                console.error("Error updating reaction:", err);
                await fetchReactions(); // Rollback on error
            }
        };

        rContainer.addEventListener("click", e => {
            let btn = e.target.closest(".reaction-btn");
            if (btn) toggleReaction(btn.dataset.reaction);
        });

        fetchReactions();
    })();
});


// ==========================================
// PART 1: Helper Functions
// ==========================================

// Update the counts on the Account Page badges
function updateAccountPageCounts() {
    if (!document.querySelector(".account-page-container")) return;

    let watchlistCount = (JSON.parse(localStorage.getItem("abefilmUserWatchlist")) || []).length;
    let historyCount = (JSON.parse(localStorage.getItem("watchHistoryIDs")) || []).length;
    let favoritesCount = (JSON.parse(localStorage.getItem("abefilm_favorites")) || []).length;

    let wLabel = document.querySelector('a[href="/p/watchlist.html"] .item-value');
    let hLabel = document.querySelector('a[href="/p/history.html"] .item-value');
    let fLabel = document.querySelector('a[href="/p/favorite.html"] .item-value');

    if (wLabel) {
        if (watchlistCount > 0) {
            wLabel.textContent = watchlistCount;
            wLabel.classList.add("is-badge");
        } else {
            wLabel.textContent = "View";
            wLabel.classList.remove("is-badge");
        }
    }
    if (hLabel) hLabel.textContent = historyCount > 0 ? historyCount : "View";
    if (fLabel) fLabel.textContent = favoritesCount > 0 ? favoritesCount : "View";
}

// ==========================================
// PART 2: Main Application Logic
// ==========================================
document.addEventListener("DOMContentLoaded", function() {

    // --- Mobile Player Resize Logic ---
    if (window.innerWidth <= 767 && document.body.classList.contains("item-view")) {
        let playerCol = document.querySelector(".player-column-final");
        let commentForm = document.querySelector(".comment-form");
        if (playerCol && commentForm) {
            function adjustCommentPos() {
                let h = playerCol.offsetHeight;
                commentForm.style.top = h + "px";
            }
            adjustCommentPos();
            window.addEventListener("resize", adjustCommentPos);
        }
    }

    // --- Toast & Modals System ---
    let modal = document.getElementById("generic-modal");
    let toast = document.getElementById("toastNotification");
    let toastMsg = document.getElementById("toastMessage");
    let toastPending = sessionStorage.getItem("showToastAfterReload");

    // Show pending toast from previous page load (e.g., after login reload)
    if (toastPending) {
        if (toast && toastMsg) {
            toastMsg.textContent = toastPending;
            toast.classList.remove("hidden");
            setTimeout(() => toast.classList.add("show"), 10);
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.classList.add("hidden"), 500);
            }, 3000);
        }
        sessionStorage.removeItem("showToastAfterReload");
    }

    // Generic Modal Logic
    if (modal) {
        let mTitle = document.getElementById("generic-modal-title");
        let mMsg = document.getElementById("generic-modal-message");
        let mInput = document.getElementById("generic-modal-input");
        let mOk = document.getElementById("generic-modal-ok");
        let mCancel = document.getElementById("generic-modal-cancel");
        let callback = null;

        window.hideGenericModal = function() {
            modal.classList.remove("is-visible");
            callback = null;
        };
        window.showCustomConfirm = function(title, msg, cb) {
            mTitle.textContent = title;
            mMsg.textContent = msg;
            mInput.classList.add("is-hidden");
            mCancel.style.display = "inline-block";
            mOk.textContent = "OK";
            callback = cb;
            modal.classList.add("is-visible");
        };
        window.showCustomAlert = function(title, msg) {
            mTitle.textContent = title;
            mMsg.textContent = msg;
            mInput.classList.add("is-hidden");
            mCancel.style.display = "none";
            mOk.textContent = "OK";
            callback = null;
            modal.classList.add("is-visible");
        };
        window.showCustomPrompt = function(title, msg, defaultVal, cb) {
            mTitle.textContent = title;
            mMsg.textContent = msg;
            mInput.value = defaultVal;
            mInput.classList.remove("is-hidden");
            mCancel.style.display = "inline-block";
            mOk.textContent = "Save";
            callback = cb;
            modal.classList.add("is-visible");
            setTimeout(() => mInput.focus(), 100);
        };
        mOk.addEventListener("click", () => {
            if (typeof callback === "function") {
                let val = mInput.value;
                callback(val);
            }
            hideGenericModal();
        });
        mCancel.addEventListener("click", hideGenericModal);
        modal.addEventListener("click", (e) => {
            if (e.target === modal) hideGenericModal();
        });
    }

    // --- User Data Setup ---
    let watchlistContainer = document.getElementById("watchlist-container");
    let historyContainer = document.getElementById("history-container");
    let favoritesContainer = document.getElementById("favorites-container");
    let isAccountPage = window.location.pathname.includes("/p/my-account.html");
    const USER_KEY = "abefilm_simple_user";

    // Icon placeholders
    let themeIconSrc = document.getElementById("theme-icon-source");
    let guestIcon = themeIconSrc ? themeIconSrc.dataset.guestIcon : "";
    let userIcon = themeIconSrc ? themeIconSrc.dataset.userIcon : "";
    let loggedOutIcon = themeIconSrc ? themeIconSrc.dataset.loggedOutIcon : "";

    // --- 1. Watchlist Logic ---
    if (watchlistContainer) {
        const WL_KEY = "abefilmUserWatchlist";
        let grid = watchlistContainer.querySelector("#watchlist-grid");
        let empty = watchlistContainer.querySelector("#watchlist-empty-state");
        let btnEdit = watchlistContainer.querySelector("#edit-watchlist-btn");
        let btnCancel = watchlistContainer.querySelector("#cancel-edit-btn");
        let btnDelete = watchlistContainer.querySelector("#delete-selected-btn");
        let checkAll = watchlistContainer.querySelector("#select-all-checkbox");
        let isEditing = false;
        let selectedItems = new Set();

        async function renderWatchlist() {
            let data = [];
            try { data = JSON.parse(localStorage.getItem(WL_KEY)) || []; } catch (e) {}

            if (data.length === 0) {
                empty.style.display = "flex";
                grid.style.display = "none";
                watchlistContainer.classList.remove("has-content");
                toggleEditMode(false);
                btnEdit.style.display = "none";
            } else {
                empty.style.display = "none";
                watchlistContainer.classList.add("has-content");
                // Render Skeletons
                grid.innerHTML = "";
                let siteName = document.querySelector(".sidebar-logo .logo-text")?.textContent.trim() || "";
                for (let i = 0; i < data.length; i++) {
                    grid.innerHTML += `<div class="skeleton-grid-item"><div class="skeleton-poster">${siteName}</div><div class="skeleton-info"><div class="skeleton-line title"></div><div class="skeleton-line type"></div></div></div>`;
                }
                grid.style.display = "grid";
                btnEdit.style.display = "block";
            }

            // Fetch Data
            let promises = data.map(item => fetch(item.url).then(r => r.ok ? r.text() : null).then(html => {
                if (!html) return item;
                let doc = new DOMParser().parseFromString(html, "text/html");
                let img = doc.querySelector('img[alt="poster"]')?.src;
                let type = doc.querySelector("#extra-meta .meta-type")?.textContent.trim();
                return { ...item, poster: img || item.image, type: type || "Movie" };
            }).catch(() => item));

            let finalData = await Promise.all(promises);

            if (data.length > 0) {
                grid.innerHTML = "";
                finalData.forEach(item => {
                    let div = document.createElement("div");
                    div.className = "watchlist-item grid-item";
                    div.dataset.id = item.id;
                    div.innerHTML = `
                        <a href="${isEditing ? 'javascript:void(0);' : (item.url || '#')}" class="poster-wrapper" title="${item.title}">
                            <img src="${item.poster}" alt="${item.title}" class="poster">
                            <div class="play-icon-overlay"><svg class="play-button" viewBox="0 0 60 60"><g fill="none"><circle fill="var(--keycolor)" cx="30" cy="30" r="30"></circle><path d="M35.75,22.5 L45.14,36.58 C46.06,37.96 45.69,39.83 44.31,40.75 C43.82,41.07 43.24,41.25 42.64,41.25 L23.86,41.25 C22.20,41.25 20.86,39.91 20.86,38.25 C20.86,37.66 21.03,37.08 21.36,36.59 L30.75,22.5 C31.67,21.12 33.54,20.74 34.91,21.66 C35.24,21.88 35.53,22.16 35.75,22.5 Z" fill="#FFFFFF" transform="translate(33.25, 30) rotate(-270) translate(-33.25, -30)"></path></g></svg></div>
                            <div class="selection-overlay"><div class="checkmark"><i class="fas fa-check"></i></div></div>
                        </a>
                        <div class="item-info"><div class="title">${item.title}</div><p class="type">${item.type}</p></div>`;
                    grid.appendChild(div);
                    
                    div.querySelector(".poster-wrapper").addEventListener("click", (e) => {
                        if (isEditing) {
                            e.preventDefault();
                            if (selectedItems.has(item.id)) {
                                selectedItems.delete(item.id);
                                div.classList.remove("selected");
                            } else {
                                selectedItems.add(item.id);
                                div.classList.add("selected");
                            }
                            updateToolbar();
                        }
                    });
                });
                updateToolbar();
            }
        }

        function toggleEditMode(state) {
            isEditing = state !== undefined ? state : !isEditing;
            watchlistContainer.classList.toggle("edit-mode", isEditing);
            selectedItems.clear();
            checkAll.checked = false;
            renderWatchlist();
        }

        function updateToolbar() {
            btnDelete.disabled = selectedItems.size === 0;
            btnDelete.style.opacity = selectedItems.size === 0 ? 0.5 : 1;
            let items = document.querySelectorAll(".watchlist-item");
            checkAll.checked = items.length > 0 && selectedItems.size === items.length;
        }

        btnEdit.addEventListener("click", () => toggleEditMode(true));
        btnCancel.addEventListener("click", () => toggleEditMode(false));
        checkAll.addEventListener("change", () => {
            let checked = checkAll.checked;
            document.querySelectorAll(".watchlist-item").forEach(el => {
                let id = el.dataset.id;
                if (checked && !selectedItems.has(id)) {
                    selectedItems.add(id);
                    el.classList.add("selected");
                } else if (!checked && selectedItems.has(id)) {
                    selectedItems.delete(id);
                    el.classList.remove("selected");
                }
            });
            updateToolbar();
        });

        btnDelete.addEventListener("click", () => {
            if (selectedItems.size !== 0) {
                showCustomConfirm("Delete Items", "Are you sure you want to delete " + selectedItems.size + " selected item(s)?", () => {
                    let oldData = JSON.parse(localStorage.getItem(WL_KEY)) || [];
                    let newData = oldData.filter(x => !selectedItems.has(x.id));
                    localStorage.setItem(WL_KEY, JSON.stringify(newData));
                    if (window.renderWatchlistPanel) window.renderWatchlistPanel();
                    if (window.updateWatchlistBadge) window.updateWatchlistBadge();
                    toggleEditMode(false);
                });
            }
        });

        renderWatchlist();
        window.addEventListener("storage", (e) => { if (e.key === WL_KEY) renderWatchlist(); });
    }

    // --- 2. History Logic ---
    if (historyContainer) {
        const HIST_KEY = "watchHistoryIDs";
        let grid = historyContainer.querySelector("#history-grid");
        let empty = historyContainer.querySelector("#history-empty-state");
        let btnEdit = historyContainer.querySelector("#edit-history-btn");
        let btnCancel = historyContainer.querySelector("#cancel-edit-btn");
        let btnDelete = historyContainer.querySelector("#delete-selected-btn");
        let checkAll = historyContainer.querySelector("#select-all-checkbox");
        let isEditing = false;
        let selectedItems = new Set();

        async function renderHistory() {
            let ids = [];
            try { ids = JSON.parse(localStorage.getItem(HIST_KEY)) || []; } catch (e) {}
            let progressData = JSON.parse(localStorage.getItem("abefilmWatchProgress") || "{}");

            if (ids.length === 0) {
                empty.style.display = "flex";
                grid.style.display = "none";
                historyContainer.classList.remove("has-content");
                toggleHistoryEdit(false);
                btnEdit.style.display = "none";
            } else {
                empty.style.display = "none";
                historyContainer.classList.add("has-content");
                // Skeletons
                grid.innerHTML = "";
                let siteName = document.querySelector(".sidebar-logo .logo-text")?.textContent.trim() || "";
                for (let i = 0; i < ids.length; i++) {
                    grid.innerHTML += `<div class="skeleton-grid-item"><div class="skeleton-poster">${siteName}</div><div class="skeleton-info"><div class="skeleton-line title"></div><div class="skeleton-line type"></div></div></div>`;
                }
                grid.style.display = "grid";
                btnEdit.style.display = "block";
            }

            // Fetch Post Data
            let promises = ids.map(id => fetch("/feeds/posts/default/" + id + "?alt=json").then(r => r.ok ? r.json() : null).then(json => {
                if (!json || !json.entry) return null;
                let entry = json.entry;
                let div = document.createElement("div");
                div.innerHTML = entry.content.$t;
                let backdrop = div.querySelector("span.slider-backdrop")?.textContent.trim();
                let poster = div.querySelector('img[alt="poster"]')?.src;
                let type = div.querySelector("#extra-meta .meta-type")?.textContent.trim();
                
                // Progress Calculation
                let epList = div.querySelector("#episodes-data ul[data-server-name]");
                let totalEp = epList ? epList.querySelectorAll("a").length : 0;
                let watchedEp = progressData["post-" + id] || 0;
                let percent = 0;
                if (totalEp > 1) percent = ((watchedEp + 1) / totalEp) * 100;
                else if (totalEp === 1 || (totalEp === 0 && type !== "TV Series")) percent = 100;

                return {
                    id: id,
                    url: entry.link.find(l => l.rel === "alternate").href,
                    title: entry.title.$t,
                    image: backdrop || poster,
                    type: type || "Movie",
                    progressPercent: percent
                };
            }).catch(() => null));

            let items = (await Promise.all(promises)).filter(Boolean);

            if (items.length > 0) {
                grid.innerHTML = "";
                items.forEach(item => {
                    let div = document.createElement("div");
                    div.className = "history-item grid-item";
                    div.dataset.id = item.id;
                    div.innerHTML = `
                        <a href="${isEditing ? 'javascript:void(0);' : (item.url || '#')}" class="poster-wrapper">
                          <img src="${item.image}" alt="${item.title}" class="poster">
                          <div class="play-icon-overlay"><svg class="play-button" viewBox="0 0 60 60"><g fill="none"><circle fill="var(--keycolor)" cx="30" cy="30" r="30"></circle><path d="M35.75,22.5 L45.14,36.58 C46.06,37.96 45.69,39.83 44.31,40.75 C43.82,41.07 43.24,41.25 42.64,41.25 L23.86,41.25 C22.20,41.25 20.86,39.91 20.86,38.25 C20.86,37.66 21.03,37.08 21.36,36.59 L30.75,22.5 C31.67,21.12 33.54,20.74 34.91,21.66 C35.24,21.88 35.53,22.16 35.75,22.5 Z" fill="#FFFFFF" transform="translate(33.25, 30) rotate(-270) translate(-33.25, -30)"></path></g></svg></div>
                          <div class="selection-overlay"><div class="checkmark"></div></div>
                          <div class="progress-bar-overlay"><div class="progress-bar-fill" style="width: ${item.progressPercent}%;"></div></div>
                        </a>
                        <div class="item-info"><div class="title">${item.title}</div><p class="type">${item.type}</p></div>`;
                    grid.appendChild(div);
                    
                    div.querySelector(".poster-wrapper").addEventListener("click", (e) => {
                        if (isEditing) {
                            e.preventDefault();
                            toggleItemSelection(item.id, div);
                        }
                    });
                });
                updateHistoryToolbar();
            }
        }

        function toggleItemSelection(id, el) {
            if (isEditing) {
                if (selectedItems.has(String(id))) {
                    selectedItems.delete(String(id));
                    el.classList.remove("selected");
                } else {
                    selectedItems.add(String(id));
                    el.classList.add("selected");
                }
                updateHistoryToolbar();
            }
        }

        function toggleHistoryEdit(state) {
            isEditing = state !== undefined ? state : !isEditing;
            historyContainer.classList.toggle("edit-mode", isEditing);
            selectedItems.clear();
            checkAll.checked = false;
            renderHistory();
        }

        function updateHistoryToolbar() {
            btnDelete.disabled = selectedItems.size === 0;
            btnDelete.style.opacity = selectedItems.size === 0 ? 0.5 : 1;
            let items = document.querySelectorAll(".history-item");
            checkAll.checked = items.length > 0 && selectedItems.size === items.length;
        }

        btnEdit.addEventListener("click", () => toggleHistoryEdit(true));
        btnCancel.addEventListener("click", () => toggleHistoryEdit(false));
        checkAll.addEventListener("change", () => {
            let items = document.querySelectorAll(".history-item");
            if (checkAll.checked) {
                items.forEach(el => { if (!el.classList.contains("selected")) toggleItemSelection(el.dataset.id, el); });
            } else {
                items.forEach(el => { if (el.classList.contains("selected")) toggleItemSelection(el.dataset.id, el); });
            }
        });
        btnDelete.addEventListener("click", () => {
            if (selectedItems.size !== 0) {
                showCustomConfirm("Delete History", "Are you sure you want to delete " + selectedItems.size + " selected item(s)?", () => {
                    let oldData = JSON.parse(localStorage.getItem(HIST_KEY)) || [];
                    let newData = oldData.filter(x => !selectedItems.has(String(x)));
                    localStorage.setItem(HIST_KEY, JSON.stringify(newData));
                    if (window.displayHistory) window.displayHistory();
                    if (window.updateHistoryBadge) window.updateHistoryBadge();
                    toggleHistoryEdit(false);
                });
            }
        });

        renderHistory();
        window.addEventListener("storage", (e) => { if (e.key === HIST_KEY) renderHistory(); });
    }

    // --- 3. Favorites Logic ---
    if (favoritesContainer) {
        const FAV_KEY = "abefilm_favorites";
        let list = favoritesContainer.querySelector("#favorites-list");
        let empty = favoritesContainer.querySelector("#favorites-empty-state");
        let btnEdit = favoritesContainer.querySelector("#edit-favorites-btn");
        let btnCancel = favoritesContainer.querySelector("#cancel-edit-btn");
        let btnDelete = favoritesContainer.querySelector("#delete-selected-btn");
        let checkAll = favoritesContainer.querySelector("#select-all-checkbox");
        let isEditing = false;
        let selectedItems = new Set();

        async function renderFavorites() {
            let ids = [];
            try { ids = JSON.parse(localStorage.getItem(FAV_KEY)) || []; } catch (e) {}

            if (ids.length === 0) {
                empty.style.display = "flex";
                list.style.display = "none";
                favoritesContainer.classList.remove("has-content");
                toggleFavEdit(false);
                if (btnEdit) btnEdit.style.display = "none";
            } else {
                empty.style.display = "none";
                favoritesContainer.classList.add("has-content");
                // Skeletons
                list.innerHTML = "";
                for (let i = 0; i < ids.length; i++) {
                    list.innerHTML += `<div class="skeleton-list-item"><div class="skeleton-poster"></div><div class="skeleton-details"><div class="skeleton-line title"></div><div class="skeleton-line meta"></div><div class="skeleton-line text"></div></div></div>`;
                }
                list.style.display = "grid";
                if (btnEdit) btnEdit.style.display = "block";
            }

            let promises = ids.map(id => fetch("/feeds/posts/default/" + id + "?alt=json").then(r => r.ok ? r.json() : null).then(json => {
                if (!json || !json.entry) return null;
                let entry = json.entry;
                let div = document.createElement("div");
                div.innerHTML = entry.content.$t;
                return {
                    id: id,
                    url: entry.link.find(l => l.rel === "alternate").href,
                    title: entry.title.$t,
                    poster: div.querySelector('img[alt="poster"]')?.src,
                    type: div.querySelector("#extra-meta .meta-type")?.textContent.trim(),
                    year: div.querySelector("#extra-meta .meta-year")?.textContent.trim(),
                    rating: div.querySelector("#extra-meta .meta-rating")?.textContent.trim(),
                    synopsis: div.querySelector("#overview-data")?.textContent.trim()
                };
            }).catch(() => null));

            let items = (await Promise.all(promises)).filter(Boolean);

            if (items.length > 0) {
                list.innerHTML = "";
                items.forEach(item => {
                    let div = document.createElement("div");
                    div.className = "favorite-item";
                    div.dataset.id = item.id;
                    div.innerHTML = `
                    <a href="${item.url}" class="item-poster-link"><img src="${item.poster}" alt="${item.title}"></a>
                    <div class="item-details">
                        <div class="title-wrapper">
                            <h3 class="title">${item.title}</h3>
                            <label class="selection-checkbox-wrapper">
                                <input type="checkbox" class="item-checkbox" data-id="${item.id}">
                                <span class="custom-checkbox"></span>
                            </label>
                        </div>
                        <div class="item-meta">
                            ${item.rating ? `<span class="rating"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg> ${item.rating}</span>` : ""}
                            ${item.year ? `<span>${item.year}</span>` : ""}
                            ${item.type ? `<span>${item.type}</span>` : ""}
                        </div>
                        <p class="item-synopsis">${item.synopsis || ""}</p>
                        <div class="item-actions">
                            <a href="${item.url}" class="btn play-btn">Play</a>
                        </div>
                    </div>`;
                    list.appendChild(div);

                    let checkbox = div.querySelector(".item-checkbox");
                    div.addEventListener("click", (e) => {
                        if (isEditing) {
                            if (!e.target.closest("a")) {
                                e.preventDefault();
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event("change"));
                            }
                        } else {
                            if (!e.target.closest("a")) window.location.href = item.url;
                        }
                    });

                    checkbox.addEventListener("change", () => {
                        if (isEditing) {
                            if (checkbox.checked) {
                                selectedItems.add(String(item.id));
                                div.classList.add("selected");
                            } else {
                                selectedItems.delete(String(item.id));
                                div.classList.remove("selected");
                            }
                            updateFavToolbar();
                        }
                    });
                });
                updateFavToolbar();
            }
        }

        function toggleFavEdit(state) {
            isEditing = state !== undefined ? state : !isEditing;
            favoritesContainer.classList.toggle("edit-mode", isEditing);
            if (!isEditing) {
                selectedItems.clear();
                if (checkAll) checkAll.checked = false;
                document.querySelectorAll(".favorite-item.selected").forEach(el => {
                    el.classList.remove("selected");
                    let cb = el.querySelector(".item-checkbox");
                    if (cb) cb.checked = false;
                });
            }
            updateFavToolbar();
        }

        function updateFavToolbar() {
            if (!btnDelete) return;
            btnDelete.disabled = selectedItems.size === 0;
            btnDelete.style.opacity = selectedItems.size === 0 ? 0.5 : 1;
            let items = document.querySelectorAll(".favorite-item");
            if (checkAll) checkAll.checked = items.length > 0 && selectedItems.size === items.length;
        }

        if (btnEdit) btnEdit.addEventListener("click", () => toggleFavEdit(true));
        if (btnCancel) btnCancel.addEventListener("click", () => toggleFavEdit(false));
        if (checkAll) checkAll.addEventListener("change", () => {
            let checked = checkAll.checked;
            document.querySelectorAll(".item-checkbox").forEach(cb => {
                if (cb.checked !== checked) {
                    cb.checked = checked;
                    cb.dispatchEvent(new Event("change"));
                }
            });
        });
        if (btnDelete) btnDelete.addEventListener("click", () => {
            if (selectedItems.size !== 0) {
                showCustomConfirm("Delete Favorites", "Are you sure you want to delete " + selectedItems.size + " selected item(s)?", () => {
                    let oldData = JSON.parse(localStorage.getItem(FAV_KEY)) || [];
                    let newData = oldData.filter(x => !selectedItems.has(String(x)));
                    localStorage.setItem(FAV_KEY, JSON.stringify(newData));
                    toggleFavEdit(false);
                    renderFavorites();
                });
            }
        });

        renderFavorites();
        window.addEventListener("storage", (e) => { if (e.key === FAV_KEY) renderFavorites(); });
    }

    // --- 4. Account Profile Logic ---
    if (isAccountPage) {
        let app = document.getElementById("my-account-app");
        if (app) {
            // Reconstruct HTML for Profile Page
            app.innerHTML = `
            <div class="account-page-container">
                <div class="account-profile-section">
                    <div class="account-profile-avatar-wrapper"><img id="account-page-avatar-img" src="" alt="User Avatar" /></div>
                    <div class="account-profile-info"><h2 id="account-page-name" class="account-profile-name"></h2></div>
                </div>
                <div class="account-list-section" id="account-section-header">
                    <h3 class="section-header">Account</h3>
                    <div class="account-list-item" id="username-list-item">
                        <span class="item-label">Username</span>
                        <a href="javascript:void(0)" class="item-action" id="edit-username-btn"><span id="account-page-username-value" class="item-value"></span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                    <div class="account-list-item" id="avatar-list-item">
                        <span class="item-label">Avatar</span>
                        <a href="javascript:void(0)" class="item-action avatar-action" id="edit-avatar-btn"><div class="item-avatar-preview"><img id="account-page-avatar-preview-img" src="" alt="Current Avatar" /></div><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                </div>
                <div class="account-list-section" id="my-content-section">
                    <h3 class="section-header">My Content</h3>
                    <div class="account-list-item">
                        <div class="item-label-group"><span class="item-label">Watchlist</span><span class="item-count" data-count-for="watchlist"></span></div>
                        <a href="/p/watchlist.html" class="item-action"><span>View All</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                    <div class="account-list-item">
                        <div class="item-label-group"><span class="item-label">Watch History</span><span class="item-count" data-count-for="history"></span></div>
                        <a href="/p/history.html" class="item-action"><span>View All</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                    <div class="account-list-item">
                        <div class="item-label-group"><span class="item-label">Favorite</span><span class="item-count" data-count-for="favorite"></span></div>
                        <a href="/p/favorite.html" class="item-action"><span>View All</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                </div>
                <div class="account-list-section">
                    <h3 class="section-header">Settings & Data</h3>
                    <div class="account-list-item">
                        <span class="item-label">Theme</span>
                        <a href="javascript:void(0)" class="item-action" id="open-theme-settings-modal-mobile"><span class="item-value">Customize</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                    <div class="account-list-item">
                        <span class="item-label">Clear Cache</span>
                        <a href="javascript:void(0)" class="item-action" id="clear-cache-btn"><span class="item-value">Calculating...</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                    <div class="account-list-item" id="logout-list-item">
                        <span class="item-label">Logout</span>
                        <a href="javascript:void(0)" class="item-action" id="account-page-logout-btn"><span class="item-value">Proceed</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg></a>
                    </div>
                </div>
            </div>`;
            app.insertAdjacentHTML("afterend", '<div class="avatar-modal-overlay" id="avatar-modal"><div class="avatar-modal-box"><div class="avatar-modal-header"><h3>Choose Your Avatar</h3><button class="avatar-modal-close" id="avatar-modal-close">&times;</button></div><div class="avatar-category-tabs" id="avatar-category-tabs"></div><div class="avatar-grid" id="avatar-grid"></div></div></div>');

            // Elements references
            let imgMain = document.getElementById("account-page-avatar-img");
            let nameMain = document.getElementById("account-page-name");
            let nameVal = document.getElementById("account-page-username-value");
            let imgPrev = document.getElementById("account-page-avatar-preview-img");
            let btnEditName = document.getElementById("edit-username-btn");
            let btnEditAvatar = document.getElementById("edit-avatar-btn");
            let btnClear = document.getElementById("clear-cache-btn");
            let btnLogout = document.getElementById("account-page-logout-btn");
            let modalAvatar = document.getElementById("avatar-modal");
            let btnCloseAvatar = document.getElementById("avatar-modal-close");
            let tabsContainer = document.getElementById("avatar-category-tabs");
            let gridAvatar = document.getElementById("avatar-grid");

            function loadProfile() {
                let user = JSON.parse(localStorage.getItem(USER_KEY));
                let profileSec = document.querySelector(".account-profile-section");
                
                if (user && user.name) {
                    profileSec.classList.remove("is-logged-out");
                    let avatar = user.isGuest ? guestIcon : (user.avatar || userIcon);
                    imgMain.src = avatar;
                    nameMain.innerHTML = user.name;
                    nameVal.textContent = user.name;
                    imgPrev.src = avatar;
                    
                    document.getElementById("account-section-header").style.display = "block";
                    document.getElementById("my-content-section").style.display = "block";
                    document.getElementById("logout-list-item").style.display = "flex";

                    // Update Cache Size
                    let total = 0;
                    for (let x in localStorage) if (localStorage.hasOwnProperty(x)) total += (localStorage[x].length + x.length) * 2;
                    let sizeStr = total < 1024 ? "0 KB" : (total < 1024 * 1024) ? (total / 1024).toFixed(2) + " KB" : (total / (1024 * 1024)).toFixed(2) + " MB";
                    let cacheLabel = btnClear.querySelector("span");
                    if (cacheLabel) cacheLabel.textContent = sizeStr;

                } else {
                    profileSec.classList.add("is-logged-out");
                    imgMain.src = loggedOutIcon;
                    nameMain.innerHTML = 'Login required';
                    nameVal.textContent = "Not logged in";
                    document.getElementById("account-section-header").style.display = "none";
                    document.getElementById("my-content-section").style.display = "none";
                    document.getElementById("logout-list-item").style.display = "none";
                }
                
                // Update Badge Counts
                let wCount = (JSON.parse(localStorage.getItem("abefilmUserWatchlist")) || []).length;
                let hCount = (JSON.parse(localStorage.getItem("watchHistoryIDs")) || []).length;
                let fCount = (JSON.parse(localStorage.getItem("abefilm_favorites")) || []).length;
                
                document.querySelector('.item-count[data-count-for="watchlist"]').textContent = wCount;
                document.querySelector('.item-count[data-count-for="history"]').textContent = hCount;
                document.querySelector('.item-count[data-count-for="favorite"]').textContent = fCount;
            }

            // Avatar Logic
            function renderAvatars(catIndex, data) {
                gridAvatar.innerHTML = "";
                let cat = data[catIndex];
                if (cat) {
                    cat.avatars.forEach(url => {
                        let div = document.createElement("div");
                        div.className = "avatar-choice";
                        div.innerHTML = `<img src="${url}" alt="Avatar">`;
                        div.addEventListener("click", () => {
                            let user = JSON.parse(localStorage.getItem(USER_KEY));
                            if (user && !user.isGuest) {
                                user.avatar = url;
                                localStorage.setItem(USER_KEY, JSON.stringify(user));
                                sessionStorage.setItem("showToastAfterReload", "Avatar updated.");
                                location.reload();
                            }
                        });
                        gridAvatar.appendChild(div);
                    });
                    document.querySelectorAll(".avatar-category-tab").forEach((t, i) => t.classList.toggle("active", i === catIndex));
                }
            }

            // Interactions
            btnEditName.addEventListener("click", (e) => {
                e.preventDefault();
                let user = JSON.parse(localStorage.getItem(USER_KEY));
                if (user && !user.isGuest) {
                    showCustomPrompt("Edit Username", "Enter new name:", user.name, (val) => {
                        if (val && val.trim()) {
                            user.name = val.trim();
                            localStorage.setItem(USER_KEY, JSON.stringify(user));
                            sessionStorage.setItem("showToastAfterReload", "Username updated.");
                            location.reload();
                        }
                    });
                }
            });

            btnEditAvatar.addEventListener("click", () => {
                let user = JSON.parse(localStorage.getItem(USER_KEY));
                if (user && !user.isGuest) modalAvatar.classList.add("is-visible");
            });
            btnCloseAvatar.addEventListener("click", () => modalAvatar.classList.remove("is-visible"));
            
            btnClear.addEventListener("click", (e) => {
                e.preventDefault();
                showCustomConfirm("Clear Cache", "This will clear history, favorites, and watchlist. Sure?", () => {
                    let keep = [USER_KEY, "sidebarState"];
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        let key = localStorage.key(i);
                        if (!keep.includes(key) && !key.startsWith("slider_cache_")) localStorage.removeItem(key);
                    }
                    sessionStorage.clear();
                    sessionStorage.setItem("showToastAfterReload", "Cache cleared.");
                    location.reload();
                });
            });

            btnLogout.addEventListener("click", (e) => {
                e.preventDefault();
                showCustomConfirm("Logout", "Are you sure?", () => {
                    localStorage.removeItem(USER_KEY);
                    sessionStorage.setItem("showToastAfterReload", "Logged out.");
                    location.reload();
                });
            });

            // Load Avatars from hidden source
            let avatarSource = document.getElementById("avatar-data-source");
            if (avatarSource) {
                let categories = Array.from(avatarSource.children).map(c => ({
                    name: c.dataset.name,
                    avatars: Array.from(c.querySelectorAll("img")).map(img => img.src)
                }));
                tabsContainer.innerHTML = "";
                categories.forEach((cat, idx) => {
                    let btn = document.createElement("button");
                    btn.className = "avatar-category-tab";
                    btn.textContent = cat.name;
                    btn.addEventListener("click", () => renderAvatars(idx, categories));
                    tabsContainer.appendChild(btn);
                });
                if (categories.length > 0) renderAvatars(0, categories);
            }

            loadProfile();
            window.addEventListener("storage", (e) => { if (e.key === USER_KEY) loadProfile(); });
        }
    }

    // --- 5. Login Modal Logic ---
    let loginModal = document.getElementById("loginModalOverlay");
    if (loginModal) {
        let btnDisplayName = document.getElementById("loginWithDisplayNameBtn");
        let btnGuest = document.getElementById("loginAsGuestBtn");
        let inputName = document.getElementById("displayNameInput");
        let closeLogin = document.getElementById("cancelLoginBtn");

        document.addEventListener("click", (e) => {
            if (e.target.id === "showLoginModalBtn" || e.target.closest("#showLoginModalBtn")) {
                e.preventDefault();
                loginModal.classList.remove("hidden");
                if (inputName) inputName.focus();
            }
        });

        if (closeLogin) closeLogin.addEventListener("click", () => loginModal.classList.add("hidden"));
        loginModal.addEventListener("click", (e) => { if (e.target === loginModal) loginModal.classList.add("hidden"); });

        if (btnDisplayName) {
            btnDisplayName.addEventListener("click", () => {
                let name = inputName.value.trim();
                if (name) {
                    localStorage.setItem(USER_KEY, JSON.stringify({ name: name, isGuest: false }));
                    sessionStorage.setItem("showToastAfterReload", "Logged in as " + name);
                    location.reload();
                } else {
                    alert("Please enter a name.");
                }
            });
        }
        if (btnGuest) {
            btnGuest.addEventListener("click", () => {
                localStorage.setItem(USER_KEY, JSON.stringify({ name: "Guest", isGuest: true }));
                sessionStorage.setItem("showToastAfterReload", "Logged in as Guest");
                location.reload();
            });
        }
    }

    // --- 6. Dropdown Panels & Menus ---
    let panels = document.querySelectorAll("[data-panel-target]");
    let notifOverlay = document.getElementById("notification-overlay");
    let timer;

    panels.forEach(trigger => {
        // Desktop Hover
        if (window.innerWidth > 767) {
            trigger.addEventListener("mouseenter", () => {
                clearTimeout(timer);
                let targetID = trigger.getAttribute("data-panel-target");
                let target = document.querySelector(targetID);
                if (target) {
                    document.querySelectorAll(".header-dropdown-panel.is-visible").forEach(p => p.classList.remove("is-visible"));
                    target.classList.add("is-visible");
                    // Update content dynamically
                    if (targetID === "#history-panel" && window.displayHistory) window.displayHistory();
                    if (targetID === "#watchlist-panel" && window.renderWatchlistPanel) window.renderWatchlistPanel();
                }
            });
            trigger.addEventListener("mouseleave", () => {
                let targetID = trigger.getAttribute("data-panel-target");
                let target = document.querySelector(targetID);
                timer = setTimeout(() => { if (target) target.classList.remove("is-visible"); }, 200);
            });
            // Keep panel open when hovering the panel itself
            let targetID = trigger.getAttribute("data-panel-target");
            let target = document.querySelector(targetID);
            if (target) {
                target.addEventListener("mouseenter", () => clearTimeout(timer));
                target.addEventListener("mouseleave", () => target.classList.remove("is-visible"));
            }
        }
        
        // Mobile Click
        trigger.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            let targetID = trigger.getAttribute("data-panel-target");
            let target = document.querySelector(targetID);
            if (!target) return;
            
            let isVisible = target.classList.contains("is-visible");
            document.querySelectorAll(".header-dropdown-panel.is-visible").forEach(p => p.classList.remove("is-visible"));
            if (notifOverlay) notifOverlay.classList.remove("is-visible");
            
            if (!isVisible) {
                target.classList.add("is-visible");
                if (targetID === "#notification-panel" && window.innerWidth <= 767 && notifOverlay) notifOverlay.classList.add("is-visible");
                if (targetID === "#history-panel" && window.displayHistory) window.displayHistory();
                if (targetID === "#watchlist-panel" && window.renderWatchlistPanel) window.renderWatchlistPanel();
            }
        });
    });

    document.addEventListener("click", (e) => {
        if (!e.target.closest("[data-panel-target]") && !e.target.closest(".header-dropdown-panel")) {
            document.querySelectorAll(".header-dropdown-panel.is-visible").forEach(p => p.classList.remove("is-visible"));
            if (notifOverlay) notifOverlay.classList.remove("is-visible");
        }
    });

    updateAccountPageCounts();
});



document.addEventListener("DOMContentLoaded", function() {
    const body = document.body;
    const toggleBtn = document.getElementById("sidebarToggle");

    // Exit if the toggle button doesn't exist on this page
    if (!toggleBtn) return;

    // 1. Check LocalStorage for previous state
    const savedState = localStorage.getItem("sidebarState");
    if (savedState === "collapsed") {
        body.classList.add("sidebar-collapsed");
    }

    // 2. Prevent animation on initial load
    body.classList.add("no-transition");
    setTimeout(() => {
        body.classList.remove("no-transition");
    }, 100);

    // 3. Handle Click Event
    toggleBtn.addEventListener("click", () => {
        body.classList.toggle("sidebar-collapsed");

        // Save new state
        const newState = body.classList.contains("sidebar-collapsed") ? "collapsed" : "expanded";
        localStorage.setItem("sidebarState", newState);

        // 4. Refresh Owl Carousel (Fixes layout glitches when sidebar moves)
        setTimeout(function() {
            if (typeof $ !== "undefined" && $.fn.owlCarousel) {
                $("#dynamic-main-slider, #PopularPosts1 .owl-carousel").trigger("refresh.owl.carousel");
            }
        }, 350);
    });
});

// ==========================================
// PART 1: Post Filter / Switcher Widget
// ==========================================
function fetchAndRenderFilteredSwitch(element, config) {
    const container = element.closest(".widget");
    const switchGrid = element.find(".switch-grid");
    const loadMoreBtn = element.find(".switch-button");

    // Default Configuration
    const validLabels = [
        "Action", "Action & Adventure", "Adventure", "Animation", "Comedy",
        "Crime", "Documentary", "Drama", "Family", "Fantasy", "History",
        "Horror", "Kids", "Music", "Mystery", "Reality", "Romance",
        "Sci-Fi & Fantasy", "Science Fiction", "Thriller", "War", "Western"
    ];
    
    // Parse user labels from config
    const reqLabels = config.label ? config.label.split(",").map(t => t.trim()) : [];
    const maxResults = config.maxResults || 6;
    let posts = [];

    // Error: No labels provided
    if (reqLabels.length === 0) {
        switchGrid.html('<p class="error-msg">Widget Error: Please set at least one label in the shortcode.</p>');
        return;
    }

    // Function to Render the HTML
    function renderPosts() {
        if (posts.length === 0) {
            switchGrid.html("<p class='error-msg'>No posts found for the specified labels.</p>");
            loadMoreBtn.hide();
            return;
        }

        // Shuffle posts (Randomize)
        for (let i = posts.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [posts[i], posts[j]] = [posts[j], posts[i]];
        }

        // Slice to max results
        const displayPosts = posts.slice(0, maxResults);

        // Map data to HTML
        const html = displayPosts.map(post => {
            // Helper for icons (SVGs)
            const iconDuration = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 15C2.14277 15.4274 2.31023 15.8431 2.50062 16.2452M4.12547 18.7463C4.44158 19.1137 4.781 19.4596 5.14137 19.7814M9 22C8.55224 21.8557 8.11701 21.6824 7.69641 21.4822"></path><path d="M12 13.5C12.8284 13.5 13.5 12.8284 13.5 12C13.5 11.1716 12.8284 10.5 12 10.5C11.1716 10.5 10.5 11.1716 10.5 12M12 13.5C11.1716 13.5 10.5 12.8284 10.5 12M12 13.5V16M10.5 12H6"></path><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12"></path></svg>';
            const iconRating = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.03658 10.8665L10.0925 12.9957C10.2364 13.2921 10.6204 13.5764 10.9444 13.6309L12.8582 13.9515C14.082 14.1571 14.37 15.0524 13.4881 15.9355L12.0003 17.4356C11.7483 17.6897 11.6103 18.1796 11.6883 18.5305L12.1142 20.3875C12.4502 21.8574 11.6763 22.426 10.3864 21.6578L8.59263 20.5871C8.26867 20.3935 7.73473 20.3935 7.40476 20.5871L5.61096 21.6578C4.3271 22.426 3.54719 21.8513 3.88315 20.3875L4.3091 18.5305C4.3871 18.1796 4.24911 17.6897 3.99714 17.4356L2.5093 15.9355C1.6334 15.0524 1.91537 14.1571 3.13923 13.9515L5.05302 13.6309C5.37099 13.5764 5.75494 13.2921 5.89893 12.9957L6.95481 10.8665C7.53075 9.71116 8.46665 9.71116 9.03658 10.8665Z"></path><path d="M22 2L14 10M16 2L11 7M20 10L17 13"></path></svg>';
            const iconAudio = '<svg viewBox="0 0 24 24" width="10" height="10"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" fill="currentColor"/></svg>';

            const durationHtml = post.duration ? `<span class="thumb-meta thumb-duration is-visible">${iconDuration}${post.duration}</span>` : '<span class="thumb-meta thumb-duration"></span>';
            const ratingHtml = post.rating ? `<span class="thumb-meta thumb-rating is-visible">${iconRating}${post.rating}</span>` : '<span class="thumb-meta thumb-rating"></span>';
            const typeHtml = post.type ? `<span class="sub-meta-type is-visible">${post.type === "TV Series" ? "TV" : post.type}</span>` : '<span class="sub-meta-type"></span>';
            const yearHtml = post.year ? `<span class="sub-meta-year is-visible">${post.year}</span>` : '<span class="sub-meta-year"></span>';
            const subsHtml = post.subtitles ? `<span class="sub-meta-cc is-visible">${post.subtitles}</span>` : '<span class="sub-meta-cc"></span>';
            const audioHtml = post.audio ? `<span class="sub-meta-mic is-visible">${iconAudio}${post.audio}</span>` : '<span class="sub-meta-mic"></span>';

            return `
            <article class="index-post" data-post-id="${post.id}">
              <a class="entry-image-wrap" href="${post.url}" title="${post.title}">
                <span class="entry-image" data-image="${post.imageUrl}" style="background-image:url('${post.imageUrl}')"></span>
                <span class="entry-label">${post.label}</span>
                <div class="thumb-meta-overlay">${durationHtml}${ratingHtml}</div>
              </a>
              <div class="entry-header">
                <h2 class="entry-title"><a href="${post.url}">${post.title}</a></h2>
                <div class="card-sub-meta">
                  <div class="sub-meta-left">${typeHtml}${yearHtml}</div>
                  <div class="sub-meta-right">${subsHtml}${audioHtml}</div>
                </div>
              </div>
            </article>`;
        }).join("");

        switchGrid.html(html);
        
        // Trigger scroll event for lazy loading images (if used)
        setTimeout(function() {
            if (typeof $ === "function") $(window).trigger("scroll");
        }, 50);
    }

    // Prepare API URL
    const labelPath = reqLabels.map(t => encodeURIComponent(t)).join("/");
    
    // AJAX Request
    $.ajax({
        url: `/feeds/posts/default/-/${labelPath}?alt=json-in-script&max-results=50`,
        type: "get",
        dataType: "jsonp",
        success: function(data) {
            if (!data.feed || !data.feed.entry) {
                renderPosts();
                return;
            }

            // Process Feed Data
            posts = data.feed.entry.map(entry => {
                // Create a temporary div to parse HTML content safely
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = entry.content.$t;
                const $temp = $(tempDiv);

                // Extract Metadata from hidden DOM elements in post content
                const img = $temp.find('img[alt="poster"]');
                const meta = $temp.find("#extra-meta");
                const categories = (entry.category || []).map(c => c.term);
                const matchedLabel = categories.find(c => validLabels.includes(c)) || "";

                return {
                    id: entry.id.$t.split(".post-")[1],
                    title: entry.title.$t,
                    url: (entry.link.find(l => l.rel === "alternate") || {}).href,
                    imageUrl: img.length ? img.attr("src").replace(/\/s\d+(-[a-z0-9]+)*\//, "/w400-h600-c/") : "https://resources.blogblog.com/img/blank.gif",
                    label: matchedLabel,
                    duration: meta.find(".meta-duration").text().trim(),
                    rating: meta.find(".meta-rating").text().trim(),
                    year: meta.find(".meta-year").text().trim(),
                    type: meta.find(".meta-type").text().trim(),
                    subtitles: meta.find(".meta-subtitles").text().trim(),
                    audio: meta.find(".meta-audio").text().trim()
                };
            }).filter(Boolean);

            renderPosts();
            
            // Show button if more posts exist
            if (posts.length > maxResults) {
                loadMoreBtn.show();
            }
        },
        error: function() {
            switchGrid.html("<p class='error-msg'>Failed to load post feed.</p>");
        }
    });

    // Handle "Load More" / Shuffle click
    loadMoreBtn.on("click", renderPosts);
}

// ==========================================
// PART 2: Upcoming Carousel Initialization
// ==========================================
document.addEventListener("DOMContentLoaded", function() {
    function initCarousel() {
        var wrapper = document.querySelector(".upcoming-carousel-wrapper");
        var widgets = document.getElementById("upcoming-carousel-widgets");
        var section = document.querySelector(".upcoming-carousel-section");

        if (!wrapper || !widgets || !section) {
            if (section) section.style.display = "none";
            return;
        }

        wrapper.id = "upcoming-carousel";
        var widgetImages = widgets.querySelectorAll(".widget.Image");

        if (widgetImages.length === 0) {
            section.style.display = "none";
            return;
        }

        var html = "";
        
        // Loop through Blogger Image Widgets
        widgetImages.forEach(function(widget) {
            if (widget.style.display === "none" || widget.classList.contains("hidden")) return;

            var hiddenData = widget.querySelector(".hidden-widget-data");
            if (hiddenData) {
                var title = (hiddenData.querySelector(".data-title") || {}).textContent || "";
                var caption = (hiddenData.querySelector(".data-caption") || {}).textContent || "";
                var link = (widget.querySelector("a") || {}).href || "#";
                var imgSrc = (widget.querySelector("img") || {}).src || "";

                if (imgSrc) {
                    // Regex to parse Caption format: [Type] [Date] Description
                    let match = caption.match(/^\[(TV|Movie)\]\s*\[(.*?)\]\s*(.*)$/s);
                    let typeBadge = "";
                    let dateBadge = "";
                    let desc = caption;

                    if (match) {
                        let type = match[1];
                        let date = match[2].trim();
                        desc = match[3].trim();
                        let typeClass = type.toLowerCase() === "tv" ? "type-tv" : "type-movie";
                        
                        typeBadge = '<span class="upcoming-thumb-type ' + typeClass + '">' + type + '</span>';
                        if (date) {
                            dateBadge = '<span class="upcoming-date">' + date + '</span>';
                        }
                    }

                    html += '<div class="item">';
                    html += '  <a class="upcoming-card" href="' + link + '">';
                    html += '    <div class="upcoming-image">';
                    html +=        typeBadge;
                    html += '      <img alt="' + title + '" src="' + imgSrc.replace(/\/s\d+(-[a-z0-9]+)*\//, "/w200-h300-c/") + '" loading="lazy"/>';
                    html += '    </div>';
                    html += '    <div class="upcoming-content">';
                    html += '      <h4 class="upcoming-title">' + title + '</h4>';
                    html +=        dateBadge;
                    html += '      <p class="upcoming-description">' + desc + '</p>';
                    html += '      <div class="upcoming-button">More Details</div>';
                    html += '    </div>';
                    html += '  </a>';
                    html += '</div>';
                }
            }
        });

        if (html.trim() !== "") {
            wrapper.innerHTML = html;
            
            // Initialize Owl Carousel
            var responsiveSettings = {};
            responsiveSettings["0"] = { autoWidth: true, stagePadding: 20, margin: 12 };
            responsiveSettings["768"] = { items: 2, slideBy: 2 };
            responsiveSettings["1200"] = { items: 3, slideBy: 3 };

            $(wrapper).addClass("owl-carousel owl-theme").owlCarousel({
                loop: false,
                margin: 16,
                nav: true,
                dots: false,
                navText: [
                    '<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 18l-6-6 6-6"/></svg>',
                    '<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 6l6 6-6 6"/></svg>'
                ],
                responsive: responsiveSettings
            });
        } else {
            section.style.display = "none";
        }
    }

    // Initialize only when jQuery and OwlCarousel are ready
    if (window.jQuery && jQuery.fn.owlCarousel) {
        initCarousel();
    } else {
        setTimeout(initCarousel, 500);
    }
});
